# 关键技术决策记录

> 记录项目中的重大技术决策，帮助理解「为什么这样做」。
> 每个决策都是难以更改的，记录下来避免重复讨论。

## 决策索引

| 编号 | 决策 | 日期 | 状态 |
|------|------|------|------|
| KD-001 | Web-First 架构 | 2025 | 生效中 |
| KD-002 | Hooks 组合模式 | 2025 | 生效中 |
| KD-003 | 双轨记忆系统 | 2026-01-07 | 生效中 |
| KD-004 | Azure OpenAI 用于记忆 | 2026-01-08 | 生效中 |
| KD-005 | 虚拟消息调度参数 | 2026-01 | 生效中 |
| KD-006 | VAD 防打断机制 | 2026-01 | 生效中 |
| KD-007 | 向量相似度阈值 0.85 | 2026-01-07 | 生效中 |

---

## KD-001: Web-First 架构

**日期**：2025
**状态**：生效中

### 决策
iOS/Android 使用 WebView 包装 Web 应用，而非原生 UI。

### 原因
1. **开发效率**：一套代码，多端运行
2. **快速迭代**：Web 更新无需发版审核
3. **一致性**：用户体验跨平台一致

### 影响
- 需要维护原生-Web 桥接（Bridge API）
- 部分功能需原生实现（推送、CallKit、权限）
- 性能依赖 WebView 优化

---

## KD-002: Hooks 组合模式

**日期**：2025
**状态**：生效中

### 决策
禁止在 UI 组件中直接调用 Gemini API，必须通过 Hooks 组合层。

### 架构
```
useAICoachSession (顶层组合器)
├── useGeminiLive (连接管理)
├── useVirtualMessages (消息调度)
├── useVoiceActivityDetection (VAD)
├── useToneManager (语气管理)
└── useTaskTimer (计时器)
```

### 原因
1. **关注点分离**：每个 Hook 职责单一
2. **可测试性**：各模块可独立测试
3. **复用性**：Onboarding 和主应用复用同一套逻辑

### 影响
- 新功能必须通过 Hook 封装
- 组件只负责 UI 渲染，不包含业务逻辑

---

## KD-003: 双轨记忆系统

**日期**：2026-01-07
**状态**：生效中

### 决策
实现内部记忆系统（`memory-extractor`），同时保留 Mem0 作为备份。

### 方案对比

| 方案 | 优点 | 缺点 |
|------|------|------|
| 纯内部实现 | 完全控制、数据隐私 | 需自建向量搜索 |
| 纯 Mem0 | 开箱即用 | 依赖第三方、数据外部 |
| **双轨系统** | 灵活、有备份 | 复杂度较高 |

### 原因
1. **数据隐私**：用户记忆是敏感数据
2. **可靠性**：有备份方案，避免单点故障
3. **成本控制**：内部系统更经济

### 相关文件
- `docs/architecture/memory-system.md`
- `supabase/functions/memory-extractor/`

---

## KD-004: Azure OpenAI 用于记忆

**日期**：2026-01-08
**状态**：生效中

### 决策
使用 Azure OpenAI 而非直接 OpenAI API 进行记忆提取和嵌入。

### 模型配置
- **提取模型**：gpt-5.1-chat
- **嵌入模型**：text-embedding-3-large (1536 维)

### 原因
1. **企业级 SLA**：Azure 提供更稳定的服务保障
2. **数据合规**：数据不用于模型训练
3. **网络延迟**：与 Supabase 部署区域接近

---

## KD-005: 虚拟消息调度参数

**日期**：2026-01
**状态**：生效中

### 决策
固定虚拟消息调度参数：
- **初始延迟**：0ms（立即发送开场白）
- **检查间隔**：5 秒
- **冷却时间**：15 秒

### 原因
1. **用户体验**：避免 AI 频繁打扰
2. **自然对话**：模拟真人教练节奏
3. **记忆增强**：在关键时刻（1分钟、2.5分钟、4分钟）注入成功记录

### 相关文件
- `src/hooks/useVirtualMessages.ts`

---

## KD-006: VAD 防打断机制

**日期**：2026-01
**状态**：生效中

### 决策
必须实现语音活动检测（VAD），确保 AI 不会在用户说话时插嘴。

### 实现
使用音频能量阈值检测用户是否在说话，说话时暂停 AI 响应。

### 原因
1. **对话礼仪**：打断用户会破坏体验
2. **信息完整**：让用户完整表达想法
3. **技术可行**：Web Audio API 支持实时分析

### 相关文件
- `src/hooks/useVoiceActivityDetection.ts`

---

## KD-007: 向量相似度阈值 0.85

**日期**：2026-01-07
**状态**：生效中

### 决策
记忆去重的向量相似度阈值设为 0.85。

### 原因
- **> 0.85**：高度相似，很可能是重复记忆
- **< 0.85**：可能有细微差异，保留两条
- 合并时使用 LLM 智能融合内容

### 影响
- 新记忆会与现有记忆比对
- 超过阈值的记忆会触发 LLM 合并
- 保持记忆库精简且信息完整

---

## 决策模板

复制以下模板创建新决策：

```markdown
## KD-XXX: [决策标题]

**日期**：YYYY-MM-DD
**状态**：生效中 / 已废弃 / 评估中

### 决策
简述做出的决策。

### 原因
1. 原因 1
2. 原因 2

### 影响
- 影响 1
- 影响 2

### 相关文件
- path/to/file
```
