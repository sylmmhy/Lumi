# 篝火陪伴模式 PRD

> 文档版本: 1.1
> 创建日期: 2026-01-27
> 更新日期: 2026-01-27
> 状态: 方案设计中

---

## 目录

1. [背景与问题](#1-背景与问题)
2. [解决方案概述](#2-解决方案概述)
3. [用户体验设计](#3-用户体验设计)
4. [技术原理（通俗版）](#4-技术原理通俗版)
5. [实现优先级](#5-实现优先级)
6. [技术实现步骤](#6-技术实现步骤)
7. [风险与应对](#7-风险与应对)

---

## 1. 背景与问题

### 1.1 当前痛点

**痛点 1：用户反馈"AI 只陪 5 分钟不够"**

Gemini Live（我们用的 AI 语音对话服务）有硬性限制：

| 会话类型 | 时长限制 | 来源 |
|---------|---------|------|
| 纯语音对话 | **15 分钟** | Google 官方文档 |
| 语音+视频 | **2 分钟** | Google 官方文档 |

超过时限后，连接会自动断开，用户会感觉"AI 突然消失了"。

**痛点 2：Token 浪费严重**

当前 AI 连接会一直保持到超时，即使用户在安静工作：
- 用户安静工作 10 分钟 = AI 连接 10 分钟 = **付费 10 分钟**
- 实际需要 AI 回应的时间可能只有 1 分钟

**痛点 3：虚拟消息有时会打扰用户**

当前虚拟消息系统每 5 秒检查一次是否该让 AI 主动说话，但有些用户想专心工作时会被打扰：
- 用户说"我要专心干活了"，但 AI 还是会主动问候
- 没有"安静陪伴"的模式

### 1.2 用户真正需要什么？

通过用户调研发现，用户要的不是"AI 一直在说话"，而是：

> **"有人陪着我"的感觉**

就像在咖啡厅工作，旁边有朋友在——不一定一直聊天，但**知道他在**就很安心。

### 1.3 设计目标

| 目标 | 衡量标准 |
|------|---------|
| 延长陪伴时长 | 从 15 分钟 → **无限时** |
| 保持陪伴感 | 用户感知不到 AI 断开 |
| 保持上下文 | AI 重新说话时，还记得之前聊了什么 |

---

## 2. 解决方案概述

### 2.1 核心理念：「篝火陪伴」

想象你和朋友在野外露营，围着篝火：

- 篝火一直在燃烧（**背景音 + 动画**）
- 朋友有时聊天，有时安静（**AI 可以断开，但氛围不断**）
- 你说话时，朋友立刻回应（**用户开口，AI 秒级唤醒**）

**用户感知**：AI 一直在陪我，只是有时候安静地陪着。

### 2.2 两个核心功能

本方案包含两个互补的功能：

| 功能 | 触发条件 | 效果 |
|------|---------|------|
| **智能空闲断开** | 用户 5 分钟没说话 | 后台静默断开 AI 连接，省 Token |
| **静默模式** | 用户说"别说话/我要专心了" | AI 停止主动说话，安静陪伴 |

**组合效果**：
1. 用户说"我要专心了" → AI 回应后进入静默模式（不主动说话）
2. 用户继续安静工作 5 分钟 → 自动断开连接（省 Token）
3. 用户突然想聊 → 自动重连 + 解除静默模式

### 2.3 方案示意图

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│    ┌─────────────────────────────────────────────────────┐     │
│    │                                                     │     │
│    │     🔥  篝火动画 + 噼里啪啦的声音                    │     │
│    │                                                     │     │
│    │         （这一层始终运行，永不中断）                  │     │
│    │                                                     │     │
│    └─────────────────────────────────────────────────────┘     │
│                              │                                  │
│                              │                                  │
│    ┌─────────────────────────┼─────────────────────────┐       │
│    │                         │                         │       │
│    │   🤖 AI 连接            │     😴 AI 待机          │       │
│    │   （活跃对话中）         │   （静默陪伴中）         │       │
│    │                         │                         │       │
│    │   15分钟后自动 ─────────┼───────→                  │       │
│    │                         │                         │       │
│    │              ←──────────┼─────── 用户说话时唤醒    │       │
│    │                         │                         │       │
│    └─────────────────────────┴─────────────────────────┘       │
│                                                                 │
│                    用户完全感知不到这个切换                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 用户体验设计

### 3.1 完整用户旅程

```
时间    0分钟        5分钟        15分钟       20分钟       45分钟
        │            │            │            │            │
        ▼            ▼            ▼            ▼            ▼
────────────────────────────────────────────────────────────────────
篝火    🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
声音    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
────────────────────────────────────────────────────────────────────

        │            │            │            │
        ▼            ▼            ▼            ▼
用户    开始工作      和AI聊了几句   专心工作中     突然想说话

        │            │            │            │
        ▼            ▼            ▼            ▼
AI状态  [==连接中===] [==连接中===] [静默断开]    [秒级重连]
                                   用户不知道     用户不知道

        │            │            │            │
        ▼            ▼            ▼            ▼
用户    "开始专注吧"  "有点累了"    （安静工作）   "我刚才..."
感受    AI回应       AI回应                      AI立刻回应！
                                                还记得之前聊的
```

### 3.2 三种状态的用户感知

#### 状态 A：活跃对话（0-15 分钟）

| 要素 | 表现 |
|------|------|
| 篝火动画 | 火焰明亮、活泼跳动 |
| 背景音 | 篝火噼啪声（中等音量）|
| AI 行为 | 主动说话、回应用户 |
| 用户感知 | **"AI 在积极陪我"** |

#### 状态 B：静默陪伴（15 分钟后）

| 要素 | 表现 |
|------|------|
| 篝火动画 | 火焰轻轻摇曳、更温柔 |
| 背景音 | 篝火噼啪声（稍低音量）|
| AI 行为 | 安静等待（实际已断开）|
| 用户感知 | **"AI 在安静陪我工作"** |

**关键设计**：
- ❌ 不显示"AI 已断开"
- ❌ 不显示"重新连接中"
- ✅ 篝火声音持续播放
- ✅ 界面保持"陪伴中"的温暖感

#### 状态 C：唤醒响应（用户说话时）

| 要素 | 表现 |
|------|------|
| 篝火动画 | 火焰短暂变亮（像被风吹了一下）|
| 背景音 | 继续播放（无中断）|
| AI 行为 | 1-2 秒内开始响应 |
| 用户感知 | **"AI 一直在听，马上回应我"** |

### 3.3 静默模式（用户主动请求安静）

**用户体验流程**：

```
用户："好了，我要专心干活了，你先别说话"
    ↓
AI："好的，我安静陪着你。需要我的时候随时叫我~"
    ↓
【进入静默模式】← AI 不再主动说话
    ↓
虚拟消息系统暂停（不再触发 AI 主动问候）
    ↓
用户主动开口
    ↓
AI 正常回应（静默模式自动解除）
```

**触发静默模式的话语示例**：
- "别说话了" / "Don't talk"
- "你不要说话" / "Be quiet"
- "我要专心工作了" / "I need to focus"
- "安静一下" / "让我静静"

**关键设计**：
- AI 用温暖简短的话回应（不是冷冰冰的"好的"）
- 用户说任何话都会自动解除静默模式
- 不需要用户说"你可以说话了"这种刻意的指令

### 3.4 上下文连续性设计

**场景示例**：

```
【15分钟前】
用户："我今天要写完这个报告，但是有点不想动"
AI："理解，写报告确实需要很多精力。要不我们先把它拆成小块？"
用户："好主意"

【此时 AI 静默断开，用户继续工作】

【30分钟后，用户说话】
用户："写了一半了，但是卡住了"
AI："太棒了，已经写了一半！刚才我们说把报告拆成小块，
     现在卡住的是哪个部分？我们一起看看怎么突破。"

         ↑
         AI 记得之前的对话，自然地延续
```

**实现原理**（后面会详细解释）：
- 本地保存这次工作会话的对话记录
- 用户说话时，把对话记录告诉 AI
- AI 就能"记得"之前聊了什么

---

## 4. 技术原理（通俗版）

### 4.1 为什么可以做到"无限陪伴"？

**传统做法的问题**：

```
用户 ←────实时连接────→ AI 服务器
              │
              │ 15分钟后
              ▼
           连接断开
           用户看到错误
```

**我们的做法**：

```
用户 ←────实时连接────→ AI 服务器
  │                        │
  │                        │ 15分钟后静默断开
  │                        ▼
  │                     （无连接）
  │
  └────→ 篝火音效 + 动画 ←──── 这些在用户手机上播放
         （不需要服务器）        永远不会断
```

**关键洞察**：
- 篝火声音和动画 = 在用户手机上本地播放
- AI 服务器连接 = 只在说话时才需要
- 分开这两层，就能实现"无限陪伴"

### 4.2 用户说话时如何快速唤醒？

```
用户手机始终在做一件事：
┌─────────────────────────────────┐
│   🎤 监听是否有人说话            │
│   （这个叫 VAD：语音活动检测）    │
└─────────────────────────────────┘
              │
              │ 检测到用户开口
              ▼
┌─────────────────────────────────┐
│   📡 立即发起 AI 连接            │
│   同时把之前的对话告诉 AI         │
└─────────────────────────────────┘
              │
              │ 1-2 秒
              ▼
┌─────────────────────────────────┐
│   🤖 AI 开始响应                 │
│   （知道之前聊了什么）            │
└─────────────────────────────────┘
```

### 4.3 AI 如何"记得"之前的对话？

**方法：给 AI 一个"小抄"**

每次重新连接 AI 时，我们偷偷塞给它一张纸条：

```
┌─────────────────────────────────────────────────────┐
│  📝 给 AI 的小抄                                     │
│                                                     │
│  【用户的长期记忆】                                   │
│  - 这个用户容易因为任务太大而拖延                     │
│  - 他喜欢把任务拆小                                   │
│  - 今天的任务是写报告                                │
│                                                     │
│  【刚才的对话】                                       │
│  用户：我今天要写完这个报告，但是有点不想动            │
│  你：理解，要不我们先把它拆成小块？                    │
│  用户：好主意                                        │
│  （然后用户安静工作了 15 分钟）                       │
│                                                     │
│  【现在】                                            │
│  用户刚刚说："写了一半了，但是卡住了"                 │
│  请自然地回应，就像对话从未中断一样。                  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

AI 拿到这个"小抄"，就能：
- 知道用户是谁、有什么特点
- 知道刚才聊了什么
- 自然地继续对话

### 4.4 为什么用户感知不到切换？

**人类感知的特点**：

| 感知通道 | 中断容忍度 | 我们的设计 |
|---------|-----------|-----------|
| 听觉（环境音）| 非常敏感，0.1 秒中断就能察觉 | ✅ 篝火声永不中断 |
| 视觉（动画）| 较敏感，0.5 秒变化会注意到 | ✅ 动画平滑过渡 |
| 对话响应 | 相对宽容，2-3 秒内都可接受 | ✅ 重连在 1-2 秒内完成 |

**设计原则**：
- 最敏感的（声音）→ 永不中断
- 其次敏感的（动画）→ 平滑过渡
- 最宽容的（对话）→ 在用户能接受的时间内恢复

---

## 5. 实现优先级

### Phase 1A：静默模式（最先实现）

**目标**：用户说"别说话"时，AI 停止主动打扰

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 静默模式触发 | AI 识别用户想安静的意图 | P0 |
| 虚拟消息暂停 | 静默模式下停止定时消息 | P0 |
| 自动解除 | 用户说话时恢复正常 | P0 |

**验收标准**：
- [ ] 用户说"别说话"等相关话语后，AI 进入静默模式
- [ ] 静默模式下虚拟消息停止发送
- [ ] 用户主动说话后自动恢复正常模式
- [ ] AI 的静默回应自然友好（不是冷冰冰的）

**为什么先做这个**：
- 实现简单，改动小
- 立即改善用户体验
- 为智能空闲断开做铺垫

### Phase 1B：智能空闲断开

**目标**：省 Token，用户安静时自动断开连接

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 空闲检测 | 5 分钟没说话触发断开 | P0 |
| 静默断开 | 断开时不显示任何提示 | P0 |
| 快速重连 | 用户说话时 2 秒内重连 | P0 |

**验收标准**：
- [ ] 用户安静 5 分钟后，AI 连接自动断开
- [ ] 断开时界面无任何变化（篝火音效继续）
- [ ] 用户说话后 2 秒内 AI 能响应
- [ ] AI 重连后能引用之前的对话内容

### Phase 2：上下文连续（体验提升）

**目标**：AI 记得之前的对话

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 会话历史保存 | 本地存储这次对话 | P1 |
| 上下文注入 | 重连时告诉 AI 之前聊了什么 | P1 |
| 自然衔接 | AI 回应时不说"欢迎回来" | P1 |

**验收标准**：
- 断开 30 分钟后重新对话，AI 能引用之前的内容
- 对话自然流畅，像从未中断

### Phase 3：氛围增强（情感体验）

**目标**：更有"陪伴感"的细节

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 篝火动画 | 温暖的火焰效果 | P2 |
| 状态变化 | 活跃/静默时火焰不同 | P2 |
| 呼吸灯效果 | 表示"AI 在这里" | P2 |
| 多种环境音 | 雨声、咖啡厅等可选 | P2 |

---

## 6. 技术实现步骤

### Phase 1A：静默模式实现

#### 步骤 1：System Prompt 添加触发词

**文件**：`supabase/functions/get-system-instruction/index.ts`

在 `[RESIST]` 标记说明之后，添加 `[SILENT_MODE]` 的定义：

```
------------------------------------------------------------
SILENT MODE (User Requests Quiet Companionship)
------------------------------------------------------------
When the user EXPLICITLY asks you to be quiet or stop talking, enter SILENT MODE.

WHAT TRIGGERS SILENT MODE:
- "别说话了" / "Don't talk" / "Stop talking"
- "你不要说话" / "Be quiet"
- "我要专心工作了" / "I need to focus"
- "安静一下" / "让我静静"

HOW TO RESPOND:
1. Start your response with "[SILENT_MODE]" marker
2. Give a warm, brief acknowledgment (5-10 seconds max)

EXAMPLES:
User: "好了，我要专心干活了，你先别说话"
→ "[SILENT_MODE] 好的，我安静陪着你。需要我的时候随时叫我~"

User: "Okay I need to focus now, please be quiet"
→ "[SILENT_MODE] Got it! I'll be right here when you need me."
```

#### 步骤 2：前端检测 [SILENT_MODE] 标记

**文件**：`src/hooks/useAICoachSession.ts`

1. 添加状态：`const [isSilentMode, setIsSilentMode] = useState(false)`

2. 在 `onTranscriptUpdate` 回调中，检测 AI 回复是否以 `[SILENT_MODE]` 开头：
   - 如果是，`setIsSilentMode(true)` + 移除标记后显示
   - 同时记录日志：`console.log('🤫 进入静默模式')`

3. 当用户再次说话时（检测到 `lastMessage.role === 'user'`），自动解除：
   - `setIsSilentMode(false)`
   - 记录日志：`console.log('🔊 退出静默模式')`

#### 步骤 3：虚拟消息支持静默模式

**文件**：`src/hooks/useVirtualMessages.ts`

1. 添加参数：`silentMode?: boolean`

2. 在 `isUserInConversation()` 开头添加检查：
   ```ts
   if (silentModeRef.current) {
     console.log('🤫 静默模式 - 跳过虚拟消息');
     return true;  // 返回 true 表示不发送
   }
   ```

3. 在 `useAICoachSession.ts` 中传递 `silentMode: isSilentMode`

#### 步骤 4：暴露状态给 UI（可选）

在 `useAICoachSession` 的返回值中添加 `isSilentMode`，方便 UI 显示状态。

---

### Phase 1B：智能空闲断开实现（待详细设计）

> 此部分在 Phase 1A 完成后再详细设计

**核心思路**：
1. 在 `useAICoachSession` 中监听 `vad.lastSpeakingTime`
2. 如果超过 5 分钟没有用户语音，调用 `geminiLive.disconnect()`
3. 保留 `isSessionActive = true`（界面不变）
4. 当 VAD 检测到用户说话时，自动重连并注入对话历史

**需要注意的问题**：
- 重连时的延迟控制（<2秒）
- 对话历史的格式化（给 AI 的"小抄"）
- 重连失败的处理

---

## 7. 风险与应对

### 7.1 技术风险

| 风险 | 可能性 | 影响 | 应对方案 |
|------|--------|------|---------|
| 重连太慢（>3秒）| 中 | 用户感知到延迟 | 预热连接、优化握手 |
| iOS 后台音频中断 | 高 | 篝火声突然停止 | 使用后台音频权限 |
| VAD 误触发 | 低 | 不该重连时重连 | 调整灵敏度阈值 |

### 7.2 产品风险

| 风险 | 可能性 | 影响 | 应对方案 |
|------|--------|------|---------|
| 用户觉得"假" | 低 | 信任度下降 | 不欺骗，只是不打扰 |
| 上下文丢失 | 中 | AI 回应不连贯 | 本地+云端双重保存 |
| 流量消耗 | 低 | 用户投诉 | 重连时才消耗流量 |
| 误判静默意图 | 低 | 该安静时说话 | AI 只在明确表达时触发 |

### 7.3 成本考量

| 项目 | 当前成本 | 新方案成本 | 变化 |
|------|---------|-----------|------|
| AI API 调用 | 按分钟计费 | 按实际对话计费 | ⬇️ 可能降低 |
| 服务器资源 | 持续连接 | 按需连接 | ⬇️ 明显降低 |
| 用户手机电量 | 正常 | 略增（VAD 监听）| ⬆️ 略微增加 |

**结论**：总体成本可能反而降低，因为不需要维持持续连接。

---

## 附录：参考资料

### Gemini Live 官方文档

- [Session management with Live API](https://ai.google.dev/gemini-api/docs/live-session)
- 会话限制：音频 15 分钟，音视频 2 分钟
- 支持 Session Resume 功能恢复上下文

### 相关功能文档

- [记忆系统升级方案](./tolan-memory-system-upgrade.md) - 提供长期用户记忆
- [记忆系统架构](./memory-system.md) - 记忆标签分类说明

---

*文档结束*
