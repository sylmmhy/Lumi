# Supabase æœ¬åœ°å¼€å‘ç¯å¢ƒ

> æœ€åæ›´æ–°ï¼š2026-01-16

æœ¬æ–‡æ¡£æè¿°å¦‚ä½•è®¾ç½®å’Œç®¡ç†æœ¬åœ° Supabase å¼€å‘ç¯å¢ƒï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ç®¡ç†ã€åŒæ­¥éƒ¨ç½²ç­‰å®Œæ•´å·¥ä½œæµç¨‹ã€‚

---

## ğŸ“‹ æ¦‚è¿°

ä¸ºäº†**å®‰å…¨åœ°å¼€å‘å’Œæµ‹è¯•åç«¯æ”¹åŠ¨**ï¼Œé¡¹ç›®ä½¿ç”¨æœ¬åœ° Supabase ç¯å¢ƒã€‚è¿™æ ·å¯ä»¥ï¼š

- âœ… é¿å…è¯¯æ“ä½œç”Ÿäº§æ•°æ®åº“
- âœ… å¿«é€Ÿè¿­ä»£å’Œæµ‹è¯•
- âœ… ç±»ä¼¼ Git çš„ç‰ˆæœ¬ç®¡ç†
- âœ… ä¸€é”®åŒæ­¥åˆ°è¿œç«¯

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

1. **Docker Desktop** - æœ¬åœ° Supabase ä¾èµ– Docker
   - macOS: https://www.docker.com/products/docker-desktop/
   - ç¡®ä¿ Docker æ­£åœ¨è¿è¡Œ

2. **Supabase CLI** - å®‰è£…æ–¹æ³•ï¼š
   ```bash
   # macOS
   brew install supabase/tap/supabase

   # æˆ–ä½¿ç”¨ npm
   npm install -g supabase
   ```

3. **ç™»å½• Supabase**ï¼ˆç”¨äºåŒæ­¥è¿œç«¯ï¼‰ï¼š
   ```bash
   supabase login
   supabase link --project-ref <ä½ çš„é¡¹ç›®ID>
   ```

### é¦–æ¬¡å¯åŠ¨

```bash
# 1. å¯åŠ¨æœ¬åœ° Supabaseï¼ˆé¦–æ¬¡éœ€è¦ä¸‹è½½é•œåƒï¼Œçº¦ 2-5 åˆ†é’Ÿï¼‰
npm run supabase:start

# 2. å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆè‡ªåŠ¨è¿æ¥æœ¬åœ° Supabaseï¼‰
npm run dev:local

# 3. è®¿é—® http://localhost:5173
```

---

## ğŸ“– å‘½ä»¤é€ŸæŸ¥è¡¨

### åŸºç¡€å‘½ä»¤

| å‘½ä»¤ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `npm run supabase:start` | å¯åŠ¨æœ¬åœ°æœåŠ¡ | å¼€å§‹å¼€å‘æ—¶æ‰§è¡Œ |
| `npm run supabase:stop` | åœæ­¢æœ¬åœ°æœåŠ¡ | ç»“æŸå¼€å‘æ—¶æ‰§è¡Œï¼Œæ•°æ®ä¼šä¿ç•™ |
| `npm run supabase:status` | æŸ¥çœ‹æœåŠ¡çŠ¶æ€ | æ£€æŸ¥æ˜¯å¦æ­£å¸¸è¿è¡Œ |

### å¼€å‘å‘½ä»¤

| å‘½ä»¤ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `npm run dev:local` | æœ¬åœ°å¼€å‘ | å‰ç«¯è¿æ¥æœ¬åœ° Supabase |
| `npm run dev:remote` | è¿æ¥è¿œç«¯ | å‰ç«¯è¿æ¥ç”Ÿäº§ Supabaseï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ |
| `npm run use:local` | åˆ‡æ¢åˆ°æœ¬åœ°é…ç½® | åªåˆ‡æ¢ç¯å¢ƒå˜é‡ï¼Œä¸å¯åŠ¨æœåŠ¡ |
| `npm run use:remote` | åˆ‡æ¢åˆ°è¿œç«¯é…ç½® | åªåˆ‡æ¢ç¯å¢ƒå˜é‡ï¼Œä¸å¯åŠ¨æœåŠ¡ |

### åŒæ­¥éƒ¨ç½²å‘½ä»¤

| å‘½ä»¤ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| **`npm run supabase:sync`** | **ä¸€é”®åŒæ­¥å…¨éƒ¨** | æ¨é€è¿ç§» + éƒ¨ç½²å‡½æ•° |
| `npm run supabase:push` | åªæ¨é€æ•°æ®åº“è¿ç§» | åªæ”¹äº† SQL æ—¶ä½¿ç”¨ |
| `npm run supabase:deploy` | åªéƒ¨ç½² Edge Functions | åªæ”¹äº†å‡½æ•°æ—¶ä½¿ç”¨ |

### ç‰ˆæœ¬ç®¡ç†å‘½ä»¤ï¼ˆç±»ä¼¼ Gitï¼‰

| å‘½ä»¤ | ç”¨é€” | ç±»ä¼¼ Git |
|------|------|---------|
| `npm run supabase:snapshot "æè¿°"` | åˆ›å»ºå¿«ç…§å¤‡ä»½ | `git commit` |
| `npm run supabase:snapshots` | åˆ—å‡ºæ‰€æœ‰å¿«ç…§ | `git log` |
| `npm run supabase:restore <åç§°>` | æ¢å¤åˆ°æŒ‡å®šå¿«ç…§ | `git checkout` |
| `npm run supabase:pull` | ä»è¿œç¨‹æ‹‰å– schema | `git pull` |
| `npm run supabase:reset` | é‡ç½®åˆ°åˆå§‹çŠ¶æ€ | `git reset --hard` |
| `npm run supabase:verify` | éªŒè¯æœ¬åœ°ç¯å¢ƒ | å¥åº·æ£€æŸ¥ |

---

## ğŸ”„ æ—¥å¸¸å¼€å‘æµç¨‹

### å®Œæ•´å·¥ä½œæµ

```bash
# ============================================
# ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨æœ¬åœ° Supabase
# ============================================
npm run supabase:start
# ç­‰å¾…æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆï¼ˆçº¦ 30 ç§’ï¼‰

# ============================================
# ç¬¬äºŒæ­¥ï¼šå¯åŠ¨å‰ç«¯å¼€å‘
# ============================================
npm run dev:local
# è®¿é—® http://localhost:5173

# ============================================
# ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹ä¿®æ”¹å‰ï¼Œåˆ›å»ºå¿«ç…§å¤‡ä»½
# ============================================
npm run supabase:snapshot "å¼€å§‹æ”¹ç”¨æˆ·è¡¨"

# ============================================
# ç¬¬å››æ­¥ï¼šè¿›è¡Œåç«¯ä¿®æ”¹
# ============================================
# - ä¿®æ”¹æ•°æ®åº“ï¼šç¼–è¾‘ supabase/migrations/ ä¸­çš„ SQL æ–‡ä»¶
# - ä¿®æ”¹å‡½æ•°ï¼šç¼–è¾‘ supabase/functions/ ä¸­çš„ TypeScript æ–‡ä»¶
# - åœ¨æœ¬åœ°æµ‹è¯•éªŒè¯...

# ============================================
# ç¬¬äº”æ­¥ï¼šæµ‹è¯•å®Œæˆåï¼Œä¸€é”®åŒæ­¥åˆ°è¿œç«¯
# ============================================
npm run supabase:sync
# ğŸš€ è‡ªåŠ¨æ‰§è¡Œï¼š
#   1. æ¨é€æ•°æ®åº“è¿ç§» (supabase db push)
#   2. éƒ¨ç½²æ‰€æœ‰ Edge Functions (supabase functions deploy)
# âœ… åŒæ­¥å®Œæˆï¼

# ============================================
# æ”¶å·¥ï¼šåœæ­¢æœ¬åœ° Supabase
# ============================================
npm run supabase:stop
```

---

## ğŸ“¸ ç‰ˆæœ¬ç®¡ç†ï¼ˆå¿«ç…§ç³»ç»Ÿï¼‰

### å·¥ä½œåŸç†

å¿«ç…§ç³»ç»Ÿä½¿ç”¨ `pg_dump` å¯¼å‡ºå®Œæ•´æ•°æ®åº“ï¼Œä¿å­˜åˆ° `supabase/snapshots/` ç›®å½•ã€‚

```
supabase/
â””â”€â”€ snapshots/
    â”œâ”€â”€ 20260116_143000_å¼€å§‹æ”¹ç”¨æˆ·è¡¨.sql
    â”œâ”€â”€ 20260116_150000_æ·»åŠ è®°å¿†å­—æ®µ.sql
    â””â”€â”€ 20260116_160000_ä¿®å¤é€šçŸ¥bug.sql
```

### ä½¿ç”¨åœºæ™¯

#### åœºæ™¯ 1ï¼šå¼€å§‹æ–°åŠŸèƒ½å‰å¤‡ä»½

```bash
npm run supabase:snapshot "å¼€å§‹æ”¹ç”¨æˆ·è¡¨ä¹‹å‰"
# ğŸ“¸ å¿«ç…§åˆ›å»ºæˆåŠŸï¼
# æ–‡ä»¶: supabase/snapshots/20260116_143000_å¼€å§‹æ”¹ç”¨æˆ·è¡¨ä¹‹å‰.sql
```

#### åœºæ™¯ 2ï¼šæ”¹åäº†ï¼Œä»å¿«ç…§æ¢å¤

```bash
# æŸ¥çœ‹æœ‰å“ªäº›å¿«ç…§
npm run supabase:snapshots

# æ¢å¤åˆ°æŒ‡å®šå¿«ç…§
npm run supabase:restore 20260116_143000_å¼€å§‹æ”¹ç”¨æˆ·è¡¨ä¹‹å‰
# âš ï¸ è­¦å‘Š: è¿™å°†è¦†ç›–å½“å‰æœ¬åœ°æ•°æ®åº“çš„æ‰€æœ‰æ•°æ®ï¼
# ç¡®è®¤æ¢å¤? (y/N): y
# âœ… æ¢å¤æˆåŠŸï¼
```

#### åœºæ™¯ 3ï¼šæœ¬åœ°å®Œå…¨ä¹±äº†ï¼Œä»è¿œç¨‹æ¢å¤

```bash
npm run supabase:pull
# âš ï¸ è­¦å‘Š: è¿™å°†é‡ç½®æœ¬åœ°æ•°æ®åº“åˆ°è¿œç¨‹çš„ Schema çŠ¶æ€ï¼
# ç¡®è®¤ä»è¿œç¨‹æ‹‰å–? (y/N): y
# âœ… å®Œæˆï¼æœ¬åœ°æ•°æ®åº“å·²ä¸è¿œç¨‹åŒæ­¥
```

#### åœºæ™¯ 4ï¼šæƒ³è¦ä¸€ä¸ªå¹²å‡€çš„åˆå§‹çŠ¶æ€

```bash
npm run supabase:reset
# é‡ç½®åˆ° migrations å®šä¹‰çš„åˆå§‹çŠ¶æ€
# æ‰€æœ‰æ•°æ®ä¼šè¢«æ¸…é™¤
```

---

## ğŸŒ æœ¬åœ°æœåŠ¡åœ°å€

å¯åŠ¨æœ¬åœ° Supabase åï¼Œå¯ä»¥è®¿é—®ä»¥ä¸‹åœ°å€ï¼š

| æœåŠ¡ | åœ°å€ | ç”¨é€” |
|------|------|------|
| **API (PostgREST)** | https://127.0.0.1:54321 | å‰ç«¯è°ƒç”¨çš„ REST API |
| **Studio (ä»ªè¡¨ç›˜)** | http://127.0.0.1:54323 | å¯è§†åŒ–ç®¡ç†æ•°æ®åº“ã€æŸ¥çœ‹æ•°æ® |
| **Inbucket (é‚®ä»¶)** | http://127.0.0.1:54324 | æŸ¥çœ‹æœ¬åœ°æµ‹è¯•é‚®ä»¶ |
| **æ•°æ®åº“ (PostgreSQL)** | localhost:54322 | ç›´æ¥è¿æ¥æ•°æ®åº“ï¼ˆç”¨æˆ·: postgresï¼Œå¯†ç : postgresï¼‰ |

### Studio ä»ªè¡¨ç›˜åŠŸèƒ½

è®¿é—® http://127.0.0.1:54323 å¯ä»¥ï¼š
- ğŸ“Š æŸ¥çœ‹å’Œç¼–è¾‘è¡¨æ•°æ®
- ğŸ”§ æ‰§è¡Œ SQL æŸ¥è¯¢
- ğŸ‘¥ ç®¡ç†ç”¨æˆ·è®¤è¯
- ğŸ“ ç®¡ç†æ–‡ä»¶å­˜å‚¨
- âš¡ æŸ¥çœ‹ Edge Functions æ—¥å¿—

---

## ğŸ“ ç›®å½•ç»“æ„

```
supabase/
â”œâ”€â”€ config.toml          # æœ¬åœ° Supabase é…ç½®
â”œâ”€â”€ .env.local           # Edge Functions å¯†é’¥ï¼ˆgit ignoredï¼‰
â”œâ”€â”€ .env.local.example   # å¯†é’¥æ¨¡æ¿
â”œâ”€â”€ functions/           # Edge Functionsï¼ˆ40+ ä¸ªï¼‰
â”‚   â”œâ”€â”€ _shared/         # å…±äº«åº“
â”‚   â”œâ”€â”€ memory-extractor/
â”‚   â”œâ”€â”€ get-system-instruction/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ migrations/          # æ•°æ®åº“è¿ç§»
â”‚   â””â”€â”€ 00000000000000_init.sql
â”œâ”€â”€ migrations_backup/   # å†å²è¿ç§»å¤‡ä»½
â””â”€â”€ snapshots/           # æœ¬åœ°å¿«ç…§ï¼ˆç‰ˆæœ¬ç®¡ç†ï¼‰

scripts/
â”œâ”€â”€ supabase-snapshot.sh   # åˆ›å»ºå¿«ç…§è„šæœ¬
â”œâ”€â”€ supabase-snapshots.sh  # åˆ—å‡ºå¿«ç…§è„šæœ¬
â”œâ”€â”€ supabase-restore.sh    # æ¢å¤å¿«ç…§è„šæœ¬
â””â”€â”€ supabase-pull.sh       # ä»è¿œç¨‹æ‹‰å–è„šæœ¬

# ç¯å¢ƒå˜é‡æ–‡ä»¶
.env.supabase-local      # æœ¬åœ°ç¯å¢ƒé…ç½®
.env.supabase-remote     # è¿œç«¯ç¯å¢ƒé…ç½®
.env.local               # å½“å‰æ´»è·ƒé…ç½®ï¼ˆç”±è„šæœ¬åˆ‡æ¢ï¼‰
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

### ç¯å¢ƒå˜é‡åˆ‡æ¢

| æ–‡ä»¶ | ç”¨é€” | Git è¿½è¸ª |
|------|------|---------|
| `.env.supabase-local` | æœ¬åœ° Supabase é…ç½® | âœ… æ˜¯ |
| `.env.supabase-remote` | è¿œç«¯ Supabase é…ç½® | âœ… æ˜¯ |
| `.env.local` | å½“å‰æ´»è·ƒé…ç½® | âŒ å¦ï¼ˆç”±è„šæœ¬è¦†ç›–ï¼‰ |
| `supabase/.env.local` | Edge Functions å¯†é’¥ | âŒ å¦ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰ |

### æœ¬åœ°é…ç½®å†…å®¹ (`.env.supabase-local`)

```env
VITE_SUPABASE_URL=https://127.0.0.1:54321
VITE_SUPABASE_ANON_KEY=eyJhbGci...ï¼ˆæœ¬åœ°æ¼”ç¤ºå¯†é’¥ï¼‰
```

### Edge Functions å¯†é’¥ (`supabase/.env.local`)

å¤åˆ¶ `supabase/.env.local.example` å¹¶å¡«å…¥çœŸå®å¯†é’¥ï¼š

```env
# AI åŠŸèƒ½ï¼ˆå¿…é¡»ï¼‰
GEMINI_API_KEY=your_key
AZURE_AI_API_KEY=your_key
AZURE_AI_ENDPOINT=https://xxx.openai.azure.com

# æ¨é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
APNS_KEY_ID=xxx
FCM_PROJECT_ID=xxx
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: `supabase start` å¤±è´¥

**å¯èƒ½åŸå› **ï¼šDocker æœªè¿è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
docker ps

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨ Docker Desktop
open -a Docker
```

### Q2: ç«¯å£è¢«å ç”¨

**å¯èƒ½åŸå› **ï¼šå…¶ä»–æœåŠ¡å ç”¨äº† 54321-54327 ç«¯å£

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :54321

# åœæ­¢å ç”¨çš„æœåŠ¡ï¼Œæˆ–ä¿®æ”¹ supabase/config.toml ä¸­çš„ç«¯å£
```

### Q3: HTTPS è¯ä¹¦é—®é¢˜

**å¯èƒ½åŸå› **ï¼šæœ¬åœ°ä½¿ç”¨è‡ªç­¾åè¯ä¹¦

**è§£å†³æ–¹æ¡ˆ**ï¼ˆmacOSï¼‰ï¼š
```bash
# ä¿¡ä»»æœ¬åœ°è¯ä¹¦
security add-trusted-cert -d -r trustRoot -k ~/Library/Keychains/login.keychain-db ~/.supabase/ssl/cert.pem
```

### Q4: Edge Functions æ— æ³•è®¿é—®

**å¯èƒ½åŸå› **ï¼šç¼ºå°‘å¯†é’¥é…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¤åˆ¶ `supabase/.env.local.example` ä¸º `supabase/.env.local`
2. å¡«å…¥çœŸå®çš„ API å¯†é’¥
3. é‡å¯ Supabase: `npm run supabase:stop && npm run supabase:start`

### Q5: ä»è¿œç¨‹æ‹‰å–åæ•°æ®ä¸¢å¤±

**è¿™æ˜¯é¢„æœŸè¡Œä¸º**ï¼š`supabase:pull` åªæ‹‰å– schema ç»“æ„ï¼Œä¸æ‹‰å–æ•°æ®ã€‚

å¦‚éœ€æµ‹è¯•æ•°æ®ï¼Œå¯ä»¥ï¼š
1. åˆ›å»º `supabase/seed.sql` æ·»åŠ æµ‹è¯•æ•°æ®
2. è¿è¡Œ `npm run supabase:reset` è‡ªåŠ¨å¡«å……

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æŒ‡å—](../dev-guide/deployment.md) - å¦‚ä½•éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- [è®°å¿†ç³»ç»Ÿ](./memory-system.md) - AI è®°å¿†ç³»ç»Ÿæ¶æ„
- [å…³é”®å†³ç­–](../KEY_DECISIONS.md) - æŠ€æœ¯å†³ç­–è®°å½•
