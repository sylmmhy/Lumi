---
title: "ToneManager Function Calling è¿ç§»"
created: 2026-01-16
updated: 2026-01-16 15:30
stage: "ğŸ§ª æµ‹è¯•"
due: 2026-01-20
issue: ""
---

# ToneManager Function Calling è¿ç§»å®ç°è¿›åº¦

## é˜¶æ®µè¿›åº¦
- [x] é˜¶æ®µ 1ï¼šéœ€æ±‚åˆ†æ
- [x] é˜¶æ®µ 2ï¼šæ–¹æ¡ˆè®¾è®¡
- [x] é˜¶æ®µ 3ï¼šæ ¸å¿ƒå®ç°
- [ ] é˜¶æ®µ 4ï¼šæµ‹è¯•éªŒè¯ â¬…ï¸ å½“å‰é˜¶æ®µ
- [ ] é˜¶æ®µ 5ï¼šæ–‡æ¡£æ›´æ–°

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### é—®é¢˜æè¿°
åŸæœ‰çš„ç”¨æˆ·æŠ—æ‹’æ£€æµ‹æœºåˆ¶ä¾èµ– AI åœ¨å›å¤å¼€å¤´æ·»åŠ  `[RESIST]` æ–‡æœ¬æ ‡è®°ã€‚è¿™ç§æ–¹æ³•åœ¨ Gemini Live å®æ—¶è¯­éŸ³æ¨¡å‹ä¸­ä¸å¯é ï¼Œå› ä¸ºï¼š
1. è¯­éŸ³æ¨¡å‹ä¸ä¼šä¸¥æ ¼éµå¾ªæ–‡æœ¬æ ¼å¼æŒ‡ä»¤
2. æµå¼å“åº”å¯èƒ½å¯¼è‡´æ ‡è®°è¢«æˆªæ–­
3. å¤šè¯­è¨€åœºæ™¯ä¸‹æ ‡è®°è§£æå›°éš¾

### è§£å†³æ–¹æ¡ˆ
ä½¿ç”¨ Gemini Live åŸç”Ÿæ”¯æŒçš„ **Function Calling** æœºåˆ¶ï¼Œå®šä¹‰ `reportUserState` å·¥å…·ï¼Œè®© AI åœ¨æ¯æ¬¡å›å¤å‰é€šè¿‡ç»“æ„åŒ–çš„å·¥å…·è°ƒç”¨æŠ¥å‘Šç”¨æˆ·çŠ¶æ€ã€‚

---

## 2. æ–¹æ¡ˆè®¾è®¡

### æ–°å·¥ä½œæµç¨‹
```
ç”¨æˆ·è¯´è¯ â†’ AI åˆ†æçŠ¶æ€ â†’ AI è°ƒç”¨ reportUserState({ state: 'resisting' })
         â†“
handleToolCall å›è°ƒæ¥æ”¶
         â†“
toneManager.recordResistance()
         â†“
è¿ç»­ 2 æ¬¡åç”Ÿæˆ [TONE_SHIFT] è§¦å‘è¯
         â†“
500ms å»¶è¿Ÿåå‘é€è§¦å‘è¯ç»™ Gemini
         â†“
AI é‡‡ç”¨æ–°è¯­æ°”ç»§ç»­å¯¹è¯
```

---

## 3. å®ç°è®°å½•

### 2026-01-16
- å®Œæˆæ ¸å¿ƒä»£ç å®ç°
- æ–°å¢ `userStateTools.ts` å·¥å…·å®šä¹‰
- ä¿®æ”¹ `useAICoachSession.ts` æ·»åŠ  `handleToolCall` å›è°ƒ
- ä¿®æ”¹ `get-system-instruction` Edge Function ç³»ç»ŸæŒ‡ä»¤
- ç¼–è¯‘éªŒè¯é€šè¿‡

### âš ï¸ é—®é¢˜ï¼šæµ‹è¯•æ—¶æœªçœ‹åˆ°ä»»ä½•å·¥å…·è°ƒç”¨æ—¥å¿—

---

## 4. å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|-----|
| `src/hooks/gemini-live/tools/userStateTools.ts` | å®šä¹‰ `reportUserState` å·¥å…· Schema |
| `src/hooks/useAICoachSession.ts` | æ·»åŠ  `handleToolCall` å›è°ƒå¤„ç†å·¥å…·è°ƒç”¨ |
| `supabase/functions/get-system-instruction/index.ts` | ç³»ç»ŸæŒ‡ä»¤ä¸­æ·»åŠ å·¥å…·ä½¿ç”¨è¯´æ˜ |

---

## 5. è°ƒè¯•åˆ†æï¼šä¸ºä»€ä¹ˆæ²¡æœ‰çœ‹åˆ°å·¥å…·è°ƒç”¨æ—¥å¿—ï¼Ÿ

### å¯èƒ½åŸå› æ’æŸ¥

#### ğŸ”´ æœ€å¯èƒ½ï¼šEdge Function æœªéƒ¨ç½²
`get-system-instruction` Edge Function ä¿®æ”¹åéœ€è¦æ‰‹åŠ¨éƒ¨ç½²åˆ° Supabaseã€‚å¦‚æœæ²¡æœ‰éƒ¨ç½²ï¼ŒAI ä¸ä¼šæ”¶åˆ°ä½¿ç”¨ `reportUserState` å·¥å…·çš„æŒ‡ä»¤ã€‚

**éªŒè¯æ–¹æ³•**ï¼š
```bash
cd firego--original-web
supabase functions deploy get-system-instruction
```

#### ğŸŸ¡ å¯èƒ½ï¼šå·¥å…·æ³¨å†Œä½† AI ä¸è°ƒç”¨
å³ä½¿å·¥å…·æ­£ç¡®æ³¨å†Œï¼ŒGemini Live æ¨¡å‹å¯èƒ½ä¸ä¼šä¸»åŠ¨è°ƒç”¨å·¥å…·ï¼Œé™¤éç³»ç»ŸæŒ‡ä»¤æ˜ç¡®è¦æ±‚ã€‚

**éªŒè¯æ–¹æ³•**ï¼š
åœ¨æ§åˆ¶å°æ£€æŸ¥æ˜¯å¦æœ‰ `ğŸ”§ Tool call received:` æ—¥å¿—ï¼ˆæ¥è‡ª `messageHandlers.ts`ï¼‰

#### ğŸŸ¢ è¾ƒä½å¯èƒ½ï¼šä»£ç é—®é¢˜
ä»£ç é€»è¾‘çœ‹èµ·æ¥æ­£ç¡®ï¼š
- `enableToneManager` é»˜è®¤ä¸º `true`
- `userStateTools` æ­£ç¡®ä¼ é€’ç»™ `useGeminiLive`
- `handleToolCall` æ­£ç¡®æ³¨å†Œä¸ºå›è°ƒ

---

## 6. å¾…åŠäº‹é¡¹

- [ ] **éƒ¨ç½² Edge Function**ï¼š`supabase functions deploy get-system-instruction`
- [ ] éªŒè¯éƒ¨ç½²ï¼šæ£€æŸ¥è¿”å›çš„ç³»ç»ŸæŒ‡ä»¤æ˜¯å¦åŒ…å« "USER STATE REPORTING"
- [ ] æµ‹è¯•å·¥å…·è°ƒç”¨ï¼šå¯¹ AI è¯´æŠ—æ‹’çš„è¯ï¼Œæ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
- [ ] éªŒè¯è¯­æ°”åˆ‡æ¢ï¼šè¿ç»­ 2 æ¬¡æŠ—æ‹’åï¼Œæ£€æŸ¥æ˜¯å¦è§¦å‘åˆ‡æ¢
- [ ] æ›´æ–°æ–‡æ¡£åˆ° implementation æ–‡ä»¶å¤¹

---

## 7. æµ‹è¯•æ­¥éª¤

1. **éƒ¨ç½² Edge Function**
   ```bash
   cd firego--original-web
   supabase functions deploy get-system-instruction
   ```

2. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
   ```bash
   npm run dev
   ```

3. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°** (Cmd+Option+J)

4. **å¼€å§‹ä»»åŠ¡ä¼šè¯**

5. **æµ‹è¯•æŠ—æ‹’åœºæ™¯**
   - å¯¹ AI è¯´ï¼š"å¤ªç´¯äº†"æˆ–"ä¸æƒ³åš"
   - **é¢„æœŸæ—¥å¿—**:
     ```
     ğŸ”§ Tool call received: ...
     ğŸ”§ [ToolCall] reportUserState: { state: 'resisting', ... }
     ğŸš« [ToneManager] AI é€šè¿‡å·¥å…·è°ƒç”¨æŠ¥å‘Šç”¨æˆ·æŠ—æ‹’ ...
     ```

6. **å¦‚æœæ²¡æœ‰çœ‹åˆ°æ—¥å¿—**ï¼š
   - æ£€æŸ¥ `enableToneManager` æ˜¯å¦ä¸º `true`
   - æ£€æŸ¥ç³»ç»ŸæŒ‡ä»¤æ˜¯å¦æ­£ç¡®ä¼ é€’ï¼ˆæœç´¢ "USER STATE REPORTING"ï¼‰
   - æ£€æŸ¥ Gemini è¿æ¥æ˜¯å¦æˆåŠŸ

---

## 8. ç›¸å…³ commit
- ä»£ç å®ç°è¢«é”™è¯¯åˆå¹¶åˆ°å…¶ä»– commitï¼Œè¯¦ç»†å˜æ›´è®°å½•åœ¨æ­¤æ–‡æ¡£ä¸­
