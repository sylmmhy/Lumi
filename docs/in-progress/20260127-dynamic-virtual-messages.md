---
title: "åŠ¨æ€è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿ"
created: 2026-01-27
updated: 2026-01-27 15:00
stage: "ğŸ“ è®¾è®¡"
due: 2026-02-10
issue: ""
---

# åŠ¨æ€è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿ å®ç°è¿›åº¦

## é˜¶æ®µè¿›åº¦
- [x] é˜¶æ®µ 1ï¼šéœ€æ±‚åˆ†æ
- [x] é˜¶æ®µ 2ï¼šæ–¹æ¡ˆè®¾è®¡
- [ ] é˜¶æ®µ 3ï¼šæ ¸å¿ƒå®ç°
- [ ] é˜¶æ®µ 4ï¼šæµ‹è¯•éªŒè¯
- [ ] é˜¶æ®µ 5ï¼šæ–‡æ¡£æ›´æ–°

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### é—®é¢˜
å½“å‰è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿçš„é—®é¢˜ï¼š
1. **æ— ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šè™šæ‹Ÿæ¶ˆæ¯ä¸çŸ¥é“ Gemini Live å½“å‰åœ¨èŠä»€ä¹ˆ
2. **é™æ€æ¨¡æ¿**ï¼šä½¿ç”¨å›ºå®šçš„è§¦å‘è¯æ ¼å¼ï¼Œæ— æ³•æ ¹æ®å¯¹è¯åŠ¨æ€è°ƒæ•´
3. **çªå…€æ„Ÿ**ï¼šæ³¨å…¥çš„æ¶ˆæ¯å¯èƒ½ä¸å½“å‰è¯é¢˜å®Œå…¨æ— å…³ï¼Œå¯¼è‡´ AI çªç„¶æ¢è¯é¢˜

### ç›®æ ‡
è®¾è®¡ä¸€ä¸ªå¹¶è¡Œäº Gemini Live çš„åŠ¨æ€è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿï¼š
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šçŸ¥é“å½“å‰å¯¹è¯çš„å®Œæ•´çŠ¶æ€
- **åŠ¨æ€ç”Ÿæˆ**ï¼šLLM æ ¹æ®ä¸Šä¸‹æ–‡ç”Ÿæˆåˆé€‚çš„æŒ‡ä»¤
- **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šç´§æ€¥æŒ‡ä»¤ï¼ˆå¦‚æƒ…ç»ªå“åº”ï¼‰ä¼˜å…ˆå‘é€
- **å†²çªæ§åˆ¶**ï¼šé¿å…æ‰“æ–­æ­£åœ¨è¿›è¡Œçš„å¯¹è¯

---

## 2. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Gemini Live Session                        â”‚
â”‚               (System Instruction åªèƒ½è®¾ç½®ä¸€æ¬¡)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ å®æ—¶å¯¹è¯
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¯¹è¯ä¸Šä¸‹æ–‡è¿½è¸ªå™¨ (ConversationContextTracker)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ recentMessages: æœ€è¿‘ N æ¡æ¶ˆæ¯                         â”‚    â”‚
â”‚  â”‚  â€¢ currentTopic: å½“å‰è¯é¢˜                                â”‚    â”‚
â”‚  â”‚  â€¢ topicFlow: è¯é¢˜æµè½¬å†å²                               â”‚    â”‚
â”‚  â”‚  â€¢ emotionalState: æƒ…ç»ªçŠ¶æ€                              â”‚    â”‚
â”‚  â”‚  â€¢ conversationPhase: å¯¹è¯é˜¶æ®µ                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ æä¾›ä¸Šä¸‹æ–‡
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            è™šæ‹Ÿæ¶ˆæ¯è°ƒåº¦å™¨ (VirtualMessageOrchestrator)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ è¯é¢˜æ£€æµ‹å™¨  â”‚  â”‚ å¼‚æ­¥è®°å¿†ç®¡é“  â”‚  â”‚ åŠ¨æ€æ¶ˆæ¯ç”Ÿæˆå™¨   â”‚          â”‚
â”‚  â”‚(æ­£åˆ™+å…³é”®è¯)â”‚  â”‚ (Mem0 æ£€ç´¢)  â”‚  â”‚ (LLM å¿«é€Ÿç”Ÿæˆ)  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                â”‚                   â”‚                   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â–¼                                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚              â”‚  æ¶ˆæ¯é˜Ÿåˆ— & å†²çªæ§åˆ¶  â”‚                            â”‚
â”‚              â”‚  (ä¼˜å…ˆçº§æ’åºã€å†·å´æœŸ)  â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ æ³¨å…¥è™šæ‹Ÿæ¶ˆæ¯
                           â–¼
                    (sendTextMessage)
```

---

## 3. å¯¹è¯ä¸Šä¸‹æ–‡è¿½è¸ªå™¨ï¼ˆæ ¸å¿ƒè¡¥å……ï¼‰

### 3.1 ç±»å‹å®šä¹‰

```typescript
// src/hooks/virtual-messages/types.ts

/**
 * å¯¹è¯æ¶ˆæ¯ï¼ˆç®€åŒ–ç‰ˆï¼Œç”¨äºä¸Šä¸‹æ–‡è¿½è¸ªï¼‰
 */
export interface ContextMessage {
  role: 'user' | 'assistant';
  content: string;
  timestamp: number;
  /** æ˜¯å¦ä¸ºè™šæ‹Ÿæ¶ˆæ¯è§¦å‘çš„å›å¤ */
  isVirtualTriggered?: boolean;
}

/**
 * è¯é¢˜ä¿¡æ¯
 */
export interface TopicInfo {
  /** è¯é¢˜æ ‡è¯† */
  id: string;
  /** è¯é¢˜åç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰ */
  name: string;
  /** æ£€æµ‹åˆ°çš„æ—¶é—´ */
  detectedAt: number;
  /** ç›¸å…³å…³é”®è¯ */
  keywords: string[];
}

/**
 * æƒ…ç»ªçŠ¶æ€
 */
export interface EmotionalState {
  /** ä¸»è¦æƒ…ç»ª */
  primary: 'neutral' | 'happy' | 'sad' | 'anxious' | 'frustrated' | 'tired';
  /** æƒ…ç»ªå¼ºåº¦ (0-1) */
  intensity: number;
  /** æ£€æµ‹åˆ°çš„æ—¶é—´ */
  detectedAt: number;
  /** è§¦å‘è¯ */
  trigger?: string;
}

/**
 * å¯¹è¯é˜¶æ®µ
 */
export type ConversationPhase =
  | 'greeting'        // å¼€åœºé—®å€™
  | 'exploring'       // æ¢ç´¢è¯é¢˜
  | 'deep_discussion' // æ·±å…¥è®¨è®º
  | 'emotional'       // æƒ…ç»ªå¤„ç†
  | 'wrapping_up'     // æ”¶å°¾é˜¶æ®µ
  | 'idle';           // ç©ºé—²

/**
 * å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡
 */
export interface ConversationContext {
  /** æœ€è¿‘ N æ¡æ¶ˆæ¯ */
  recentMessages: ContextMessage[];

  /** å½“å‰è¯é¢˜ */
  currentTopic: TopicInfo | null;

  /** è¯é¢˜æµè½¬å†å²ï¼ˆæœ€å¤šä¿ç•™ 5 ä¸ªï¼‰ */
  topicFlow: TopicInfo[];

  /** å½“å‰æƒ…ç»ªçŠ¶æ€ */
  emotionalState: EmotionalState;

  /** å¯¹è¯é˜¶æ®µ */
  phase: ConversationPhase;

  /** AI æœ€åè¯´çš„è¯ */
  lastAISpeech: string | null;

  /** ç”¨æˆ·æœ€åè¯´çš„è¯ */
  lastUserSpeech: string | null;

  /** å¯¹è¯å¼€å§‹æ—¶é—´ */
  sessionStartTime: number;

  /** æœ€åæ´»åŠ¨æ—¶é—´ */
  lastActivityTime: number;

  /** å¯¹è¯æ‘˜è¦ï¼ˆç”± LLM å®šæœŸç”Ÿæˆï¼‰ */
  summary?: string;
}

/**
 * è™šæ‹Ÿæ¶ˆæ¯çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå‘é€ç»™ LLM ç”Ÿæˆæ¶ˆæ¯æ—¶ä½¿ç”¨ï¼‰
 */
export interface VirtualMessageUserContext {
  /** ä»»åŠ¡æè¿° */
  taskDescription: string;

  /** å·²ç”¨æ—¶é—´ */
  elapsedTime: string;

  /** å‰©ä½™æ—¶é—´ */
  remainingTime?: string;

  /** ç”¨æˆ·æœ€è¿‘è¯´çš„è¯ */
  recentUserSpeech: string | null;

  /** AI æœ€è¿‘è¯´çš„è¯ */
  recentAISpeech: string | null;

  /** å½“å‰æƒ…ç»ª */
  currentEmotion: EmotionalState['primary'];

  /** æƒ…ç»ªå¼ºåº¦ */
  emotionIntensity: number;

  /** å½“å‰è¯é¢˜ */
  currentTopic: string | null;

  /** è¯é¢˜æµè½¬ï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼‰ */
  topicFlow: string[];

  /** å¯¹è¯é˜¶æ®µ */
  conversationPhase: ConversationPhase;

  /** å¯¹è¯æ‘˜è¦ */
  conversationSummary?: string;

  /** å½“å‰æœ¬åœ°æ—¶é—´ */
  currentTime: string;
}
```

### 3.2 å¯¹è¯ä¸Šä¸‹æ–‡è¿½è¸ªå™¨ Hook

```typescript
// src/hooks/virtual-messages/useConversationContextTracker.ts

import { useRef, useCallback, useMemo } from 'react';
import type {
  ConversationContext,
  ContextMessage,
  TopicInfo,
  EmotionalState,
  ConversationPhase,
  VirtualMessageUserContext
} from './types';

interface UseConversationContextTrackerOptions {
  /** ä¿ç•™çš„æœ€è¿‘æ¶ˆæ¯æ•°é‡ */
  maxRecentMessages?: number;
  /** ä¿ç•™çš„è¯é¢˜æµè½¬æ•°é‡ */
  maxTopicHistory?: number;
  /** ä»»åŠ¡æè¿° */
  taskDescription: string;
  /** åˆå§‹æ—¶é•¿ï¼ˆç§’ï¼‰ */
  initialDuration: number;
  /** ä»»åŠ¡å¼€å§‹æ—¶é—´ */
  taskStartTime: number;
}

const DEFAULT_EMOTIONAL_STATE: EmotionalState = {
  primary: 'neutral',
  intensity: 0,
  detectedAt: 0,
};

/**
 * å¯¹è¯ä¸Šä¸‹æ–‡è¿½è¸ªå™¨
 *
 * èŒè´£ï¼š
 * - è¿½è¸ªæœ€è¿‘ N æ¡å¯¹è¯æ¶ˆæ¯
 * - è¿½è¸ªå½“å‰è¯é¢˜å’Œè¯é¢˜æµè½¬
 * - è¿½è¸ªç”¨æˆ·æƒ…ç»ªçŠ¶æ€
 * - æ¨æ–­å¯¹è¯é˜¶æ®µ
 * - ç”Ÿæˆä¾›è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨çš„ä¸Šä¸‹æ–‡
 */
export function useConversationContextTracker(options: UseConversationContextTrackerOptions) {
  const {
    maxRecentMessages = 10,
    maxTopicHistory = 5,
    taskDescription,
    initialDuration,
    taskStartTime,
  } = options;

  // ä½¿ç”¨ ref å­˜å‚¨ä¸Šä¸‹æ–‡ï¼Œé¿å…é¢‘ç¹ re-render
  const contextRef = useRef<ConversationContext>({
    recentMessages: [],
    currentTopic: null,
    topicFlow: [],
    emotionalState: DEFAULT_EMOTIONAL_STATE,
    phase: 'greeting',
    lastAISpeech: null,
    lastUserSpeech: null,
    sessionStartTime: taskStartTime,
    lastActivityTime: taskStartTime,
  });

  /**
   * æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
   */
  const addUserMessage = useCallback((content: string, isVirtualTriggered = false) => {
    const now = Date.now();
    const message: ContextMessage = {
      role: 'user',
      content,
      timestamp: now,
      isVirtualTriggered,
    };

    const ctx = contextRef.current;
    ctx.recentMessages = [...ctx.recentMessages, message].slice(-maxRecentMessages);
    ctx.lastUserSpeech = content;
    ctx.lastActivityTime = now;

    // æ›´æ–°å¯¹è¯é˜¶æ®µ
    updatePhase(ctx);

    if (import.meta.env.DEV) {
      console.log('ğŸ“ [ContextTracker] æ·»åŠ ç”¨æˆ·æ¶ˆæ¯:', content.substring(0, 50));
    }
  }, [maxRecentMessages]);

  /**
   * æ·»åŠ  AI æ¶ˆæ¯
   */
  const addAIMessage = useCallback((content: string, isVirtualTriggered = false) => {
    const now = Date.now();
    const message: ContextMessage = {
      role: 'assistant',
      content,
      timestamp: now,
      isVirtualTriggered,
    };

    const ctx = contextRef.current;
    ctx.recentMessages = [...ctx.recentMessages, message].slice(-maxRecentMessages);
    ctx.lastAISpeech = content;
    ctx.lastActivityTime = now;

    // æ›´æ–°å¯¹è¯é˜¶æ®µ
    updatePhase(ctx);

    if (import.meta.env.DEV) {
      console.log('ğŸ¤– [ContextTracker] æ·»åŠ  AI æ¶ˆæ¯:', content.substring(0, 50));
    }
  }, [maxRecentMessages]);

  /**
   * æ›´æ–°å½“å‰è¯é¢˜
   */
  const updateTopic = useCallback((topic: TopicInfo) => {
    const ctx = contextRef.current;

    // å¦‚æœæ˜¯æ–°è¯é¢˜ï¼Œæ·»åŠ åˆ°æµè½¬å†å²
    if (!ctx.currentTopic || ctx.currentTopic.id !== topic.id) {
      ctx.topicFlow = [...ctx.topicFlow, topic].slice(-maxTopicHistory);

      if (import.meta.env.DEV) {
        console.log('ğŸ·ï¸ [ContextTracker] è¯é¢˜å˜æ›´:', ctx.currentTopic?.name, 'â†’', topic.name);
      }
    }

    ctx.currentTopic = topic;
  }, [maxTopicHistory]);

  /**
   * æ›´æ–°æƒ…ç»ªçŠ¶æ€
   */
  const updateEmotionalState = useCallback((state: EmotionalState) => {
    const ctx = contextRef.current;
    ctx.emotionalState = state;

    // å¦‚æœæ£€æµ‹åˆ°å¼ºçƒˆæƒ…ç»ªï¼Œè¿›å…¥æƒ…ç»ªå¤„ç†é˜¶æ®µ
    if (state.intensity > 0.6 && state.primary !== 'neutral') {
      ctx.phase = 'emotional';
    }

    if (import.meta.env.DEV) {
      console.log('ğŸ’­ [ContextTracker] æƒ…ç»ªæ›´æ–°:', state.primary, `(${state.intensity})`);
    }
  }, []);

  /**
   * æ›´æ–°å¯¹è¯æ‘˜è¦
   */
  const updateSummary = useCallback((summary: string) => {
    contextRef.current.summary = summary;
    if (import.meta.env.DEV) {
      console.log('ğŸ“‹ [ContextTracker] æ‘˜è¦æ›´æ–°:', summary);
    }
  }, []);

  /**
   * å†…éƒ¨ï¼šæ›´æ–°å¯¹è¯é˜¶æ®µ
   */
  const updatePhase = (ctx: ConversationContext) => {
    const messageCount = ctx.recentMessages.length;
    const elapsed = Date.now() - ctx.sessionStartTime;
    const elapsedMinutes = elapsed / 1000 / 60;

    // æƒ…ç»ªä¼˜å…ˆ
    if (ctx.emotionalState.intensity > 0.6 && ctx.emotionalState.primary !== 'neutral') {
      ctx.phase = 'emotional';
      return;
    }

    // æ ¹æ®æ¶ˆæ¯æ•°é‡å’Œæ—¶é—´æ¨æ–­é˜¶æ®µ
    if (messageCount <= 2) {
      ctx.phase = 'greeting';
    } else if (messageCount <= 6) {
      ctx.phase = 'exploring';
    } else if (elapsedMinutes > initialDuration / 60 * 0.8) {
      // è¶…è¿‡ 80% æ—¶é—´ï¼Œè¿›å…¥æ”¶å°¾é˜¶æ®µ
      ctx.phase = 'wrapping_up';
    } else {
      ctx.phase = 'deep_discussion';
    }
  };

  /**
   * è·å–å½“å‰ä¸Šä¸‹æ–‡å¿«ç…§
   */
  const getContext = useCallback((): ConversationContext => {
    return { ...contextRef.current };
  }, []);

  /**
   * ç”Ÿæˆä¾›è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨çš„ç”¨æˆ·ä¸Šä¸‹æ–‡
   */
  const getVirtualMessageContext = useCallback((): VirtualMessageUserContext => {
    const ctx = contextRef.current;
    const now = Date.now();
    const elapsed = now - taskStartTime;
    const elapsedSeconds = Math.floor(elapsed / 1000);
    const elapsedMinutes = Math.floor(elapsedSeconds / 60);
    const remainingSeconds = Math.max(0, initialDuration - elapsedSeconds);
    const remainingMinutes = Math.floor(remainingSeconds / 60);

    // æ ¼å¼åŒ–å½“å‰æ—¶é—´
    const currentTime = new Date().toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
    });

    return {
      taskDescription,
      elapsedTime: `${elapsedMinutes}m${elapsedSeconds % 60}s`,
      remainingTime: `${remainingMinutes}m${remainingSeconds % 60}s`,
      recentUserSpeech: ctx.lastUserSpeech,
      recentAISpeech: ctx.lastAISpeech,
      currentEmotion: ctx.emotionalState.primary,
      emotionIntensity: ctx.emotionalState.intensity,
      currentTopic: ctx.currentTopic?.name || null,
      topicFlow: ctx.topicFlow.map(t => t.name),
      conversationPhase: ctx.phase,
      conversationSummary: ctx.summary,
      currentTime,
    };
  }, [taskDescription, taskStartTime, initialDuration]);

  /**
   * é‡ç½®ä¸Šä¸‹æ–‡
   */
  const resetContext = useCallback(() => {
    contextRef.current = {
      recentMessages: [],
      currentTopic: null,
      topicFlow: [],
      emotionalState: DEFAULT_EMOTIONAL_STATE,
      phase: 'greeting',
      lastAISpeech: null,
      lastUserSpeech: null,
      sessionStartTime: Date.now(),
      lastActivityTime: Date.now(),
    };
  }, []);

  return {
    addUserMessage,
    addAIMessage,
    updateTopic,
    updateEmotionalState,
    updateSummary,
    getContext,
    getVirtualMessageContext,
    resetContext,
  };
}
```

---

## 4. æ¶ˆæ¯åè®®è®¾è®¡

### 4.1 æŒ‡ä»¤ç±»å‹

| ç±»å‹ | ç”¨é€” | ä¼˜å…ˆçº§ | è§¦å‘æ¡ä»¶ |
|------|------|--------|---------|
| `[EMPATHY]` | æƒ…ç»ªå“åº” | urgent | æ£€æµ‹åˆ°å¼ºçƒˆæƒ…ç»ª |
| `[DIRECTIVE]` | è¡Œä¸ºæŒ‡ä»¤ | high | éœ€è¦å¼•å¯¼ AI è¡Œä¸º |
| `[CONTEXT]` | è®°å¿†æ³¨å…¥ | normal | æ£€ç´¢åˆ°ç›¸å…³è®°å¿† |
| `[CHECKPOINT]` | å®šæ—¶æ£€æŸ¥ | low | å®šæ—¶è§¦å‘ |

### 4.2 æŒ‡ä»¤æ ¼å¼

æ¯ä¸ªæŒ‡ä»¤éƒ½åŒ…å« `conversation_context` å­—æ®µï¼Œè®© AI çŸ¥é“å½“å‰å¯¹è¯çŠ¶æ€ï¼š

```
[EMPATHY] emotion=sad intensity=0.8 trigger="å¤±æ‹" current_time=15:34
conversation_context: ç”¨æˆ·åˆšä»"å·¥ä½œå‹åŠ›"è¯é¢˜è½¬åˆ°"å¤±æ‹"ï¼ŒAI åˆšæ‰é—®äº†"æƒ³èŠèŠå‘ç”Ÿä»€ä¹ˆå—"
action: ä¼˜å…ˆå€¾å¬å’Œå®‰æ…°ï¼Œç­‰æƒ…ç»ªç¨³å®šåå†è½»æŸ”åœ°å¼•å¯¼å›ä»»åŠ¡ã€‚
```

```
[CONTEXT] type=memory topic="å¤±æ‹"
conversation_context: ç”¨æˆ·æ­£åœ¨è®¨è®ºå¤±æ‹ï¼Œæƒ…ç»ªä½è½
memory: ç”¨æˆ·æ›¾è¯´"æ¯æ¬¡å¤±æ‹éƒ½ä¼šé è¿åŠ¨æ¥è½¬ç§»æ³¨æ„åŠ›"
action: è‡ªç„¶åœ°å¼•ç”¨è¿™æ®µè®°å¿†ï¼Œä½†ä¸è¦æ‰“æ–­å½“å‰çš„æƒ…æ„Ÿå¯¹è¯ã€‚ç­‰ç”¨æˆ·æƒ…ç»ªç¨³å®šåå†æåŠã€‚
```

```
[CHECKPOINT] elapsed=2m remaining=3m current_time=15:36
conversation_context: ç”¨æˆ·æƒ…ç»ªå·²ç¨³å®šï¼Œå½“å‰è¯é¢˜æ˜¯"å¦‚ä½•é¢å¯¹å¤±æ‹"
last_ai_said: "å¤±æ‹ç¡®å®å¾ˆéš¾å—ï¼Œä½†ä½ èƒ½æ­£è§†å®ƒå·²ç»å¾ˆå‹‡æ•¢äº†"
action: è½»æŸ”åœ°æŠŠè¯é¢˜å¼•å›ä»»åŠ¡ï¼Œä¸è¦çªç„¶åˆ‡æ¢ã€‚
```

---

## 5. System Prompt æ”¹é€ 

åœ¨ç°æœ‰ System Prompt åŸºç¡€ä¸Šæ–°å¢ä»¥ä¸‹æ®µè½ï¼š

```
==================================================
DYNAMIC INSTRUCTION SYSTEM (Runtime Guidance)
==================================================
You will receive [DIRECTIVE], [CONTEXT], [CHECKPOINT], and [EMPATHY] messages during the conversation.
These are SYSTEM INSTRUCTIONS, not user speech. Process them silently and adjust your behavior accordingly.

CRITICAL: Each instruction includes a "conversation_context" field. This tells you:
- What topic the user was just discussing
- What you (AI) just said
- The user's current emotional state
- The overall conversation flow

Use this context to ensure your response feels natural and connected to the ongoing conversation.

## [EMPATHY] - Emotional Response (HIGHEST PRIORITY)
Format: [EMPATHY] emotion=X intensity=Y trigger="Z" current_time=HH:MM
conversation_context: ...
action: ...

When you receive this:
- emotion=sad â†’ Be gentle, supportive, don't push the task
- emotion=anxious â†’ Offer calm reassurance, suggest deep breaths
- emotion=frustrated â†’ Acknowledge the frustration, offer simpler options
- emotion=tired â†’ Validate tiredness, offer to adjust expectations

## [DIRECTIVE] - Action Commands
Format: [DIRECTIVE] action=X current_time=HH:MM
conversation_context: ...

Available actions:
- action=encourage â†’ Give a gentle push, but respect the conversation flow
- action=topic_shift target=Y â†’ Gradually transition to topic Y
- action=listen_first â†’ Enter listening mode, pause task-related suggestions
- action=celebrate â†’ Celebrate an achievement

## [CONTEXT] - Memory Injection
Format: [CONTEXT] type=memory topic="X"
conversation_context: ...
memory: ...
action: ...

When incorporating memories:
- NEVER read verbatim. Paraphrase naturally.
- Respect the current emotional state
- Wait for an appropriate moment in the conversation

## [CHECKPOINT] - Timed Check-in
Format: [CHECKPOINT] elapsed=Xm remaining=Ym current_time=HH:MM
conversation_context: ...
last_ai_said: ...
action: ...

Use this to:
- Gently remind about time if appropriate
- Adjust your approach based on remaining time
- Respect the ongoing conversation topic

## CRITICAL RULES
1. NEVER speak the instruction syntax out loud
2. NEVER say "I received a directive..." or "According to the context..."
3. Priority order: EMPATHY > DIRECTIVE > CHECKPOINT > CONTEXT
4. ALWAYS use conversation_context to ensure continuity
5. If context shows emotional discussion, don't abruptly switch topics
```

---

## 6. æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶

```
src/hooks/virtual-messages/
â”œâ”€â”€ index.ts                              # å¯¼å‡ºå…¥å£
â”œâ”€â”€ types.ts                              # ç±»å‹å®šä¹‰ â­
â”œâ”€â”€ constants.ts                          # è¯é¢˜è§„åˆ™ã€æƒ…ç»ªè¯åº“
â”œâ”€â”€ useConversationContextTracker.ts      # å¯¹è¯ä¸Šä¸‹æ–‡è¿½è¸ªå™¨ â­â­â­
â”œâ”€â”€ useVirtualMessageOrchestrator.ts      # æ ¸å¿ƒè°ƒåº¦å™¨
â”œâ”€â”€ useVirtualMessageQueue.ts             # æ¶ˆæ¯é˜Ÿåˆ— + å†²çªæ§åˆ¶
â”œâ”€â”€ useTopicDetector.ts                   # è¯é¢˜/æƒ…ç»ªæ£€æµ‹
â””â”€â”€ useAsyncMemoryPipeline.ts             # å¼‚æ­¥è®°å¿†æ£€ç´¢

supabase/functions/
â”œâ”€â”€ generate-dynamic-message/             # æ–°å¢ï¼šLLM å¿«é€Ÿç”Ÿæˆ
â”‚   â””â”€â”€ index.ts
â””â”€â”€ get-system-instruction/
    â””â”€â”€ index.ts                          # ä¿®æ”¹ï¼šæ·»åŠ  Dynamic Instruction æ®µè½
```

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `src/hooks/useVirtualMessages.ts` | é‡æ„ä¸ºè–„åŒ…è£…å±‚ï¼Œè°ƒç”¨æ–°ç³»ç»Ÿ |
| `src/hooks/useAICoachSession.ts` | é›†æˆ ConversationContextTracker |
| `supabase/functions/get-system-instruction/index.ts` | æ·»åŠ  Dynamic Instruction æ®µè½ |
| `supabase/functions/memory-extractor/index.ts` | æ·»åŠ  search_by_topic åŠŸèƒ½ |

---

## 7. æ•°æ®æµç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·è¯´"å› ä¸ºæˆ‘å¤±æ‹äº†"

```
æ—¶é—´çº¿:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T+0s    ç”¨æˆ·è¯´è¯
        â”‚
        â–¼
        userSpeechBufferRef ç´¯ç§¯: "å› ä¸ºæˆ‘å¤±æ‹äº†"
        â”‚
        â”œâ”€â”€â–º ConversationContextTracker.addUserMessage("å› ä¸ºæˆ‘å¤±æ‹äº†")
        â”‚    æ›´æ–°: lastUserSpeech = "å› ä¸ºæˆ‘å¤±æ‹äº†"
        â”‚
        â””â”€â”€â–º TopicDetector æ£€æµ‹åˆ° "å¤±æ‹"
             â†’ topic: 'breakup', emotion: 'sad', intensity: 0.8
             â”‚
             â”œâ”€â”€â–º ConversationContextTracker.updateTopic({ id: 'breakup', name: 'å¤±æ‹' })
             â”‚    æ›´æ–°: currentTopic, topicFlow
             â”‚
             â””â”€â”€â–º ConversationContextTracker.updateEmotionalState({ primary: 'sad', intensity: 0.8 })
                  æ›´æ–°: emotionalState, phase = 'emotional'

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T+100ms ç”Ÿæˆ [EMPATHY] æŒ‡ä»¤ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        â”‚
        â”œâ”€â”€â–º getVirtualMessageContext() è·å–å½“å‰ä¸Šä¸‹æ–‡
        â”‚    {
        â”‚      recentUserSpeech: "å› ä¸ºæˆ‘å¤±æ‹äº†",
        â”‚      recentAISpeech: "æƒ³èŠèŠå‘ç”Ÿä»€ä¹ˆå—",
        â”‚      currentEmotion: "sad",
        â”‚      emotionIntensity: 0.8,
        â”‚      currentTopic: "å¤±æ‹",
        â”‚      topicFlow: ["å·¥ä½œå‹åŠ›", "å¤±æ‹"],
        â”‚      conversationPhase: "emotional"
        â”‚    }
        â”‚
        â””â”€â”€â–º ç”Ÿæˆæ¶ˆæ¯:
             [EMPATHY] emotion=sad intensity=0.8 trigger="å¤±æ‹" current_time=15:34
             conversation_context: ç”¨æˆ·ä»"å·¥ä½œå‹åŠ›"è¯é¢˜è½¬åˆ°"å¤±æ‹"ï¼ŒAIåˆšé—®"æƒ³èŠèŠå‘ç”Ÿä»€ä¹ˆå—"
             action: ä¼˜å…ˆå€¾å¬å’Œå®‰æ…°ï¼Œä¸è¦å‚¬ä»»åŠ¡

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T+200ms å…¥é˜Ÿå¹¶å‘é€
        â”‚
        â””â”€â”€â–º Queue.enqueue({ type: 'EMPATHY', priority: 'urgent', ... })
             â†’ ç«‹å³å‘é€ï¼ˆurgent ä¼˜å…ˆçº§ï¼‰
             â†’ sendTextMessage(message)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T+300ms åŒæ—¶è§¦å‘å¼‚æ­¥è®°å¿†æ£€ç´¢ï¼ˆéé˜»å¡ï¼‰
        â”‚
        â””â”€â”€â–º AsyncMemoryPipeline.fetchMemoriesForTopic('breakup', ['å¤±æ‹', 'åˆ†æ‰‹', 'å‰ä»»'])
             â†’ åå°æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T+1s    AI æ”¶åˆ° [EMPATHY] åå¼€å§‹å›åº”
        â”‚
        â””â”€â”€â–º AI è¯´: "å¤±æ‹çœŸçš„å¾ˆéš¾å—...æˆ‘åœ¨è¿™é‡Œé™ªä½ "
             â”‚
             â””â”€â”€â–º ConversationContextTracker.addAIMessage("å¤±æ‹çœŸçš„å¾ˆéš¾å—...")
                  æ›´æ–°: lastAISpeech

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T+2.5s  è®°å¿†æ£€ç´¢å®Œæˆ
        â”‚
        â””â”€â”€â–º æ‰¾åˆ°è®°å¿†: "ç”¨æˆ·æ›¾è¯´æ¯æ¬¡å¤±æ‹éƒ½é è¿åŠ¨è½¬ç§»æ³¨æ„åŠ›"
             â”‚
             â””â”€â”€â–º ç”Ÿæˆ [CONTEXT] æŒ‡ä»¤:
                  [CONTEXT] type=memory topic="å¤±æ‹"
                  conversation_context: ç”¨æˆ·æ­£åœ¨è®¨è®ºå¤±æ‹ï¼ŒAI åˆšè¯´"æˆ‘åœ¨è¿™é‡Œé™ªä½ "
                  memory: ç”¨æˆ·æ›¾è¯´æ¯æ¬¡å¤±æ‹éƒ½é è¿åŠ¨è½¬ç§»æ³¨æ„åŠ›
                  action: ç­‰æƒ…ç»ªç¨³å®šåå†è‡ªç„¶å¼•ç”¨

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T+3s    å…¥é˜Ÿ [CONTEXT]
        â”‚
        â””â”€â”€â–º Queue.enqueue({ type: 'CONTEXT', priority: 'normal', ... })
             â†’ ç­‰å¾…å†·å´æœŸ
             â†’ AI è¯´å®Œè¯åå‘é€
```

---

## 8. å®ç°æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½ï¼ˆ1-2å¤©ï¼‰
- [ ] åˆ›å»º `src/hooks/virtual-messages/` ç›®å½•ç»“æ„
- [ ] å®ç° `types.ts` ç±»å‹å®šä¹‰
- [ ] å®ç° `useConversationContextTracker.ts` å¯¹è¯ä¸Šä¸‹æ–‡è¿½è¸ªå™¨
- [ ] å®ç° `useVirtualMessageQueue.ts` æ¶ˆæ¯é˜Ÿåˆ—

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ï¼ˆ2-3å¤©ï¼‰
- [ ] å®ç° `constants.ts` è¯é¢˜è§„åˆ™ã€æƒ…ç»ªè¯åº“
- [ ] å®ç° `useTopicDetector.ts` è¯é¢˜æ£€æµ‹
- [ ] å®ç° `useAsyncMemoryPipeline.ts` å¼‚æ­¥è®°å¿†ç®¡é“
- [ ] åˆ›å»º `generate-dynamic-message` Edge Function

### Phase 3: æ•´åˆï¼ˆ1-2å¤©ï¼‰
- [ ] å®ç° `useVirtualMessageOrchestrator.ts` æ ¸å¿ƒè°ƒåº¦å™¨
- [ ] ä¿®æ”¹ `get-system-instruction` æ·»åŠ æŒ‡ä»¤æ¥æ”¶æœºåˆ¶
- [ ] é‡æ„ `useVirtualMessages.ts` ä¸ºè–„åŒ…è£…å±‚
- [ ] é›†æˆåˆ° `useAICoachSession.ts`

### Phase 4: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼šè¯é¢˜æ£€æµ‹ â†’ è®°å¿†æ£€ç´¢ â†’ æ¶ˆæ¯æ³¨å…¥
- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¡®ä¿æ€»å»¶è¿Ÿ < 5 ç§’
- [ ] è¾¹ç•Œæƒ…å†µå¤„ç†ï¼šå¿«é€Ÿè¿ç»­è¯é¢˜ã€ç½‘ç»œé”™è¯¯ç­‰

---

## 9. æ€§èƒ½ç›®æ ‡

| æ“ä½œ | ç›®æ ‡å»¶è¿Ÿ | ç­–ç•¥ |
|------|---------|------|
| è¯é¢˜æ£€æµ‹ | < 50ms | å®¢æˆ·ç«¯æ­£åˆ™åŒ¹é… |
| ä¸Šä¸‹æ–‡è·å– | < 10ms | å†…å­˜è¯»å–ï¼Œæ— ç½‘ç»œ |
| è®°å¿†æ£€ç´¢ | < 3s | å¼‚æ­¥+ç¼“å­˜ |
| LLM ç”Ÿæˆ | < 2s | å¿«é€Ÿæ¨¡å‹ã€é™åˆ¶ tokens |
| é˜Ÿåˆ—å¤„ç† | < 100ms | å†…å­˜é˜Ÿåˆ—ã€ä¼˜å…ˆçº§æ’åº |
| **ç«¯åˆ°ç«¯** | **< 5s** | å¹¶è¡Œå¤„ç† |

---

## 10. å…³é”®é£é™©ä¸ç¼“è§£

| é£é™© | åæœ | ç¼“è§£æªæ–½ |
|------|------|---------|
| LLM ç”Ÿæˆå¤ªæ…¢ | å»¶è¿Ÿ > 5s | ä½¿ç”¨æ›´å¿«æ¨¡å‹ã€é™åˆ¶é•¿åº¦ã€ç¼“å­˜å¸¸è§å“åº” |
| æ¶ˆæ¯å†²çª | AI è¢«æ‰“æ–­ | çŠ¶æ€æœº + VAD æ£€æµ‹ + å†·å´æ—¶é—´ |
| è®°å¿†æ£€ç´¢å¤±è´¥ | æ— æ³•ä¸ªæ€§åŒ– | é™çº§åˆ°å›ºå®šæ¨¡æ¿ã€é”™è¯¯é‡è¯• |
| ä¸Šä¸‹æ–‡è¿‡æœŸ | ä¿¡æ¯ä¸å‡†ç¡® | å®æ—¶æ›´æ–°ã€æ—¶é—´æˆ³æ£€æŸ¥ |

---

## 11. ç›¸å…³ commit
...
