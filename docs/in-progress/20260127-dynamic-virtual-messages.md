---
title: "åŠ¨æ€è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿ"
created: 2026-01-27
updated: 2026-01-29 19:00
stage: "ğŸ”¨ å®ç°ä¸­"
due: 2026-02-10
issue: ""
---

# åŠ¨æ€è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿ

## é˜¶æ®µè¿›åº¦

- [x] é˜¶æ®µ 1ï¼šéœ€æ±‚åˆ†æ
- [x] é˜¶æ®µ 2ï¼šæ–¹æ¡ˆè®¾è®¡
- [x] é˜¶æ®µ 3ï¼šæ ¸å¿ƒå®ç°ï¼ˆåŸºç¡€è®¾æ–½ï¼‰âœ… 2026-01-28
  - [x] åˆ›å»º `_shared/memory-retrieval.ts` å…±äº«æ¨¡å—
  - [x] åˆ›å»º `retrieve-memories` Edge Function
  - [x] åˆ›å»ºå‰ç«¯ `virtual-messages` hooks
  - [ ] ä¿®æ”¹ `get-system-instruction` ä½¿ç”¨å…±äº«æ¨¡å—ï¼ˆå¯é€‰ï¼‰
- [x] é˜¶æ®µ 3.5ï¼šè¯­è¨€ä¸€è‡´æ€§ä¿®å¤ âœ… 2026-01-27
  - [x] ä¿®å¤è§¦å‘è¯è¯­è¨€æ±¡æŸ“é—®é¢˜ï¼ˆæ‰€æœ‰è§¦å‘è¯æºå¸¦ `language=` å‚æ•°ï¼‰
  - [x] ä¿®å¤ ToneManager è¯­æ°”åˆ‡æ¢æ—¶çš„è¯­è¨€æ±¡æŸ“
  - [x] æ›´æ–°ç³»ç»ŸæŒ‡ä»¤ï¼Œå¼ºåˆ¶ AI éµå¾ª `language=` å‚æ•°
- [x] é˜¶æ®µ 3.6ï¼šæ–¹æ¡ˆ A é™é»˜æ³¨å…¥å®ç° âœ… 2026-01-28
  - [x] åœ¨ `useGeminiSession` æ·»åŠ  `sendClientContent` æ–¹æ³•
  - [x] åœ¨ `useGeminiLive` æ·»åŠ  `injectContextSilently` æ–¹æ³•
  - [x] åˆ›å»º `useVirtualMessageQueue.ts` æ¶ˆæ¯é˜Ÿåˆ—
  - [x] åˆ›å»º `useVirtualMessageOrchestrator.ts` æ ¸å¿ƒè°ƒåº¦å™¨
- [x] é˜¶æ®µ 3.7ï¼šSemantic Router è¯é¢˜æ£€æµ‹ âœ… 2026-01-28
  - [x] åˆ›å»º `_shared/topic-embeddings.ts` è¯é¢˜å®šä¹‰ + embedding
  - [x] åˆ›å»º `get-topic-embedding` Edge Function
  - [x] é‡å†™ `useTopicDetector.ts` ä¸ºå¼‚æ­¥ API è°ƒç”¨
- [x] é˜¶æ®µ 3.8ï¼šSystem Prompt + æŠ—æ‹’åˆ†æé‡æ„ âœ… 2026-01-28
  - [x] æ–°å¢ 5 ç§è™šæ‹Ÿæ¶ˆæ¯ç±»å‹
  - [x] æ–°å¢ `analyzeResistance()` å‡½æ•°
  - [x] é‡æ„ System Promptï¼Œç§»é™¤ç¡¬ç¼–ç è§„åˆ™
- [x] é˜¶æ®µ 3.9ï¼šBug ä¿®å¤ âœ… 2026-01-29
  - [x] ä¿®å¤ `sendClientContent` è°ƒç”¨é”™è¯¯çš„ SDK æ–¹æ³•
  - [x] ä¿®å¤è¯é¢˜æ£€æµ‹é˜ˆå€¼å‰åç«¯ä¸ä¸€è‡´
- [x] é˜¶æ®µ 4ï¼šé›†æˆåˆ° useAICoachSession âœ… 2026-01-28
  - [x] åˆå§‹åŒ– `useVirtualMessageOrchestrator` è°ƒåº¦å™¨
  - [x] åœ¨ `onTranscriptUpdate` ä¸­è°ƒç”¨ `onUserSpeech` å’Œ `onAISpeech`
  - [x] åœ¨ `setOnTurnComplete` ä¸­è°ƒç”¨ `onTurnComplete`
  - [x] æš´éœ²è°ƒè¯•æ–¹æ³•ï¼š`orchestratorQueueSize`ã€`triggerMemoryRetrieval`
- [ ] é˜¶æ®µ 5ï¼šæµ‹è¯•éªŒè¯
- [ ] é˜¶æ®µ 6ï¼šæ–‡æ¡£æ›´æ–°

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### é—®é¢˜
å½“å‰è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿçš„é—®é¢˜ï¼š
1. **æ— ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šè™šæ‹Ÿæ¶ˆæ¯ä¸çŸ¥é“ Gemini Live å½“å‰åœ¨èŠä»€ä¹ˆ
2. **é™æ€æ¨¡æ¿**ï¼šä½¿ç”¨å›ºå®šçš„è§¦å‘è¯æ ¼å¼ï¼Œæ— æ³•æ ¹æ®å¯¹è¯åŠ¨æ€è°ƒæ•´
3. **çªå…€æ„Ÿ**ï¼šæ³¨å…¥çš„æ¶ˆæ¯å¯èƒ½ä¸å½“å‰è¯é¢˜å®Œå…¨æ— å…³ï¼Œå¯¼è‡´ AI çªç„¶æ¢è¯é¢˜

### ç›®æ ‡
è®¾è®¡ä¸€ä¸ªå¹¶è¡Œäº Gemini Live çš„åŠ¨æ€è™šæ‹Ÿæ¶ˆæ¯ç³»ç»Ÿï¼š
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šçŸ¥é“å½“å‰å¯¹è¯çš„å®Œæ•´çŠ¶æ€
- **åŠ¨æ€ç”Ÿæˆ**ï¼šLLM æ ¹æ®ä¸Šä¸‹æ–‡ç”Ÿæˆåˆé€‚çš„æŒ‡ä»¤
- **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šç´§æ€¥æŒ‡ä»¤ï¼ˆå¦‚æƒ…ç»ªå“åº”ï¼‰ä¼˜å…ˆå‘é€
- **å†²çªæ§åˆ¶**ï¼šé¿å…æ‰“æ–­æ­£åœ¨è¿›è¡Œçš„å¯¹è¯

### é¢„æœŸæ•ˆæœ
```
ç”¨æˆ·è¯´: "æˆ‘ç”·æœ‹å‹å¯èƒ½ä¸æ¥äº†"
        â†“
ç³»ç»Ÿæ£€æµ‹åˆ°: è¯é¢˜="æ„Ÿæƒ…é—®é¢˜", æƒ…ç»ª="sad"
        â†“
æ£€ç´¢ç›¸å…³è®°å¿†: "ç”¨æˆ·ä¹‹å‰å› ä¸ºç”·æœ‹å‹çš„äº‹æƒ…å½±å“å¿ƒæƒ…"
        â†“
æ³¨å…¥ [CONTEXT] æ¶ˆæ¯åˆ° Gemini Live
        â†“
AI å›å¤æ—¶è‡ªç„¶å¼•ç”¨è¿™æ®µè®°å¿†
```

---

## 2. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Gemini Live Session                        â”‚
â”‚               (System Instruction åªèƒ½è®¾ç½®ä¸€æ¬¡)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ å®æ—¶å¯¹è¯
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¯¹è¯ä¸Šä¸‹æ–‡è¿½è¸ªå™¨ (ConversationContextTracker)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ recentMessages: æœ€è¿‘ N æ¡æ¶ˆæ¯                         â”‚    â”‚
â”‚  â”‚  â€¢ currentTopic: å½“å‰è¯é¢˜                                â”‚    â”‚
â”‚  â”‚  â€¢ topicFlow: è¯é¢˜æµè½¬å†å²                               â”‚    â”‚
â”‚  â”‚  â€¢ emotionalState: æƒ…ç»ªçŠ¶æ€                              â”‚    â”‚
â”‚  â”‚  â€¢ conversationPhase: å¯¹è¯é˜¶æ®µ                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ æä¾›ä¸Šä¸‹æ–‡
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            è™šæ‹Ÿæ¶ˆæ¯è°ƒåº¦å™¨ (VirtualMessageOrchestrator)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ è¯é¢˜æ£€æµ‹å™¨  â”‚  â”‚ å¼‚æ­¥è®°å¿†ç®¡é“  â”‚  â”‚ åŠ¨æ€æ¶ˆæ¯ç”Ÿæˆå™¨   â”‚          â”‚
â”‚  â”‚(Semantic   â”‚  â”‚ (Mem0 æ£€ç´¢)  â”‚  â”‚ (LLM å¿«é€Ÿç”Ÿæˆ)  â”‚          â”‚
â”‚  â”‚ Router)    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚                   â”‚                   â”‚
â”‚        â”‚                â”‚                   â”‚                   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â–¼                                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚              â”‚  æ¶ˆæ¯é˜Ÿåˆ— & å†²çªæ§åˆ¶  â”‚                            â”‚
â”‚              â”‚  (ä¼˜å…ˆçº§æ’åºã€å†·å´æœŸ)  â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ æ³¨å…¥è™šæ‹Ÿæ¶ˆæ¯
                           â–¼
                  (sendClientContent)
```

---

## 3. å·²å®Œæˆçš„å®ç°

### 3.1 âœ… Semantic Router è¯é¢˜æ£€æµ‹ (2026-01-28)

ä½¿ç”¨ embedding å‘é‡ç›¸ä¼¼åº¦æ›¿ä»£å…³é”®è¯åŒ¹é…ï¼Œæ”¯æŒå¤šè¯­è¨€å’Œè¯­ä¹‰ç†è§£ã€‚

**å®ç°æ–‡ä»¶**ï¼š

| ä»“åº“ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| åç«¯ | `_shared/topic-embeddings.ts` | è¯é¢˜å®šä¹‰ + embedding ç¼“å­˜ |
| åç«¯ | `get-topic-embedding/index.ts` | Semantic Router API |
| å‰ç«¯ | `useTopicDetector.ts` | å¼‚æ­¥è°ƒç”¨ API |

**é¢„å®šä¹‰è¯é¢˜**ï¼ˆ15 ä¸ªï¼‰ï¼š

| ç±»åˆ« | è¯é¢˜ |
|------|------|
| æƒ…æ„Ÿç±» | æ„Ÿæƒ…é—®é¢˜ã€å¤±æ‹ã€å‹åŠ›ã€å­¤ç‹¬ |
| ç”Ÿæ´»ç±» | æ—…è¡Œã€å¥èº«è¿åŠ¨ã€ç¾é£Ÿ |
| å·¥ä½œ/å­¦ä¹ ç±» | å·¥ä½œã€å­¦ä¹ ã€å†™ä»£ç  |
| ç¤¾äº¤ç±» | æœ‹å‹ã€å®¶äºº |
| å¥åº·ç±» | ç¡çœ ã€å¥åº· |

**API æ¥å£**ï¼š
```json
POST /functions/v1/get-topic-embedding
{
  "text": "æˆ‘ç”·æœ‹å‹å¯èƒ½ä¸æ¥äº†",
  "threshold": 0.55
}

// å“åº”
{
  "matched": true,
  "topic": { "id": "relationship_issue", "name": "æ„Ÿæƒ…é—®é¢˜" },
  "confidence": 0.87,
  "shouldRetrieveMemory": true,
  "emotion": "sad",
  "emotionIntensity": 0.7
}
```

---

### 3.2 âœ… æŠ—æ‹’åˆ†æ + åŠ¨æ€æŒ‡ä»¤ç³»ç»Ÿ (2026-01-28)

å°† AI è¡Œä¸ºæ§åˆ¶ä»"ç¡¬ç¼–ç åœ¨ System Prompt"æ”¹ä¸º"é€šè¿‡è™šæ‹Ÿæ¶ˆæ¯åŠ¨æ€æ³¨å…¥"ã€‚

**æ–°å¢ 5 ç§è™šæ‹Ÿæ¶ˆæ¯ç±»å‹**ï¼š

| ç±»å‹ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|--------|
| `LISTEN_FIRST` | è¿›å…¥å€¾å¬æ¨¡å¼ï¼Œç”¨æˆ·æƒ³èŠæƒ…æ„Ÿ | urgent |
| `GENTLE_REDIRECT` | æƒ…ç»ªç¨³å®šåè½»æŸ”å¼•å¯¼å›ä»»åŠ¡ | high |
| `ACCEPT_STOP` | ç”¨æˆ·æ˜ç¡®ä¸æƒ³åšï¼Œä¼˜é›…æ¥å— | high |
| `PUSH_TINY_STEP` | éæƒ…æ„ŸæŠ—æ‹’ï¼Œæ¨è¿›å°æ­¥éª¤ | high |
| `TONE_SHIFT` | è¯­æ°”åˆ‡æ¢ï¼ˆä» ToneManager è§¦å‘ï¼‰ | high |

**æŠ—æ‹’åˆ†æå†³ç­–æ ‘**ï¼š

```
ç”¨æˆ·æŠ—æ‹’ ([RESIST] æ£€æµ‹åˆ°)
    â†“
æ£€æŸ¥è¯é¢˜æ£€æµ‹ç»“æœ (topicResult)
    â†“
â”Œâ”€ æƒ…æ„Ÿç±»è¯é¢˜ (relationship, breakup, stress, loneliness)
â”‚   â”œâ”€ emotionIntensity â‰¥ 0.7 â†’ action: 'empathy' â†’ [EMPATHY] æ¶ˆæ¯
â”‚   â””â”€ emotionIntensity < 0.7 â†’ action: 'listen'  â†’ [LISTEN_FIRST] æ¶ˆæ¯
â”‚
â”œâ”€ æ˜ç¡®æ‹’ç»å…³é”®è¯ ("ä¸æƒ³", "ç®—äº†", "don't want", "give up")
â”‚   â””â”€ action: 'accept_stop' â†’ [ACCEPT_STOP] æ¶ˆæ¯
â”‚
â””â”€ å…¶ä»– (æ™®é€šä»»åŠ¡æŠ—æ‹’)
    â”œâ”€ consecutiveRejections â‰¥ 2 â†’ action: 'tone_shift' â†’ [TONE_SHIFT] æ¶ˆæ¯
    â””â”€ consecutiveRejections < 2 â†’ action: 'tiny_step'  â†’ [PUSH_TINY_STEP] æ¶ˆæ¯
```

---

### 3.3 âœ… é™é»˜æ³¨å…¥æœºåˆ¶ (æ–¹æ¡ˆ A) (2026-01-28)

ä½¿ç”¨ `sendClientContent` + `turnComplete=false` é™é»˜æ³¨å…¥ä¸Šä¸‹æ–‡ã€‚

**æ ¸å¿ƒä»£ç **ï¼š
```typescript
// useGeminiSession.ts
const sendClientContent = useCallback((content: string, turnComplete = false): boolean => {
  if (!session) return false;

  session.sendClientContent({
    turns: [{ role: 'user', parts: [{ text: content }] }],
    turnComplete,
  });
  return true;
}, []);
```

**æ³¨å…¥æ—¶æœº**ï¼šAI è¯´å®Œè¯åï¼ˆturnComplete äº‹ä»¶ï¼‰çš„å®‰å…¨çª—å£æœŸå†…ã€‚

---

### 3.4 âœ… Bug ä¿®å¤è®°å½•

#### 3.4.1 isSpeaking æ—¶åºé—®é¢˜ (2026-01-28)

**æ–‡ä»¶**: `src/hooks/gemini-live/useGeminiLive.ts`

**é—®é¢˜**: `turnComplete` äº‹ä»¶è§¦å‘åï¼Œ`isSpeakingRef` è¿˜æ˜¯ `true`ï¼Œå¯¼è‡´è™šæ‹Ÿæ¶ˆæ¯å‘é€å¤±è´¥ã€‚

**ä¿®å¤**: åœ¨ `onTurnComplete` å›è°ƒä¸­ç«‹å³åŒæ­¥æ›´æ–° `isSpeakingRef.current = false`ã€‚

---

#### 3.4.2 ç”¨æˆ·è¯­éŸ³ç¢ç‰‡åŒ–é—®é¢˜ (2026-01-28)

**æ–‡ä»¶**: `src/hooks/useAICoachSession.ts`

**é—®é¢˜**: `onUserSpeech` æ”¶åˆ°çš„æ˜¯å•è¯ç¢ç‰‡ï¼Œè¯é¢˜æ£€æµ‹å™¨æ— æ³•ä»ç¢ç‰‡ä¸­æ£€æµ‹è¯é¢˜ã€‚

**ä¿®å¤**: ç­‰ç”¨æˆ·è¯´å®Œæ•´å¥è¯åï¼ˆAI å¼€å§‹å›å¤æ—¶ï¼‰å†è°ƒç”¨ `onUserSpeech(fullUserMessage)`ã€‚

---

#### 3.4.3 sendClientContent è¿”å›å€¼é—®é¢˜ (2026-01-28)

**æ–‡ä»¶**: `src/hooks/gemini-live/core/useGeminiSession.ts`, `useGeminiLive.ts`

**é—®é¢˜**: `sendClientContent` å¤±è´¥æ—¶ä»ç„¶è¿”å› trueï¼Œå¯¼è‡´è¯¯æŠ¥å‘é€æˆåŠŸã€‚

**ä¿®å¤**: è¿”å› boolean å¹¶åœ¨ `injectContextSilently` ä¸­æ£€æŸ¥è¿”å›å€¼ã€‚

---

#### 3.4.4 sendClientContent è°ƒç”¨é”™è¯¯çš„ SDK æ–¹æ³• âœ… (2026-01-29)

**æ–‡ä»¶**: `src/hooks/gemini-live/core/useGeminiSession.ts`

**é—®é¢˜**: ä»£ç å°è¯•è°ƒç”¨ `session.send()` è¿™ä¸ªåº•å±‚æ–¹æ³•ï¼Œä½† Gemini SDK æš´éœ²çš„æ˜¯ `session.sendClientContent()` æ–¹æ³•ã€‚

**æ—¥å¿—è¡¨ç°**:
```
âš ï¸ [GeminiSession] sendClientContent å¤±è´¥: session.send ä¸å¯ç”¨
âš ï¸ [GeminiLive] é™é»˜æ³¨å…¥å¤±è´¥: sendClientContent è¿”å› false
â¸ï¸ [MessageQueue] å‘é€å¤±è´¥ï¼ˆä¸åœ¨å®‰å…¨çª—å£ï¼‰: PUSH_TINY_STEP
```

**ä¿®å¤å‰**:
```typescript
const session = sessionRef.current as unknown as {
  send?: (message: unknown) => void;
} | null;

if (session && typeof session.send === 'function') {
  session.send({
    client_content: { turns: [...], turn_complete: turnComplete }
  });
}
```

**ä¿®å¤å**:
```typescript
const session = sessionRef.current;
if (!session) return false;

try {
  // ä½¿ç”¨ SDK æä¾›çš„ sendClientContent æ–¹æ³•
  session.sendClientContent({
    turns: [{ role: 'user', parts: [{ text: content }] }],
    turnComplete,
  });
  return true;
} catch (error) {
  return false;
}
```

---

#### 3.4.5 è¯é¢˜æ£€æµ‹é˜ˆå€¼å‰åç«¯ä¸ä¸€è‡´ âœ… (2026-01-29)

**æ–‡ä»¶**: `src/hooks/virtual-messages/useTopicDetector.ts`

**é—®é¢˜**: å‰ç«¯ä¼ é€’é˜ˆå€¼ `0.65`ï¼Œä½†åç«¯æ–‡æ¡£è¯´çš„æ˜¯ `0.55`ã€‚å¯¼è‡´ 58.5% ç›¸ä¼¼åº¦è¢«åˆ¤å®šä¸º"æœªåŒ¹é…"ã€‚

**æ—¥å¿—è¡¨ç°**:
```
ğŸ¯ [TopicDetector] æœªåŒ¹é…: none (58.5%)
```
ï¼ˆ58.5% > 55% åº”è¯¥åŒ¹é…ï¼Œä½†å› ä¸ºå‰ç«¯ä¼ äº† 65% é˜ˆå€¼æ‰€ä»¥æ²¡åŒ¹é…ï¼‰

**ä¿®å¤**: å°†å‰ç«¯ `DEFAULT_THRESHOLD` ä» `0.65` æ”¹ä¸º `0.55`ã€‚

---

## 4. å½“å‰çŠ¶æ€æ€»ç»“

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è™šæ‹Ÿæ¶ˆæ¯å‘é€ | âœ… æ­£å¸¸ | æ‰€æœ‰ Bug å·²ä¿®å¤ |
| ç”¨æˆ·è¯­éŸ³å¤„ç† | âœ… æ­£å¸¸ | å®Œæ•´å¥å­ä¼ é€’ç»™æ£€æµ‹å™¨ |
| ä¼šè¯å¼€å§‹è®°å¿†æ³¨å…¥ | âœ… æ­£å¸¸ | system instruction ä¸­çš„è®°å¿†è¢« AI å¼•ç”¨ |
| **è¯é¢˜æ£€æµ‹** | âœ… å·²ä¿®å¤ | é˜ˆå€¼å·²ç»Ÿä¸€ä¸º 0.55 |
| **æŠ—æ‹’åˆ†æ** | âœ… å·²å®ç° | analyzeResistance() å‡½æ•° |
| **åŠ¨æ€æŒ‡ä»¤ç³»ç»Ÿ** | âœ… å·²å®ç° | System Prompt é‡æ„å®Œæˆ |
| **æ–°æ¶ˆæ¯ç±»å‹** | âœ… å·²å®ç° | LISTEN_FIRST, ACCEPT_STOP, PUSH_TINY_STEP ç­‰ |
| **sendClientContent** | âœ… å·²ä¿®å¤ | ä½¿ç”¨æ­£ç¡®çš„ SDK æ–¹æ³• |
| **å®æ—¶è®°å¿†æ£€ç´¢** | â¸ï¸ å¾…éªŒè¯ | ä¾èµ–è¯é¢˜æ£€æµ‹ï¼Œéœ€è¦æµ‹è¯•éªŒè¯ |

---

## 5. æµ‹è¯•éªŒè¯

### 5.1 æµ‹è¯•ç¯å¢ƒå¯åŠ¨
```bash
# ç»ˆç«¯ 1ï¼šå¯åŠ¨åç«¯
cd ../Lumi-supabase
npm run supabase:start
npm run supabase:functions

# ç»ˆç«¯ 2ï¼šå¯åŠ¨å‰ç«¯
cd ../Lumi
npm run dev:local
```

### 5.2 æµ‹è¯•ç”¨ä¾‹ - è¯é¢˜æ£€æµ‹

| æµ‹è¯•åœºæ™¯ | ç”¨æˆ·è¯´è¯ | é¢„æœŸç»“æœ |
|---------|---------|---------|
| æ„Ÿæƒ…é—®é¢˜ | "æˆ‘ç”·æœ‹å‹å¯èƒ½ä¸æ¥äº†" | åŒ¹é… `relationship_issue`, confidence > 0.55 |
| æ„Ÿæƒ…é—®é¢˜ï¼ˆé—´æ¥ï¼‰ | "he might not come" | åŒ¹é… `relationship_issue` |
| å¤±æ‹ | "we broke up" | åŒ¹é… `breakup`, emotion=sad |
| æ—…è¡Œ | "æ˜å¤©è¦å»æ‰“åŒ…è¡Œæ" | åŒ¹é… `travel` |
| å·¥ä½œå‹åŠ› | "deadlineå¿«åˆ°äº†å¥½ç„¦è™‘" | åŒ¹é… `work` æˆ– `stress` |
| æ— åŒ¹é… | "ä»Šå¤©å¤©æ°”ä¸é”™" | matched=false |

### 5.3 æµ‹è¯•ç”¨ä¾‹ - æŠ—æ‹’åˆ†æ + è™šæ‹Ÿæ¶ˆæ¯

| ç”¨æˆ·è¯´ | é¢„æœŸåˆ†æ | é¢„æœŸæ¶ˆæ¯ |
|-------|----------|---------|
| "æˆ‘ç”·æœ‹å‹å¯èƒ½ä¸æ¥äº†" | type=emotional, action=listen | [LISTEN_FIRST] |
| "I don't want to do this anymore" | type=explicit_stop, action=accept_stop | [ACCEPT_STOP] |
| "å¤ªç´¯äº†ï¼Œå¾…ä¼šå†è¯´" | type=task_resistance, action=tiny_step | [PUSH_TINY_STEP] |
| è¿ç»­æŠ—æ‹’ 2+ æ¬¡ï¼ˆéæƒ…æ„Ÿï¼‰ | type=task_resistance, action=tone_shift | [TONE_SHIFT] |

### 5.4 é¢„æœŸæ—¥å¿— - å®Œæ•´æµç¨‹

**è¯é¢˜æ£€æµ‹ + è®°å¿†æ£€ç´¢**:
```
ğŸ¯ [TopicDetector] åŒ¹é…: æ„Ÿæƒ…é—®é¢˜ (58%)
ğŸ·ï¸ [Orchestrator] è¯é¢˜å˜åŒ–: æ„Ÿæƒ…é—®é¢˜
ğŸ§  [MemoryPipeline] å¼€å§‹æ£€ç´¢
ğŸ§  [Orchestrator] è®°å¿†æ£€ç´¢å®Œæˆï¼Œå·²å…¥é˜Ÿ CONTEXT æ¶ˆæ¯
ğŸ“¥ [GeminiSession] sendClientContent (turnComplete=false): [CONTEXT]...
ğŸ”‡ [GeminiLive] é™é»˜æ³¨å…¥ä¸Šä¸‹æ–‡
ğŸ“¤ [MessageQueue] å‘é€æˆåŠŸ
```

**æŠ—æ‹’åˆ†æ + è™šæ‹Ÿæ¶ˆæ¯**:
```
ğŸš« AI æ£€æµ‹åˆ° [RESIST] æ ‡è®°
ğŸ” [ToneManager] æŠ—æ‹’åˆ†æ: {type: 'emotional', action: 'listen'}
ğŸ“¥ [MessageQueue] å…¥é˜Ÿ: LISTEN_FIRST (urgent)
ğŸ“¥ [GeminiSession] sendClientContent (turnComplete=false): [LISTEN_FIRST]...
ğŸ”‡ [GeminiLive] é™é»˜æ³¨å…¥ä¸Šä¸‹æ–‡
ğŸ“¤ [MessageQueue] å‘é€æˆåŠŸ: LISTEN_FIRST
```

---

## 6. æ–‡ä»¶å˜æ›´è®°å½•

### å‰ç«¯ï¼ˆLumi ä»“åº“ï¼‰

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `src/hooks/virtual-messages/types.ts` | æ–°å¢ 5 ç§æ¶ˆæ¯ç±»å‹ + SemanticRouterResponse |
| `src/hooks/virtual-messages/useTopicDetector.ts` | é‡å†™ä¸ºå¼‚æ­¥ API è°ƒç”¨ + ä¿®å¤é˜ˆå€¼ |
| `src/hooks/virtual-messages/useVirtualMessageOrchestrator.ts` | æ–°å¢æ¶ˆæ¯ç”Ÿæˆå‡½æ•° |
| `src/hooks/useToneManager.ts` | æ–°å¢ `analyzeResistance()` å‡½æ•° |
| `src/hooks/useAICoachSession.ts` | é›†æˆæŠ—æ‹’åˆ†æ + è™šæ‹Ÿæ¶ˆæ¯è”åŠ¨ |
| `src/hooks/gemini-live/core/useGeminiSession.ts` | ä¿®å¤ sendClientContent æ–¹æ³• |
| `src/hooks/gemini-live/useGeminiLive.ts` | ä¿®å¤ isSpeaking æ—¶åº + injectContextSilently |

### åç«¯ï¼ˆLumi-supabase ä»“åº“ï¼‰

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `supabase/functions/_shared/topic-embeddings.ts` | è¯é¢˜å®šä¹‰ + embedding ç¼“å­˜ |
| `supabase/functions/get-topic-embedding/index.ts` | Semantic Router API |
| `supabase/functions/get-system-instruction/index.ts` | é‡æ„ System Prompt |

---

## 7. æŠ€æœ¯ç»†èŠ‚

### 7.1 ç›¸ä¼¼åº¦é˜ˆå€¼

| é˜ˆå€¼ | å€¼ | ç”¨é€” |
|------|------|------|
| åŒ¹é…é˜ˆå€¼ | **0.55** | ä½äºæ­¤å€¼è§†ä¸ºæœªåŒ¹é… |
| è®°å¿†æ£€ç´¢é˜ˆå€¼ | **0.65** | é«˜äºæ­¤å€¼æ‰å»ºè®®æ£€ç´¢è®°å¿† |

### 7.2 æ¶ˆæ¯ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| urgent | EMPATHY, LISTEN_FIRST | ç«‹å³å‘é€ |
| high | DIRECTIVE, TONE_SHIFT, ACCEPT_STOP, PUSH_TINY_STEP | ä¼˜å…ˆå‘é€ |
| normal | CONTEXT | ç­‰å¾…å†·å´æœŸ |
| low | CHECKPOINT | æœ€åå‘é€ |

### 7.3 æ€§èƒ½é¢„æœŸ

| æ“ä½œ | é¢„æœŸå»¶è¿Ÿ |
|------|---------|
| è¯é¢˜æ£€æµ‹ï¼ˆé¦–æ¬¡è¯·æ±‚ï¼Œåˆå§‹åŒ–ç¼“å­˜ï¼‰ | ~500ms |
| è¯é¢˜æ£€æµ‹ï¼ˆåç»­è¯·æ±‚ï¼‰ | ~100-200ms |
| è¯é¢˜æ£€æµ‹ï¼ˆå‰ç«¯ç¼“å­˜å‘½ä¸­ï¼‰ | ~0ms |
| è™šæ‹Ÿæ¶ˆæ¯æ³¨å…¥ï¼ˆsendClientContentï¼‰ | ~10ms |

---

## 8. ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æµ‹è¯•éªŒè¯**ï¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯ä¿®å¤æ•ˆæœ
2. **è®°å¿†æ£€ç´¢æµ‹è¯•**ï¼šéªŒè¯è¯é¢˜æ£€æµ‹ â†’ è®°å¿†æ£€ç´¢ â†’ æ¶ˆæ¯æ³¨å…¥å®Œæ•´æµç¨‹
3. **è¾¹ç•Œæƒ…å†µå¤„ç†**ï¼šå¿«é€Ÿè¿ç»­è¯é¢˜åˆ‡æ¢ã€ç½‘ç»œé”™è¯¯ç­‰
4. **æ–‡æ¡£å®Œå–„**ï¼šæ›´æ–°æ¶æ„æ–‡æ¡£

---

## 9. ç›¸å…³æ–‡æ¡£

- æ¶æ„æ–‡æ¡£: `docs/architecture/memory-system.md`
- æµ‹è¯•ç”¨ä¾‹: `docs/test-cases/dynamic-virtual-messages-test.md`
