---
title: "ä¹ æƒ¯å åŠ  (Habit Stacking)"
created: 2026-01-29
updated: 2026-02-03 14:30
stage: "ğŸ§ª æµ‹è¯•"
due: 2026-02-05
issue: ""
---

# ä¹ æƒ¯å åŠ  (Habit Stacking) å®ç°è¿›åº¦

## é˜¶æ®µè¿›åº¦
- [x] é˜¶æ®µ 1ï¼šéœ€æ±‚åˆ†æä¸æ–¹æ¡ˆè®¾è®¡
- [x] é˜¶æ®µ 2ï¼šæ•°æ®åº“è¿ç§»ï¼ˆè¡¨ç»“æ„ + å‡½æ•°ï¼‰
- [x] é˜¶æ®µ 3ï¼šEdge Functionsï¼ˆAI æ¨è + è§¦å‘ï¼‰
- [x] é˜¶æ®µ 4ï¼šåŠŸèƒ½æ–‡æ¡£
- [x] é˜¶æ®µ 5ï¼šå‰ç«¯é›†æˆï¼ˆä¸‰å±‚ AI æ¶æ„ï¼‰
- [ ] é˜¶æ®µ 6ï¼šæµ‹è¯•éªŒè¯

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### èƒŒæ™¯
ä¹ æƒ¯å åŠ ï¼ˆHabit Stackingï¼‰æ˜¯è¡Œä¸ºç§‘å­¦ä¸­æœ‰æ•ˆçš„ä¹ æƒ¯å…»æˆç­–ç•¥ï¼š

```
After [ç°æœ‰ä¹ æƒ¯], I will [æ–°ä¹ æƒ¯]
```

åˆ©ç”¨å·²æœ‰ç¨³å®šä¹ æƒ¯ï¼ˆé”šç‚¹ï¼‰çš„è§¦å‘åŠ›ï¼Œå¸®åŠ©ç”¨æˆ·å…»æˆæ–°ä¹ æƒ¯ã€‚

### ç›®æ ‡
- è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·çš„é”šç‚¹ä¹ æƒ¯ï¼ˆç¨³å®šçš„è§¦å‘å™¨ï¼‰
- AI æ¨èæœ€ä½³æŒ‚è½½æ–¹æ¡ˆ
- é”šç‚¹å®Œæˆæ—¶è‡ªåŠ¨è§¦å‘åç»­ä¹ æƒ¯æé†’
- è¿½è¸ªæˆåŠŸç‡å¹¶è‡ªåŠ¨ä¼˜åŒ–

---

## 2. æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·æƒ³å…»æˆæ–°ä¹ æƒ¯ï¼ˆè¯­éŸ³å¯¹è¯ï¼‰
    â”‚
    â”œâ”€â”€ 1. detect-intent æ£€æµ‹åˆ°å°ä¹ æƒ¯æ„å›¾
    â”‚
    â”œâ”€â”€ 2. è§¦å‘ suggest_habit_stack å·¥å…·
    â”‚       â””â”€â”€ è·å–é”šç‚¹ä¹ æƒ¯ï¼ˆå®Œæˆç‡â‰¥85%ï¼Œâ‰¥14å¤©æ•°æ®ï¼‰
    â”‚       â””â”€â”€ Gemini AI åˆ†ææ¨è
    â”‚
    â”œâ”€â”€ 3. å·¥å…·ç»“æœæ³¨å…¥ç»™ Gemini Liveï¼ˆè™šæ‹Ÿæ¶ˆæ¯æ ¼å¼ï¼‰
    â”‚       â””â”€â”€ AI ç”¨è‡ªå·±çš„è¯å‘Šè¯‰ç”¨æˆ·æ¨èæ–¹æ¡ˆ
    â”‚
    â”œâ”€â”€ 4. ç”¨æˆ·ç¡®è®¤ "å¥½çš„"
    â”‚       â””â”€â”€ detect-intent æ£€æµ‹åˆ°ç¡®è®¤æ„å›¾
    â”‚       â””â”€â”€ è§¦å‘ create_habit_stack å·¥å…·
    â”‚
    â””â”€â”€ 5. åˆ›å»º task + habit_stack è®°å½•
            â””â”€â”€ é”šç‚¹å®Œæˆæ—¶è‡ªåŠ¨è§¦å‘æé†’
```

### ä¸‰å±‚ AI æ¶æ„é›†æˆ

ç”±äº Gemini Live çš„ Function Calling æœ‰ bug ä¼šå¯¼è‡´æ–­çº¿ï¼Œä¹ æƒ¯å åŠ ä½¿ç”¨ä¸‰å±‚ AI æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI #1: Gemini Live                                     â”‚
â”‚  - è´Ÿè´£å®æ—¶è¯­éŸ³å¯¹è¯                                       â”‚
â”‚  - ä¸ä½¿ç”¨ Function Calling                               â”‚
â”‚  - æ”¶åˆ° [TOOL_RESULT] æ—¶ç”¨è‡ªå·±çš„è¯è½¬è¿°                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI #2: detect-intent (Gemini Flash)                    â”‚
â”‚  - åˆ†æå¯¹è¯å†…å®¹ï¼Œæ£€æµ‹æ„å›¾                                 â”‚
â”‚  - åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·                                   â”‚
â”‚  - è¿”å›å·¥å…·åç§°å’Œå‚æ•°                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI #3: suggest-habit-stack (Gemini Flash)              â”‚
â”‚  - åˆ†æç”¨æˆ·ä¹ æƒ¯æ•°æ®                                       â”‚
â”‚  - ç”ŸæˆæŒ‚è½½æ¨è                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é”šç‚¹è¯†åˆ«æ¡ä»¶

| æ¡ä»¶ | é˜ˆå€¼ |
|------|------|
| æ•°æ®é‡ | â‰¥ 14 å¤© |
| å®Œæˆç‡ | â‰¥ 85% |
| æ—¶é—´ç¨³å®šæ€§ | æ ‡å‡†å·® < 60 åˆ†é’Ÿ |

---

## 3. å®ç°è®°å½•

### 2026-01-29 æ™šä¸Š

- **æ•°æ®åº“è¿ç§»** `20260129170000_habit_stacking.sql`ï¼š
  - `habit_context_rules` - ä¹ æƒ¯åœºæ™¯è§„åˆ™åº“ï¼ˆé¢„ç½® 14 æ¡è§„åˆ™ï¼‰
  - `habit_stacks` - ä¹ æƒ¯é“¾å…³ç³»è¡¨
  - `anchor_habits_view` - é”šç‚¹ä¹ æƒ¯è§†å›¾
  - RPC å‡½æ•°ï¼š`get_anchor_habits`, `check_habit_stack_compatibility`, `create_habit_stack`, `accept_habit_stack`, `get_active_habit_stacks`, `get_stacks_for_anchor`, `record_habit_stack_trigger`

- **Edge Functions**ï¼š
  - `suggest-habit-stack/index.ts` - AI æ¨èä¹ æƒ¯æŒ‚è½½æ–¹æ¡ˆ
  - `trigger-habit-stack/index.ts` - è§¦å‘ä¹ æƒ¯é“¾æé†’

### 2026-02-03 ä¸Šåˆ

- **å‰ç«¯é›†æˆ**ï¼š
  - `useIntentDetection.ts` - æ³›åŒ–å·¥å…·å»é‡é€»è¾‘ï¼Œé˜²æ­¢é‡å¤è§¦å‘
  - `toolHandlers.ts` - å®ç° `handleSuggestHabitStack` å’Œ `handleCreateHabitStack`
  - `VoiceChatTest.tsx` - ä½¿ç”¨è™šæ‹Ÿæ¶ˆæ¯æ ¼å¼æ³¨å…¥å·¥å…·ç»“æœ

- **åç«¯æ–°å¢**ï¼š
  - `create-habit-stack/index.ts` - åˆ›å»ºä¹ æƒ¯å åŠ ï¼ˆtask + habit_stackï¼‰
  - `start-voice-chat/index.ts` - System Prompt æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯å¤„ç†è¯´æ˜

- **æµ‹è¯•æ•°æ®**ï¼š
  - `test-data/create-anchor-habit.sql` - åˆ›å»ºé”šç‚¹ä¹ æƒ¯æµ‹è¯•æ•°æ®

---

## 4. å…³é”®æ–‡ä»¶

### åç«¯ (Lumi-supabase)

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `migrations/20260129170000_habit_stacking.sql` | æ•°æ®åº“è¿ç§»ï¼ˆè¡¨ + å‡½æ•°ï¼‰ |
| `migrations/20260129180000_habit_stack_trigger.sql` | æ•°æ®åº“è§¦å‘å™¨ |
| `functions/suggest-habit-stack/index.ts` | AI æ¨èæŒ‚è½½æ–¹æ¡ˆ |
| `functions/create-habit-stack/index.ts` | **æ–°å¢** åˆ›å»ºä¹ æƒ¯å åŠ  |
| `functions/trigger-habit-stack/index.ts` | è§¦å‘æé†’ |
| `functions/start-voice-chat/index.ts` | System Promptï¼ˆå«ç³»ç»Ÿæ¶ˆæ¯å¤„ç†ï¼‰ |
| `test-data/create-anchor-habit.sql` | **æ–°å¢** æµ‹è¯•æ•°æ®è„šæœ¬ |

### å‰ç«¯ (Lumi)

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `hooks/ai-tools/useIntentDetection.ts` | æ„å›¾æ£€æµ‹ï¼ˆä¸‰å±‚ AI #2ï¼‰ |
| `hooks/ai-tools/toolHandlers.ts` | å·¥å…·æ‰§è¡Œï¼ˆsuggest/createï¼‰ |
| `components/dev/VoiceChatTest.tsx` | æµ‹è¯•é¡µé¢ |

---

## 5. å·¥å…·è°ƒç”¨æµç¨‹è¯¦è§£

### Step 1: ç”¨æˆ·è¯´ "æˆ‘æƒ³æ¯å¤©å–ä¸€æ¯æ°´"

```
useIntentDetection æ”¶é›†ç”¨æˆ·æ¶ˆæ¯
    â”‚
    â–¼
è°ƒç”¨ detect-intent API
    â”‚
    â–¼
è¿”å›: { tool: "suggest_habit_stack", args: { new_habit: "å–ä¸€æ¯æ°´" } }
    â”‚
    â–¼
æ‰§è¡Œ handleSuggestHabitStack
    â”‚
    â–¼
è°ƒç”¨ suggest-habit-stack Edge Function
    â”‚
    â–¼
è¿”å›æ¨èç»“æœ + ä¿å­˜åˆ° lastSuggestionRef
```

### Step 2: å·¥å…·ç»“æœæ³¨å…¥

```typescript
// ä½¿ç”¨è™šæ‹Ÿæ¶ˆæ¯æ ¼å¼
const contextMessage = `[TOOL_RESULT] type=suggest_habit_stack
result: æˆ‘åˆ†æäº†ä½ è¿‡å»ä¸¤å‘¨çš„æ•°æ®ï¼Œã€Œåˆ·ç‰™ã€æ˜¯ä½ æœ€ç¨³å®šçš„ä¹ æƒ¯ï¼Œå®Œæˆç‡è¾¾åˆ° 85%ã€‚
       ä½ é€šå¸¸åœ¨ 08:05 å·¦å³å®Œæˆå®ƒã€‚æˆ‘å»ºè®®ä½ åœ¨ã€Œåˆ·ç‰™ã€ä¹‹ååšã€Œå–ä¸€æ¯æ°´ã€ã€‚
       åˆšå®Œæˆä¸€ä»¶äº‹æ—¶å¤§è„‘ä¼šé‡Šæ”¾å¤šå·´èƒºï¼Œè¿™æ—¶å¼€å§‹æ–°ä¹ æƒ¯æ›´å®¹æ˜“åšæŒã€‚
       è¦å¸®ä½ è®¾ç½®è¿™ä¸ªæé†’å—ï¼Ÿ
action: ç”¨ä½ è‡ªå·±çš„è¯ç®€çŸ­åœ°å‘Šè¯‰ç”¨æˆ·è¿™ä¸ªç»“æœã€‚ä¸è¦ç›´æ¥ç…§è¯»ï¼Œåƒæœ‹å‹ä¸€æ ·è‡ªç„¶åœ°è¯´ã€‚`;

geminiLive.sendClientContent(contextMessage, true);
```

### Step 3: ç”¨æˆ·ç¡®è®¤ "å¥½çš„"

```
useIntentDetection æ£€æµ‹åˆ°ç¡®è®¤æ„å›¾
    â”‚
    â–¼
è°ƒç”¨ detect-intent APIï¼ˆå¸¦ lastSuggestion ä¸Šä¸‹æ–‡ï¼‰
    â”‚
    â–¼
è¿”å›: { tool: "create_habit_stack", args: { anchor_task_id, new_habit_title, position, ... } }
    â”‚
    â–¼
æ‰§è¡Œ handleCreateHabitStack
    â”‚
    â–¼
è°ƒç”¨ create-habit-stack Edge Function
    â”‚
    â–¼
åˆ›å»º taskï¼ˆroutine ç±»å‹ï¼‰ + habit_stacks è®°å½•
```

---

## 6. æ•°æ®åº“çº¦æŸ

### habit_stacks è¡¨çº¦æŸ

```sql
-- status åªèƒ½æ˜¯ä»¥ä¸‹å€¼
CHECK (status = ANY (ARRAY['suggested', 'accepted', 'rejected', 'paused']))

-- stack_position åªèƒ½æ˜¯ before/after
CHECK (stack_position = ANY (ARRAY['before', 'after']))

-- suggested_by åªèƒ½æ˜¯ ai/user/system
CHECK (suggested_by = ANY (ARRAY['ai', 'user', 'system']))
```

### é”šç‚¹ä¹ æƒ¯è§†å›¾æ¡ä»¶

```sql
-- anchor_habits_view
is_valid_anchor = true WHEN:
  - total_instances >= 14
  - completion_rate >= 0.85
```

---

## 7. æµ‹è¯•æ–¹æ³•

### åˆ›å»ºæµ‹è¯•æ•°æ®

```bash
# åœ¨ Supabase Studio æ‰§è¡Œ
# æ–‡ä»¶ï¼štest-data/create-anchor-habit.sql

-- åˆ›å»ºä¸€ä¸ª 85% å®Œæˆç‡çš„é”šç‚¹ä¹ æƒ¯ "åˆ·ç‰™"
-- 20 å¤©æ•°æ®ï¼Œ17 å¤©å®Œæˆ
```

### éªŒè¯é”šç‚¹è¯†åˆ«

```sql
SELECT * FROM anchor_habits_view 
WHERE user_id = '11111111-1111-1111-1111-111111111111';
```

### æµ‹è¯•å¯¹è¯æµç¨‹

1. æ‰“å¼€ VoiceChatTest é¡µé¢
2. é€‰æ‹© "æ„å›¾ç¼–è¯‘" æ¨¡å¼
3. è¯´ "æˆ‘æƒ³æ¯å¤©å–ä¸€æ¯æ°´"
4. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼š
   - `ğŸ”§ [IntentDetection] æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨: suggest_habit_stack`
   - `âœ… [Tool] suggest_habit_stack ç»“æœ: {...}`
   - `ğŸ’‰ [å·¥å…·ç»“æœ] å·²æ³¨å…¥: ...`
5. AI å›å¤æ¨èæ–¹æ¡ˆ
6. è¯´ "å¥½çš„" ç¡®è®¤
7. è§‚å¯Ÿæ—¥å¿—ï¼š
   - `ğŸ”§ [IntentDetection] æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨: create_habit_stack`
   - `âœ… [Tool] create_habit_stack ç»“æœ: {...}`

### éªŒè¯æ•°æ®åº“

```sql
-- æ£€æŸ¥ habit_stacks
SELECT * FROM habit_stacks 
WHERE anchor_task_id = 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa';

-- æ£€æŸ¥æ–°åˆ›å»ºçš„ task
SELECT * FROM tasks 
WHERE title = 'å–ä¸€æ¯æ°´' AND task_type = 'routine';
```

---

## 8. å¾…åŠäº‹é¡¹

### åç«¯ âœ…
- [x] æ•°æ®åº“ï¼šhabit_context_rulesï¼ˆè§„åˆ™åº“ï¼‰
- [x] æ•°æ®åº“ï¼šhabit_stacksï¼ˆä¹ æƒ¯é“¾ï¼‰
- [x] æ•°æ®åº“ï¼šanchor_habits_viewï¼ˆé”šç‚¹è§†å›¾ï¼‰
- [x] Edge Functionï¼šsuggest-habit-stack
- [x] Edge Functionï¼šcreate-habit-stack
- [x] Edge Functionï¼štrigger-habit-stack
- [x] System Promptï¼šç³»ç»Ÿæ¶ˆæ¯å¤„ç†è¯´æ˜

### å‰ç«¯ âœ…
- [x] useIntentDetection é›†æˆ
- [x] toolHandlers å®ç°
- [x] è™šæ‹Ÿæ¶ˆæ¯æ ¼å¼æ³¨å…¥
- [x] å·¥å…·å»é‡é€»è¾‘

### æµ‹è¯• ğŸ§ª
- [x] æµ‹è¯•æ•°æ®è„šæœ¬
- [ ] é”šç‚¹è¯†åˆ«å‡†ç¡®æ€§
- [ ] AI æ¨èè´¨é‡
- [ ] ç«¯åˆ°ç«¯æµç¨‹éªŒè¯
- [ ] æé†’è§¦å‘åŠæ—¶æ€§

### ä¼˜åŒ– ğŸ“‹
- [ ] ä¹ æƒ¯é“¾ç®¡ç† UI
- [ ] æˆåŠŸç‡å¯è§†åŒ–
- [ ] ä¸ Goal ç³»ç»Ÿè”åŠ¨

---

## 9. ç›¸å…³ commit

### åç«¯ (Lumi-supabase)
- `d31f5ca` - feat: å®ç° create-habit-stack åç«¯ + ä¼˜åŒ– System Prompt

### å‰ç«¯ (Lumi)
- `pending` - feat: ä¼˜åŒ–ä¹ æƒ¯å åŠ å·¥å…·ç»“æœæ³¨å…¥

---

## 10. å·²çŸ¥é—®é¢˜

1. **AI å¯èƒ½ç›´æ¥è¯»å‡ºæ³¨å…¥å†…å®¹**ï¼šéœ€è¦åœ¨ System Prompt ä¸­æ˜ç¡®æŒ‡ç¤ºå¤„ç† `[TOOL_RESULT]`
2. **å·¥å…·é‡å¤è§¦å‘**ï¼šå·²é€šè¿‡ `triggeredToolsRef` è§£å†³
3. **è¯­è¨€æ··ä¹±**ï¼šéœ€è¦æ ¹æ® `preferredLanguage` è¿”å›å¯¹åº”è¯­è¨€çš„ `responseHint`

---

## 11. å‚è€ƒæ–‡æ¡£

- [ä¸‰å±‚ AI æ¶æ„](./20260130-three-layer-ai-architecture.md)
- [åŠ¨æ€è™šæ‹Ÿæ¶ˆæ¯](./20260127-dynamic-virtual-messages.md)
- [åŠŸèƒ½æ–‡æ¡£ï¼šä¹ æƒ¯å åŠ ](../features/habit_stacking.md)
