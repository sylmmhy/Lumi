 bugé—®é¢˜ï¼š ç›®å‰æƒ…å†µæ˜¯voipåœ¨æŽ¥å¬å¹¶ä¸”æˆåŠŸè·³è½¬åˆ°webviewçš„ai                                                    
  coachsessionåŽä¸å›žè‡ªåŠ¨æŒ‚æ–­ã€‚å…·ä½“ä½“çŽ°åœ¨å¯èƒ½æ˜¯è¯­éŸ³å’Œè§†é¢‘è¢«voipå ç”¨ï¼Œå¯¼è‡´webviewæ— æ³•è¿žæŽ¥ã€‚å³ä½¿      
  æŒ‚æ–­äº†webviewçš„è§†é¢‘ï¼Œvoipä¾æ—§åœ¨åŽå°è¿è¡Œã€‚è¿™ä¸ªæ˜¯æœ‰é—®é¢˜çš„ã€‚
 
 ç¬¬ä¸€ä¸ªaiçš„è¯Šæ–­æ—¥å¿—
 
 ---                                                                                              
  å®Œæ•´ VoIP æ¥ç”µæµç¨‹æ¢³ç†                                                                           
                                                                                                   
  ä¸‰ç«¯åä½œæµç¨‹å›¾
                                                                                                   
  åŽç«¯ (send-voip-push)                  
    â”‚  å‘é€ PushKit æŽ¨é€ (task, taskId, callRecordId)
    â–¼
  iOS AppDelegate.pushRegistry()
    â”‚  ä¿å­˜æ•°æ®åˆ° TaskStore (UserDefaults)
    â”‚  è°ƒç”¨ CallManager.reportIncomingCall()
    â”‚  â†’ ç³»ç»Ÿæ˜¾ç¤ºæ¥ç”µ UI
    â–¼
  ç”¨æˆ·ç‚¹å‡»ã€ŒæŽ¥å¬ã€
    â”‚
    â–¼
  CallManager.provider(perform: CXAnswerCallAction)   â† ã€å…³é”®èµ·ç‚¹ã€‘
    â”‚  â‘  activeCallUUID = action.callUUID
    â”‚  â‘¡ isWebViewReady = false
    â”‚  â‘¢ startAbsoluteTimeoutTimer()    â†’ 8ç§’åŽå…œåº•å¼ºåˆ¶æŒ‚æ–­
    â”‚  â‘£ AppCoordinator.presentWebExperience(targetURL: url)  [DispatchQueue.main.async]
    â”‚  â‘¤ action.fulfill()               â†’ å‘ŠçŸ¥ç³»ç»ŸæŽ¥å¬å®Œæˆ
    â–¼
  ç³»ç»Ÿè°ƒç”¨ didActivate (æ—¶é—´ä¸ç¡®å®š)
    â”‚  â‘  audioActivatedTime = Date()
    â”‚  â‘¡ è‹¥ isWebViewReady=true â†’ ç›´æŽ¥æŒ‚æ–­
    â”‚  â‘¢ å¦åˆ™ startNormalTimeoutTimer() â†’ 5ç§’åŽè¶…æ—¶æŒ‚æ–­
    â–¼
  AppCoordinator.presentWebExperience(targetURL:)   [main queue å¼‚æ­¥æ‰§è¡Œ]
    â”‚  â‘  å¤ç”¨å·²æœ‰çš„ WebViewController
    â”‚  â‘¡ webVC.applyNativeLogin(...)    â†’ è®¾ç½® auth payload
    â”‚  â‘¢ webVC.loadURL(url)
    â”‚     â†’ enableCallKitMode()          â†’ é‡ç½®å¹¶å¯ç”¨ CallKit å°±ç»ªè¿½è¸ª
    â”‚     â†’ loadURLWithAudioPreparation() â†’ å¯èƒ½é‡è¯•éŸ³é¢‘é…ç½®
    â”‚     â†’ performWebViewLoad(url)      â†’ å¼€å§‹åŠ è½½é¡µé¢
    â–¼
  WebView åŠ è½½é¡µé¢
    â”‚  é¡µé¢ JS æ‰§è¡Œï¼Œå‘çŽ° window.MindBoatNativeAuth å·²è®¾ç½®
    â”‚  â†’ applyNativeLogin â†’ setSession â†’ notifyAuthConfirmed("session_set")
    â”‚     â†’ iOS æ”¶åˆ° authConfirmed æ¶ˆæ¯
    â”‚     â†’ callKitTracker.markAuthConfirmed()     â† ã€æ¡ä»¶ 1 æ»¡è¶³ã€‘
    â”‚
    â”‚  didFinish å›žè°ƒè§¦å‘
    â”‚  â†’ callKitTracker.markWebViewLoadComplete()  â† ã€æ¡ä»¶ 2 æ»¡è¶³ã€‘
    â”‚  â†’ æ³¨å…¥ VoIP Token
    â”‚  â†’ æ³¨å…¥ç™»å½•æ€
    â–¼
  CallKitReadinessTracker.checkAndNotify()
    â”‚  ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ â†’ onReady() å›žè°ƒ
    â”‚  â†’ NotificationCenter.post("WebViewReadyForCall")
    â–¼
  CallManager å…¨å±€ observer æ”¶åˆ°é€šçŸ¥
    â”‚  â†’ handleWebViewReady()
    â”‚  â†’ isWebViewReady = true
    â”‚  â†’ è‹¥ audioActivatedTime != nil â†’ performHangup()
    â”‚  â†’ å¦åˆ™ç­‰å¾… didActivate
    â–¼
  performHangup()
    â”‚  â†’ å–æ¶ˆæ‰€æœ‰è¶…æ—¶è®¡æ—¶å™¨
    â”‚  â†’ endCall(uuid) â†’ CXEndCallAction â†’ ç³»ç»ŸæŒ‚æ–­ VoIP
    â–¼
  provider(didDeactivate:)
    â”‚  â†’ å‘é€ callKitDidDeactivateAudio é€šçŸ¥
    â”‚  â†’ WebViewController é‡æ–°é…ç½®éŸ³é¢‘ä¼šè¯
    â”‚  â†’ é€šçŸ¥ Web ç«¯éŸ³é¢‘å¯ç”¨

  ä¸‰å±‚æŒ‚æ–­ä¿æŠ¤æœºåˆ¶
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚      å±‚çº§      â”‚             è§¦å‘æ¡ä»¶              â”‚ è¶…æ—¶æ—¶é—´ â”‚         ä»£ç ä½ç½®          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ æ­£å¸¸æµç¨‹       â”‚ WebView å°±ç»ª + didActivate éƒ½å®Œæˆ â”‚ ~1s å»¶è¿Ÿ â”‚ handleWebViewReady()      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ æ­£å¸¸è¶…æ—¶       â”‚ didActivate åŽ WebView æœªå°±ç»ª     â”‚ 5 ç§’     â”‚ didActivate ä¸­å¯åŠ¨        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ç»å¯¹è¶…æ—¶(å…œåº•) â”‚ æŽ¥å¬åŽæ— æ¡ä»¶å€’è®¡æ—¶                â”‚ 8 ç§’     â”‚ CXAnswerCallAction ä¸­å¯åŠ¨ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ---
  ä»Žæ—¥å¿—ä¸­å‘çŽ°çš„å…³é”®è¯æ®

  è¯æ® 1ï¼šéº¦å…‹é£Žå…¨ç¨‹æ— éŸ³é¢‘ (volume=0)

  [10:16:08.511] VAD volume: 0, audioCtxState: "suspended"
  [10:16:09.485] VAD volume: 0, audioCtxState: "running"
  [10:16:10.485] VAD volume: 0
  [10:16:11.486] VAD volume: 0
  [10:16:12.490] VAD volume: 0    â† ç»å¯¹è¶…æ—¶(8s)åº”è¯¥å·²è§¦å‘
  [10:16:13.559] VAD volume: 0
  [10:16:14.554] VAD volume: 0
  [10:16:15.554] VAD volume: 0
  [10:16:16.559] VAD volume: 0    â† ç›´åˆ° AI ä¼šè¯ç»“æŸéƒ½æ˜¯ 0

  æ„ä¹‰ï¼šè™½ç„¶ Microphone started è¿”å›žæˆåŠŸï¼Œä½†å®žé™… æ²¡æœ‰å£°éŸ³æ•°æ®è¿›å…¥ã€‚è¿™è¯æ˜ŽéŸ³é¢‘ç¡¬ä»¶è¢« VoIP/CallKit
  å ç”¨ã€‚

  è¯æ® 2ï¼šå‰ç«¯ç¡®å®žå‘é€äº† authConfirmed

  [10:16:04.431] ðŸ” Web: å·²é€šçŸ¥ Native åœæ­¢é‡è¯•, reason: session_set

  æ„ä¹‰ï¼šWeb ç«¯çš„ notifyAuthConfirmed() ç¡®å®žè¢«è°ƒç”¨äº†ï¼ˆnativeAuthBridge.ts:57-64ï¼‰ï¼ŒiOS åº”è¯¥å·²æ”¶åˆ°
  authConfirmed æ¶ˆæ¯ã€‚

  è¯æ® 3ï¼šdidFinish ç¡®å®žè¢«è§¦å‘

  [10:16:04.607] âœ“ VoIP Token injected

  VoIP Token æ³¨å…¥å‘ç”Ÿåœ¨ didFinish å›žè°ƒä¸­ï¼ˆWebViewController.swift:585-588ï¼‰ï¼Œæ‰€ä»¥
  markWebViewLoadComplete() ä¹Ÿåº”è¯¥åœ¨ä¹‹å‰è¢«è°ƒç”¨äº†ã€‚

  è¯æ® 4ï¼šAI ä¼šè¯åœ¨ ~12 ç§’åŽè¢«æ‰‹åŠ¨ç»“æŸ

  [10:16:04.607] âœ… Auto-starting task
  [10:16:16.690] ðŸ”‡ ç«‹å³åœæ­¢éŸ³é¢‘æ’­æ”¾...
  [10:16:16.696] ðŸ“ž è®°å½•é€šè¯ç»“æŸ: { durationSeconds: 8 }

  ç”¨æˆ·åœ¨ VoIP æœªæŒ‚æ–­çš„æƒ…å†µä¸‹æ‰‹åŠ¨ç»“æŸäº† AI ä¼šè¯ã€‚

  ---
  é—®é¢˜åˆ†æžï¼šä¸ºä»€ä¹ˆ VoIP æ²¡æŒ‚æ–­ï¼Ÿ

  æˆ‘ä»¬ç¡®è®¤å¯ä»¥æŽ’é™¤çš„

  1. ~~å‰ç«¯æ²¡å‘ authConfirmed~~ â†’ æ—¥å¿—è¯æ˜Žå‘äº†
  2. ~~didFinish æ²¡è§¦å‘~~ â†’ VoIP Token æ³¨å…¥è¯æ˜Žè§¦å‘äº†
  3. ~~enableCallKitMode æ²¡è¢«è°ƒç”¨~~ â†’ URL åŒ…å« autostart=trueï¼ŒloadURL() ä¼šè°ƒç”¨

  æ— æ³•ä»…ä»Ž Web æ—¥å¿—åˆ¤æ–­çš„ï¼ˆéœ€è¦ iOS æ—¥å¿—ï¼‰
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚            éœ€è¦ç¡®è®¤çš„çŽ¯èŠ‚            â”‚              å¯¹åº” iOS æ—¥å¿—å…³é”®è¯              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ markAuthConfirmed() æ˜¯å¦è¢« iOS æ”¶åˆ°  â”‚ [CallKitè¯Šæ–­] markAuthConfirmed è¢«è°ƒç”¨        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ markWebViewLoadComplete() æ˜¯å¦è¢«è°ƒç”¨ â”‚ [CallKitè¯Šæ–­] markWebViewLoadComplete è¢«è°ƒç”¨  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ checkAndNotify() æ˜¯å¦æ»¡è¶³æ¡ä»¶        â”‚ WebView å’Œç™»å½•æ€å·²å°±ç»ªï¼Œé€šçŸ¥ CallKit å¯ä»¥æŒ‚æ–­ â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ didActivate æ˜¯å¦è¢«ç³»ç»Ÿè°ƒç”¨           â”‚ CallKit didActivate audioSession              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ handleWebViewReady() æ˜¯å¦è¢«è°ƒç”¨      â”‚ æ”¶åˆ° WebView å°±ç»ªé€šçŸ¥                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ performHangup() æ˜¯å¦è¢«è°ƒç”¨           â”‚ performHangup è¢«è°ƒç”¨                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ endCall(uuid) æ˜¯å¦æˆåŠŸ               â”‚ Failed to end call: (å¤±è´¥æ—¶æ‰“å°)              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ç»å¯¹è¶…æ—¶(8s)æ˜¯å¦è§¦å‘                 â”‚ [å…œåº•] ç»å¯¹è¶…æ—¶è§¦å‘ï¼                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  æœ€å¯èƒ½çš„æ•…éšœç‚¹ï¼ˆæŒ‰å¯èƒ½æ€§æŽ’åºï¼‰

  1. didActivate ä»Žæœªè¢«ç³»ç»Ÿè°ƒç”¨ï¼ˆå¯èƒ½æ€§ï¼šé«˜ï¼‰

  è¿™æ˜¯ä¸€ä¸ª å·²çŸ¥çš„ iOS/CallKit é—®é¢˜ã€‚å½“ç³»ç»Ÿåœ¨ç‰¹å®šçŠ¶æ€ä¸‹ï¼ˆå¦‚å¿«é€ŸæŽ¥å¬åŽç«‹åˆ»åˆ‡åˆ° WebViewï¼‰ï¼ŒdidActivate
   å›žè°ƒå¯èƒ½ä¸ä¼šè¢«è§¦å‘ã€‚

  å½±å“é“¾è·¯ï¼š
  - didActivate ä¸è°ƒç”¨ â†’ audioActivatedTime å§‹ç»ˆä¸º nil
  - handleWebViewReady() è¢«è°ƒç”¨æ—¶ï¼Œå‘çŽ° audioActivatedTime == nil â†’ ç›´æŽ¥
  returnï¼Œä¸æŒ‚æ–­ï¼ˆCallManager.swift:635ï¼‰
  - æ­£å¸¸è¶…æ—¶(5s) æ°¸è¿œä¸ä¼šå¯åŠ¨ï¼ˆå®ƒåœ¨ didActivate é‡Œå¯åŠ¨ï¼‰
  - åªå‰©ç»å¯¹è¶…æ—¶(8s) ä½œä¸ºæœ€åŽé˜²çº¿

  2. ç»å¯¹è¶…æ—¶è§¦å‘äº† performHangup()ï¼Œä½† endCall() å¤±è´¥ï¼ˆå¯èƒ½æ€§ï¼šä¸­ï¼‰

  // CallManager.swift:255-262
  func endCall(uuid: UUID) {
      let endCallAction = CXEndCallAction(uuid: uuid)
      let transaction = CXTransaction(action: endCallAction)
      callController.request(transaction) { error in
          if let error = error {
              print("Failed to end call: \(error)")  // â† ä»…æ‰“å°ï¼Œæ— é‡è¯•ï¼
          }
      }
  }

  å¦‚æžœ CallKit ç³»ç»Ÿæ‹’ç»äº† CXEndCallActionï¼ˆæ¯”å¦‚ didActivate ä»Žæœªè°ƒç”¨å¯¼è‡´é€šè¯çŠ¶æ€å¼‚å¸¸ï¼‰ï¼ŒendCall
  ä¼šå¤±è´¥ï¼Œä¸” æ²¡æœ‰ä»»ä½•é‡è¯•æœºåˆ¶ã€‚

  3. handleWebViewReady å’Œ performHangup çš„æ—¶åºé—®é¢˜ï¼ˆå¯èƒ½æ€§ï¼šä¸­ä½Žï¼‰

  å½“æ­£å¸¸æµç¨‹çš„ performHangup() è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šï¼š
  activeCallUUID = nil           // â† æ¸…ç©º UUID
  absoluteTimeoutWorkItem?.cancel() // â† å–æ¶ˆç»å¯¹è¶…æ—¶
  endCall(uuid: uuid)            // â† å°è¯•æŒ‚æ–­

  å¦‚æžœ endCall å¤±è´¥äº†ï¼ˆæ¯”å¦‚ callController.request æŠ¥é”™ï¼‰ï¼Œæ­¤æ—¶ï¼š
  - activeCallUUID å·²è¢«æ¸…ç©º
  - ç»å¯¹è¶…æ—¶å·²è¢«å–æ¶ˆ
  - æ²¡æœ‰ä»»ä½•æœºåˆ¶å¯ä»¥é‡è¯•æŒ‚æ–­ â†’ VoIP æ°¸è¿œä¸ä¼šè¢«æŒ‚æ–­

  ---
  ç»“è®º

  æ ¸å¿ƒé—®é¢˜ï¼šVoIP æŒ‚æ–­æœºåˆ¶ä¾èµ– CallKit çš„ didActivate å›žè°ƒå’Œ CXEndCallActionï¼Œä½†ï¼š
  1. didActivate å¯èƒ½ä¸è¢«è°ƒç”¨ â†’ æ­£å¸¸æµç¨‹å¤±æ•ˆ
  2. endCall() å¤±è´¥åŽæ— é‡è¯• â†’ å…œåº•ä¹Ÿå¯èƒ½å¤±æ•ˆ
  3. performHangup() æå‰æ¸…ç©ºäº† activeCallUUID å¹¶å–æ¶ˆäº†ç»å¯¹è¶…æ—¶ â†’ ä¸€æ—¦ endCall å¤±è´¥å°±æ²¡æœ‰è¡¥æ•‘æŽªæ–½

  ä¸‹ä¸€æ­¥å»ºè®®ï¼šéœ€è¦ iOS ç«¯çš„ Xcode æŽ§åˆ¶å°æ—¥å¿— æ¥ç¡®è®¤å…·ä½“æ˜¯å“ªä¸ªçŽ¯èŠ‚æ–­äº†ã€‚Web
  æ—¥å¿—åªèƒ½è¯æ˜Žå‰ç«¯æ­£ç¡®å‘é€äº†ä¿¡å·ï¼Œä½†æ— æ³•åˆ¤æ–­ iOS ç«¯æ˜¯å¦æ­£ç¡®æŽ¥æ”¶å’Œå¤„ç†äº†è¿™äº›ä¿¡å·ã€‚


----------------------------------------------------------------------------------------------------------


å¦å¤–ä¸€ä¸ªaiçš„è¯Šæ–­ï¼š
1) å…ˆæŠŠâ€œæŽ¥ç”µè¯â€æ•´æ¡é“¾è·¯æ¢³ç†æ¸…æ¥šï¼ˆiOS / WebView å‰ç«¯ / Supabase åŽç«¯ï¼‰

åŽç«¯ï¼ˆSupabaseï¼‰

æ¥ç”µè¿‡ç¨‹ä¼šå†™å…¥/æ›´æ–° call_records è¡¨ï¼Œå¹¶ç”± Edge Function /functions/v1/manage-call-records è´Ÿè´£æ›´æ–°çŠ¶æ€ã€è®°å½• webview_opened_atã€mic_connected_atã€end_at ç­‰ã€‚
ä»£ç ï¼šindex.ts
iOSï¼ˆCallKit + WebView å®¹å™¨ï¼‰

CallKit çš„â€œæ¥ç”µ UIâ€ä¸»è¦ç”¨é€”æ˜¯ï¼šå¼¹å‡ºæŽ¥å¬ç•Œé¢ + è§£é”å±å¹•/æŠŠç”¨æˆ·å¸¦å›ž Appï¼Œç„¶åŽåœ¨ WebView å°±ç»ªåŽè‡ªåŠ¨æŒ‚æ–­ CallKitï¼ŒæŠŠéŸ³é¢‘æŽ§åˆ¶æƒäº¤ç»™ WebViewï¼ˆå¦åˆ™ä¼šå‡ºçŽ°ä½ è¯´çš„â€œéº¦å…‹é£Ž/è§†é¢‘è¢«å ç”¨â€ï¼‰ã€‚
è‡ªåŠ¨æŒ‚æ–­çš„æ ¸å¿ƒé€»è¾‘åœ¨ï¼š
CallManager æ”¶åˆ° WebViewReadyForCall é€šçŸ¥åŽ -> performHangup() -> CXEndCallAction æŒ‚æ–­
æ–‡ä»¶ï¼šCallManager.swift
WebViewController å†…éƒ¨ç”¨ CallKitReadinessTracker ç­‰å¾…ä¸¤ä¸ªæ¡ä»¶ï¼š
WKWebView didFinishï¼ˆé¡µé¢åŠ è½½å®Œæˆï¼‰
Web ç«¯å‘æ¥çš„ authConfirmedï¼ˆç™»å½•æ€ç¡®è®¤ï¼‰
æ»¡è¶³åŽæ‰å‘ WebViewReadyForCall
æ–‡ä»¶ï¼šWebViewController.swift
æ–‡ä»¶ï¼šCallKitReadinessTracker.swift
å‰ç«¯ï¼ˆWebView é‡Œçš„ React åº”ç”¨ï¼‰

iOS ä¼šæŠŠ Supabase token æ³¨å…¥åˆ° WebViewï¼›Web ç«¯é€šè¿‡ NativeAuth bridge setSession æˆåŠŸåŽï¼Œä¼š postMessage(authConfirmed) å‘Šè¯‰ iOSâ€œç™»å½•æ€å·²ç¡®è®¤ï¼Œåˆ«å†é‡è¯•æ³¨å…¥äº†â€ã€‚
æ–‡ä»¶ï¼šnativeAuthBridge.ts
æ–‡ä»¶ï¼šuseAuthLifecycle.ts
Web ç«¯æ‹¿åˆ° URL å‚æ•°ï¼ˆtask/taskId/callRecordId/autostart=trueï¼‰åŽè‡ªåŠ¨å¯åŠ¨ AI Coachï¼Œä¼šåŽ»è¯·æ±‚éº¦å…‹é£Ž/æ‘„åƒå¤´å¹¶è¿žæŽ¥ Gemini Liveï¼›æˆåŠŸåŽä¼šè°ƒç”¨ manage-call-records è®°å½• webview_opened_atã€mic_connected_atã€‚
2) è¿™ä»½ log.md é‡Œâ€œæœ‰è¯æ®â€çš„äº‹å®ž

è¿™ä»½ log æ˜¯ WebView å†…çš„å‰ç«¯æŽ§åˆ¶å°æ—¥å¿—ï¼Œå®ƒèƒ½è¯æ˜Ž Web ç«¯é“¾è·¯æ˜¯é€šçš„ï¼Œä½†çœ‹ä¸åˆ° CallKit æ˜¯å¦çœŸçš„æŒ‚æ–­ï¼ˆé‚£å¿…é¡»çœ‹ Xcode/iOS åŽŸç”Ÿæ—¥å¿—ï¼‰ã€‚

ä»Ž log é‡Œèƒ½ç›´æŽ¥è¯»åˆ°çš„å…³é”®èŠ‚ç‚¹ï¼š

10:16:04.431ï¼šWeb å‘å‡ºäº† authConfirmedï¼ˆæ—¥å¿—åŽŸæ–‡ï¼šðŸ” Web: å·²é€šçŸ¥ Native åœæ­¢é‡è¯•, reason: session_setï¼‰
10:16:04.607ï¼šiOS æ³¨å…¥äº† VoIP tokenï¼ˆæ—¥å¿—åŽŸæ–‡ï¼šâœ“ VoIP Token injectedï¼Œå¯¹åº” iOS æ³¨å…¥è„šæœ¬åœ¨ ScriptManager.swiftï¼‰
10:16:05.724 ~ 10:16:05.730ï¼šéº¦å…‹é£Žæƒé™é€šè¿‡å¹¶å¯åŠ¨ï¼ŒéšåŽè®°å½•äº† mic_connected_at
10:16:08.480 ~ 10:16:08.487ï¼šGemini Live connectedï¼ŒAI Coach session started
10:16:16.696ï¼šWeb ç«¯ä¸»åŠ¨ç»“æŸä¼šè¯å¹¶æ¸…ç†ï¼šMicrophone stopped / Camera stopped / AudioContext closed / Gemini Live disconnected
åŒæ—¶æˆ‘ç”¨è¿™æ¬¡ log é‡Œçš„ callRecordId=fa364fc6-cf01-48a5-a26c-57f846db416e æŸ¥äº†æ•°æ®åº“ï¼ˆcall_records_detail è§†å›¾ï¼‰ï¼š

call_result = success
webview_opened_atã€mic_connected_atã€end_at éƒ½å·²å†™å…¥ï¼Œduration_seconds=8
è¿™è¯´æ˜Ž åŽç«¯è§†è§’è¿™æ¬¡æ˜¯â€œæ­£å¸¸é€šè¯â€ï¼Œå¹¶æ²¡æœ‰ä½“çŽ°ä½ æè¿°çš„â€œWebView æ— æ³•è¿žæŽ¥ï¼ˆmic_connected_at ä¸ºç©ºï¼‰â€ã€‚
3) åŸºäºŽçŽ°æœ‰è¯æ®ï¼šé—®é¢˜æ›´å¯èƒ½åœ¨å“ªä¸€æ®µï¼Ÿ

è¿™ä»½ log æ²¡æœ‰å‡ºçŽ° getUserMedia å¤±è´¥ã€Mic å¯åŠ¨å¤±è´¥ã€è¿žæŽ¥å¤±è´¥ä¹‹ç±»çš„é”™è¯¯ï¼›ç›¸åå®ƒæ˜¾ç¤º Mic/Camera/Gemini Live éƒ½æˆåŠŸäº†ï¼Œå¹¶ä¸” Web ç«¯è‡ªå·±ä¹Ÿåšäº†æ¸…ç†ã€‚
æ‰€ä»¥ä½ çŽ°åœ¨æè¿°çš„â€œVoIP ä¸è‡ªåŠ¨æŒ‚æ–­ã€åŽå°ç»§ç»­å ç”¨èµ„æºâ€è¿™ä»¶äº‹ï¼Œæ— æ³•ä»…ç”¨è¿™ä»½ Web log ç›´æŽ¥å®šè´£ï¼›å®ƒæœ€å…³é”®çš„è¯æ®åœ¨ iOS åŽŸç”Ÿä¾§ï¼šCallManager æœ‰æ²¡æœ‰èµ°åˆ° handleWebViewReady() å’Œ performHangup()ã€‚
æ¢å¥è¯è¯´ï¼šWeb ç«¯å·²ç»æŠŠ iOS éœ€è¦çš„å…³é”®è§¦å‘ä¿¡å· authConfirmed å‘å‡ºåŽ»äº†ï¼›å¦‚æžœ CallKit ä»ä¸æŒ‚æ–­ï¼Œä¼˜å…ˆæ€€ç–‘ iOS çš„è¿™æ¡é“¾è·¯é‡ŒæŸä¸€æ­¥æ²¡å‘ç”Ÿ/å¤±è´¥äº†ï¼š

WebViewReadyForCall é€šçŸ¥æ²¡å‘å‡ºï¼ˆReadinessTracker æ²¡æ»¡è¶³æ¡ä»¶ï¼‰
é€šçŸ¥å‘å‡ºäº†ä½† CallManager æ²¡æ”¶åˆ°ï¼ˆobserver æ²¡ç”Ÿæ•ˆ/è¢«è¦†ç›–ï¼‰
æ”¶åˆ°äº†ä½† didActivate/performHangup æ²¡è·‘åˆ°ï¼ˆæ—¶åº/ç³»ç»Ÿå›žè°ƒç¼ºå¤±ï¼‰
CXEndCallAction å‘èµ·å¤±è´¥ï¼ˆéœ€è¦çœ‹ CallKit transaction failed ä¹‹ç±»æ—¥å¿—ï¼‰
4) ä¸‹ä¸€æ­¥ä½ éœ€è¦è¡¥çš„â€œè¯æ®â€ï¼ˆä¸æ”¹ä»£ç ï¼‰

è¯·ä½ æŠŠ åŒä¸€æ¬¡æ¥ç”µ çš„ Xcode æŽ§åˆ¶å°æ—¥å¿—è´´å‡ºæ¥ï¼Œè‡³å°‘åŒ…å«ä¸‹é¢ä»»æ„ä¸€ç»„å…³é”®å­—ï¼ˆæœ‰å“ªä¸ªè´´å“ªä¸ªï¼‰ï¼š

ðŸ“± ========== æ”¶åˆ° WebView å°±ç»ªé€šçŸ¥ ========== æˆ– performHangup è¢«è°ƒç”¨ï¼ˆCallManagerï¼‰
[CallKitè¯Šæ–­] markWebViewLoadComplete / markAuthConfirmed / WebView å’Œç™»å½•æ€å·²å°±ç»ªï¼ˆCallKitReadinessTrackerï¼‰
CallKit didActivate audioSession / CallKit didDeactivate audioSession / CallKit transaction failed
æœ‰äº†è¿™æ®µ iOS æ—¥å¿—ï¼Œå°±èƒ½æŠŠâ€œä¸ºä»€ä¹ˆæ²¡è‡ªåŠ¨æŒ‚æ–­â€ä»ŽçŒœæµ‹å˜æˆå¯è¯ä¼ªçš„ç»“è®ºã€‚


------------------------

ç¬¬äºŒä¸ªaiå¯¹äºŽç¬¬ä¸€ä¸ªaiçš„å›žå¤ï¼š
è¿™ä»½è¯Šæ–­çš„â€œä¸»æµç¨‹å›¾â€å’Œâ€œéœ€è¦ iOS æ—¥å¿—æ‰èƒ½å®šè´£â€ç»“è®ºåŸºæœ¬æ˜¯å¯¹çš„ï¼›æˆ‘è§‰å¾—å®ƒè¿˜æ¼äº†å‡ ä¸ªå…³é”®ç‚¹ï¼ˆæˆ–è¯æ®å¼ºåº¦ä¸å¤Ÿï¼‰ï¼š

âœ“ VoIP Token injected ä¸èƒ½å½“ä½œ didFinish çš„ç¡¬è¯æ®
iOS é‡Œæ³¨å…¥ VoIP token æœ‰ä¸¤æ¡è·¯å¾„ï¼š

setupVoIPTokenObserver() é‡Œå¦‚æžœæœ¬åœ°å·²æœ‰ tokenï¼Œä¼šåœ¨ viewDidLoad ç›´æŽ¥ injectVoIPToken()ï¼ˆWebViewController.swift (lines 368-373)ï¼‰ã€‚
WKNavigationDelegate.didFinish é‡Œä¹Ÿä¼šæ³¨å…¥ï¼ˆWebViewController.swift (lines 576-589)ï¼‰ã€‚
æ‰€ä»¥ä»…å‡­è¿™æ¡ log ä¸èƒ½åæŽ¨ markWebViewLoadComplete() ä¸€å®šå‘ç”Ÿã€‚
VAD volume=0 å¹¶ä¸èƒ½å•ç‹¬è¯æ˜Žâ€œéº¦å…‹é£Žè¢« CallKit å ç”¨â€
ä½ ä»¬çš„ VAD æ˜¯æŠŠ getByteFrequencyData çš„å¸¦é€šå¹³å‡å€¼å–æ•´ï¼›äººåœ¨ä¸è¯´è¯æ—¶é•¿æ—¶é—´ä¸º 0 å®Œå…¨æ­£å¸¸ï¼ˆuseVoiceActivityDetection.tsï¼‰ã€‚
åªæœ‰åœ¨ä½ ç¡®å®šå½“æ—¶â€œåœ¨è¯´è¯/æ‹æ‰‹â€ä»æŒç»­ 0ï¼Œæ‰æ›´åƒâ€œéŸ³é¢‘æ•°æ®æ²¡è¿›æ¥â€ï¼Œéœ€è¦ç»“åˆ iOS çš„ AVAudioSession è·¯ç”±/é…ç½®æ—¥å¿—ä¸€èµ·åˆ¤æ–­ã€‚

æ›´å®¹æ˜“è¢«å¿½ç•¥çš„é«˜é£Žé™©ç‚¹ï¼šCallManager.configureDelegate() å¯èƒ½è¢«é‡å¤è°ƒç”¨ï¼Œå¯¼è‡´ CXProvider è¢«æ›¿æ¢
ä»£ç é‡Œè‡³å°‘ä¸¤å¤„ä¼šè°ƒç”¨ CallManager.shared.configureDelegate()ï¼š

AppDelegateï¼ˆAppDelegate.swift (lines 44-46)ï¼‰
AppCoordinator.start(in:)ï¼ˆAppCoordinator.swift (lines 19-24)ï¼‰
å¦å¤– presentWebExperience åœ¨ tabController == nil æ—¶ä¼šè°ƒç”¨ start(in:)ï¼ˆAppCoordinator.swift (lines 450-453)ï¼‰ï¼Œè¿™ä¼šé‡æ–°åˆ›å»º CXProviderï¼ˆCallManager.swift (lines 150-156)ï¼‰ã€‚
å¦‚æžœä¸€æ¬¡æ¥ç”µç”Ÿå‘½å‘¨æœŸé‡Œå‘ç”Ÿäº†â€œprovider è¢«é‡å»º/è¢«æ›¿æ¢â€ï¼Œå°±å¯èƒ½å‡ºçŽ°â€œæŽ¥å¬/æŒ‚æ–­ delegate ä¸å›žè°ƒã€æŒ‚æ–­åŠ¨ä½œå¤±æ•ˆâ€ç­‰ç—‡çŠ¶ï¼Œç±»ä¼¼å¸¸è§çš„â€œprovider/delegate æ²¡è¢«æ­£ç¡®æŒæœ‰å¯¼è‡´å›žè°ƒä¸è§¦å‘â€ã€‚ (stackoverflow.com)
ä¸¤å±‚è¶…æ—¶ï¼ˆ5s/8sï¼‰éƒ½æ˜¯ä¸»çº¿ç¨‹è°ƒåº¦ï¼Œä¸»çº¿ç¨‹å¡ä½ä¼šè®©ä½ ä»¥ä¸ºâ€œå…œåº•æ²¡è§¦å‘â€
ä¾‹å¦‚ç»å¯¹è¶…æ—¶æ˜¯ DispatchQueue.main.asyncAfterï¼ˆCallManager.swift (lines 401-430)ï¼‰ã€‚å¦‚æžœæŽ¥å¬è·³è½¬æœŸé—´ä¸»çº¿ç¨‹è¢«é•¿æ—¶é—´é˜»å¡žï¼Œè¶…æ—¶å›žè°ƒä¼šæ•´ä½“å»¶åŽã€‚

æ•°æ®åº“ call_records.end_at/duration_seconds ä¸èƒ½è¯æ˜Ž CallKit ä¸€å®šæŒ‚æ–­
å› ä¸ºå‰ç«¯ Web è‡ªå·±ä¹Ÿä¼šè°ƒç”¨åŽç«¯åŽ»è®°å½• end_callï¼ˆä½ è¿™ä»½ log é‡Œå°±æœ‰â€œè®°å½•é€šè¯ç»“æŸâ€ï¼‰ï¼Œæ‰€ä»¥ DB æ›´åƒâ€œä¸šåŠ¡ä¼šè¯ç»“æŸâ€ï¼Œä¸ç­‰ä»·äºŽâ€œç³»ç»Ÿç”µè¯ç»“æŸâ€ã€‚

â€œdidActivate ä¸å›žè°ƒ / transaction å¤±è´¥â€ç¡®å®žæ˜¯æœ‰äººé‡åˆ°è¿‡çš„å‘ï¼Œä½†éœ€è¦ç”¨ä½ ä»¬ iOS log éªŒè¯å‘½ä¸­å“ªä¸€ç§
æœ‰äººæŠ¥å‘Š didActivate ä¸å›žè°ƒï¼Œå¹¶ç”¨â€œåœ¨ reportNewIncomingCall å‰å…ˆæ¿€æ´»é€šè¯éŸ³é¢‘ä¼šè¯â€è§£å†³ã€‚ (stackoverflow.com)
ä¹Ÿæœ‰äººé‡åˆ° CXCallController.request æŠ¥ com.apple.CallKit.error.requesttransaction Code=6 (invalidAction)ï¼Œç»™å‡ºçš„ workaround æ˜¯â€œåŽå°å…ˆè®©éŸ³é¢‘å¼•æ“Žå¤„äºŽæ’­æ”¾æ€ï¼ˆç”šè‡³æ’­é™éŸ³ï¼‰/æˆ–å»¶è¿Ÿ 0.1s å† requestâ€ã€‚ (stackoverflow.com)

å¦‚æžœä½ æŠŠâ€œå‡ºçŽ°é—®é¢˜é‚£æ¬¡â€çš„ Xcode æŽ§åˆ¶å°æ—¥å¿—è´´ä¸€æ®µï¼ˆè¿‡æ»¤å…³é”®è¯ï¼šconfigureDelegateã€CXAnswerCallActionã€didActivateã€[å…œåº•] ç»å¯¹è¶…æ—¶è§¦å‘ã€performHangupã€CallKit transaction failedã€com.apple.CallKit.error.requesttransactionã€AVAudioSession é…ç½®å¤±è´¥ï¼‰ï¼Œæˆ‘å°±èƒ½æŠŠä»¥ä¸Šå“ªæ¡çœŸæ­£å‘½ä¸­ç”¨è¯æ®é”æ­»ã€‚

--------
 VoIP æœªæŒ‚æ–­ Bug - è‡ªåŠ¨è¯Šæ–­ä¸ŠæŠ¥ç³»ç»Ÿ                                                              â”‚
â”‚                                                                                                 â”‚
â”‚ Context                                                                                         â”‚
â”‚                                                                                                 â”‚
â”‚ VoIP æ¥ç”µæŽ¥å¬åŽè·³è½¬åˆ° WebView AI Coach ä¼šè¯ï¼ŒCallKit                                            â”‚
â”‚ åº”è‡ªåŠ¨æŒ‚æ–­ä½†å¶çŽ°ä¸æŒ‚æ–­çš„æƒ…å†µï¼Œå¯¼è‡´éŸ³é¢‘è¢«å ç”¨ã€‚è¯¥ bug æ— æ³•ç¨³å®šå¤çŽ°ï¼Œä¸”ç”Ÿäº§çŽ¯å¢ƒçœ‹ä¸åˆ° iOS         â”‚
â”‚ åŽŸç”Ÿæ—¥å¿—ï¼ˆåªèƒ½çœ‹ WebView æ—¥å¿—ï¼‰ã€‚                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ ç›®æ ‡ï¼šåœ¨ä¸‰ç«¯ï¼ˆiOS / Web / åŽç«¯ï¼‰åŸ‹å…¥è‡ªåŠ¨è¯Šæ–­æŽ¢é’ˆï¼Œä¸‹æ¬¡å‡ºçŽ°æ—¶è‡ªåŠ¨é‡‡é›†è¯æ®å¹¶ä¸ŠæŠ¥åˆ° Supabaseã€‚     â”‚
â”‚                                                                                                 â”‚
â”‚ ---                                                                                             â”‚
â”‚ æ•´ä½“æ•°æ®æµ                                                                                      â”‚
â”‚                                                                                                 â”‚
â”‚ iOS CallKit å…³é”®èŠ‚ç‚¹                                                                            â”‚
â”‚   â†’ æ”¶é›†ç»“æž„åŒ–è¯Šæ–­äº‹ä»¶ï¼ˆCallKitDiagnosticCollectorï¼‰                                            â”‚
â”‚   â†’ å¼‚å¸¸æ—¶é€šè¿‡ evaluateJavaScript å‘é€ CustomEvent åˆ° WebView                                   â”‚
â”‚        â†“                                                                                        â”‚
â”‚ Web å‰ç«¯                                                                                        â”‚
â”‚   â‘  ç›‘å¬ iOS è¯Šæ–­äº‹ä»¶ï¼ˆcallKitDiagnosticï¼‰                                                      â”‚
â”‚   â‘¡ è‡ªèº«æ£€æµ‹éŸ³é¢‘å¼‚å¸¸ï¼ˆvolume=0 æŒç»­ 5s+ï¼‰                                                       â”‚
â”‚   â†’ ä¸¤ç§æƒ…å†µéƒ½è°ƒç”¨ manage-call-records ä¸ŠæŠ¥                                                     â”‚
â”‚        â†“                                                                                        â”‚
â”‚ åŽç«¯ Supabase                                                                                   â”‚
â”‚   â†’ call_records.diagnostic_data (JSONB) å­˜å‚¨è¯Šæ–­æ•°æ®                                           â”‚
â”‚                                                                                                 â”‚
â”‚ ---                                                                                             â”‚
â”‚ æ”¹åŠ¨ä¸€è§ˆ                                                                                        â”‚
â”‚ ç«¯: åŽç«¯                                                                                        â”‚
â”‚ ä»“åº“: Lumi-backend                                                                              â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: æ–°è¿ç§»æ–‡ä»¶ï¼šæ·»åŠ  diagnostic_data JSONB åˆ—                                             â”‚
â”‚ ç±»åž‹: æ–°æ–‡ä»¶                                                                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ç«¯: åŽç«¯                                                                                        â”‚
â”‚ ä»“åº“: Lumi-backend                                                                              â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: manage-call-records/index.tsï¼šæ–°å¢ž report_diagnostic action                           â”‚
â”‚ ç±»åž‹: ä¿®æ”¹                                                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ç«¯: iOS                                                                                         â”‚
â”‚ ä»“åº“: mindboat-ios-web-warpper                                                                  â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: æ–°æ–‡ä»¶ CallKitDiagnosticCollector.swift                                               â”‚
â”‚ ç±»åž‹: æ–°æ–‡ä»¶                                                                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ç«¯: iOS                                                                                         â”‚
â”‚ ä»“åº“: mindboat-ios-web-warpper                                                                  â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: CallManager.swiftï¼šå…³é”®è·¯å¾„åŠ è¯Šæ–­åŸ‹ç‚¹ + ä¿®å¤ bug                                      â”‚
â”‚ ç±»åž‹: ä¿®æ”¹                                                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ç«¯: iOS                                                                                         â”‚
â”‚ ä»“åº“: mindboat-ios-web-warpper                                                                  â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: æ–°æ–‡ä»¶ CallKitMessageHandler.swift                                                    â”‚
â”‚ ç±»åž‹: æ–°æ–‡ä»¶                                                                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ç«¯: iOS                                                                                         â”‚
â”‚ ä»“åº“: mindboat-ios-web-warpper                                                                  â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: WebViewController.swiftï¼šæ³¨å†Œæ–° handler + æ·»åŠ è¯Šæ–­æ´¾å‘æ–¹æ³•                            â”‚
â”‚ ç±»åž‹: ä¿®æ”¹                                                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ç«¯: Web                                                                                         â”‚
â”‚ ä»“åº“: Lumi-front-end                                                                            â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: æ–°æ–‡ä»¶ src/lib/callkit-diagnostic.ts                                                  â”‚
â”‚ ç±»åž‹: æ–°æ–‡ä»¶                                                                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ç«¯: Web                                                                                         â”‚
â”‚ ä»“åº“: Lumi-front-end                                                                            â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: src/hooks/ai-coach/useSessionLifecycle.tsï¼šæŽ¥å…¥è¯Šæ–­æ£€æµ‹                               â”‚
â”‚ ç±»åž‹: ä¿®æ”¹                                                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ç«¯: Web                                                                                         â”‚
â”‚ ä»“åº“: Lumi-front-end                                                                            â”‚
â”‚ æ”¹åŠ¨æ–‡ä»¶: src/hooks/useVoiceActivityDetection.tsï¼šæ·»åŠ  volume=0 å›žè°ƒ                            â”‚
â”‚ ç±»åž‹: ä¿®æ”¹                                                                                      â”‚
â”‚ ---                                                                                             â”‚
â”‚ Step 1ï¼šåŽç«¯ - æ‰©å±• call_records è¡¨ + manage-call-records                                       â”‚
â”‚                                                                                                 â”‚
â”‚ 1a. æ–°å»ºè¿ç§»æ–‡ä»¶                                                                                â”‚
â”‚                                                                                                 â”‚
â”‚ æ–‡ä»¶: ../Lumi-backend/supabase/migrations/YYYYMMDDHHMMSS_add_call_diagnostic_data.sql           â”‚
â”‚                                                                                                 â”‚
â”‚ -- ä¸º call_records è¡¨æ·»åŠ è¯Šæ–­æ•°æ®åˆ—                                                             â”‚
â”‚ ALTER TABLE public.call_records                                                                 â”‚
â”‚   ADD COLUMN IF NOT EXISTS diagnostic_data JSONB DEFAULT '{}';                                  â”‚
â”‚                                                                                                 â”‚
â”‚ -- æ·»åŠ æ³¨é‡Š                                                                                     â”‚
â”‚ COMMENT ON COLUMN public.call_records.diagnostic_data IS 'é€šè¯è¯Šæ–­æ•°æ®ï¼Œç”¨äºŽæŽ’æŸ¥ VoIP           â”‚
â”‚ æœªæŒ‚æ–­ç­‰å¼‚å¸¸';                                                                                  â”‚
â”‚                                                                                                 â”‚
â”‚ 1b. æ‰©å±• manage-call-records                                                                    â”‚
â”‚                                                                                                 â”‚
â”‚ æ–‡ä»¶: ../Lumi-backend/supabase/functions/manage-call-records/index.ts                           â”‚
â”‚                                                                                                 â”‚
â”‚ æ–°å¢ž report_diagnostic actionï¼š                                                                 â”‚
â”‚ - æŽ¥æ”¶ call_record_id + diagnostic_data (JSON å¯¹è±¡)                                             â”‚
â”‚ - ä½¿ç”¨ JSONB åˆå¹¶ï¼ˆdiagnostic_data || new_dataï¼‰ï¼Œä¸è¦†ç›–å·²æœ‰æ•°æ®                                â”‚
â”‚ - è®°å½• reported_at æ—¶é—´æˆ³                                                                       â”‚
â”‚                                                                                                 â”‚
â”‚ è¯·æ±‚ä½“ç¤ºä¾‹ï¼š                                                                                    â”‚
â”‚ {                                                                                               â”‚
â”‚   "action": "report_diagnostic",                                                                â”‚
â”‚   "call_record_id": "uuid",                                                                     â”‚
â”‚   "diagnostic_data": {                                                                          â”‚
â”‚     "source": "ios_callkit",                                                                    â”‚
â”‚     "reported_at": "ISO8601",                                                                   â”‚
â”‚     "events": [                                                                                 â”‚
â”‚       { "event": "answer_call", "ts": "ISO8601" },                                              â”‚
â”‚       { "event": "did_activate", "ts": "ISO8601" },                                             â”‚
â”‚       { "event": "webview_ready", "ts": "ISO8601" },                                            â”‚
â”‚       { "event": "perform_hangup", "ts": "ISO8601" },                                           â”‚
â”‚       { "event": "end_call_failed", "ts": "ISO8601", "error": "..." }                           â”‚
â”‚     ],                                                                                          â”‚
â”‚     "flags": {                                                                                  â”‚
â”‚       "didActivateCalled": false,                                                               â”‚
â”‚       "webViewReady": true,                                                                     â”‚
â”‚       "absoluteTimeoutTriggered": true,                                                         â”‚
â”‚       "endCallFailed": true                                                                     â”‚
â”‚     }                                                                                           â”‚
â”‚   }                                                                                             â”‚
â”‚ }                                                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ ä¹Ÿæ”¯æŒä¸å¸¦ call_record_id çš„ä¸ŠæŠ¥ï¼ˆWeb ç«¯æ£€æµ‹åˆ°éŸ³é¢‘å¼‚å¸¸ä½†å¯èƒ½æ²¡æœ‰ callRecordId                   â”‚
â”‚ çš„åœºæ™¯ï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹å†™å…¥ä¸€ä¸ªé€šç”¨çš„ diagnostic è¡¨æˆ–ç›´æŽ¥ç”¨ edge function log è®°å½•ã€‚               â”‚
â”‚                                                                                                 â”‚
â”‚ å®žé™…å®žçŽ°ï¼šå¦‚æžœæ²¡æœ‰ call_record_idï¼Œä»ç„¶è¿”å›žæˆåŠŸä½†åªåœ¨ edge function æ—¥å¿—ä¸­è®°å½•ï¼ˆSupabase        â”‚
â”‚ dashboard å¯æŸ¥çœ‹ï¼‰ã€‚                                                                            â”‚
â”‚                                                                                                 â”‚
â”‚ ---                                                                                             â”‚
â”‚ Step 2ï¼šiOS ç«¯ - è¯Šæ–­æ”¶é›†å™¨ + CallKit åŸ‹ç‚¹ + Bug ä¿®å¤                                           â”‚
â”‚                                                                                                 â”‚
â”‚ 2a. æ–°å»º CallKitDiagnosticCollector.swift                                                       â”‚
â”‚                                                                                                 â”‚
â”‚ æ–‡ä»¶: ../mindboat-ios-web-warpper/MindBoat/CallKit/CallKitDiagnosticCollector.swift             â”‚
â”‚                                                                                                 â”‚
â”‚ è½»é‡çº§è¯Šæ–­æ”¶é›†å™¨ï¼Œä¸å— #if DEBUG é™åˆ¶ï¼Œç”Ÿäº§çŽ¯å¢ƒä¹Ÿå·¥ä½œï¼š                                         â”‚
â”‚                                                                                                 â”‚
â”‚ final class CallKitDiagnosticCollector {                                                        â”‚
â”‚     static let shared = CallKitDiagnosticCollector()                                            â”‚
â”‚                                                                                                 â”‚
â”‚     struct DiagEvent {                                                                          â”‚
â”‚         let event: String                                                                       â”‚
â”‚         let timestamp: Date                                                                     â”‚
â”‚         let detail: String?                                                                     â”‚
â”‚     }                                                                                           â”‚
â”‚                                                                                                 â”‚
â”‚     private(set) var events: [DiagEvent] = []                                                   â”‚
â”‚     private(set) var flags: [String: Bool] = [:]                                                â”‚
â”‚                                                                                                 â”‚
â”‚     func reset() { events.removeAll(); flags.removeAll() }                                      â”‚
â”‚     func record(_ event: String, detail: String? = nil) { ... }                                 â”‚
â”‚     func setFlag(_ key: String, _ value: Bool) { ... }                                          â”‚
â”‚                                                                                                 â”‚
â”‚     /// å¯¼å‡ºä¸º JSON å­—å…¸ï¼Œç”¨äºŽå‘é€åˆ° WebView                                                    â”‚
â”‚     func exportAsJSON() -> [String: Any] { ... }                                                â”‚
â”‚ }                                                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ 2b. CallManager.swift æ”¹åŠ¨                                                                      â”‚
â”‚                                                                                                 â”‚
â”‚ å…³é”®è·¯å¾„åŸ‹ç‚¹ï¼ˆåœ¨æ¯ä¸ªå…³é”®å‡½æ•°å¼€å¤´/ç»“å°¾è°ƒç”¨ DiagnosticCollector.record()ï¼‰ï¼š                      â”‚
â”‚ ä½ç½®: CXAnswerCallAction (line ~310)                                                            â”‚
â”‚ äº‹ä»¶å: answer_call                                                                             â”‚
â”‚ è¯´æ˜Ž: ç”¨æˆ·æŽ¥å¬                                                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ä½ç½®: startAbsoluteTimeoutTimer (line ~403)                                                     â”‚
â”‚ äº‹ä»¶å: absolute_timeout_started                                                                â”‚
â”‚ è¯´æ˜Ž: å…œåº•è®¡æ—¶å™¨å¯åŠ¨                                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ä½ç½®: didActivate (line ~562)                                                                   â”‚
â”‚ äº‹ä»¶å: did_activate                                                                            â”‚
â”‚ è¯´æ˜Ž: ç³»ç»Ÿå›žè°ƒ                                                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ä½ç½®: handleWebViewReady (line ~624)                                                            â”‚
â”‚ äº‹ä»¶å: webview_ready                                                                           â”‚
â”‚ è¯´æ˜Ž: WebView å°±ç»ªé€šçŸ¥æ”¶åˆ°                                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ä½ç½®: performHangup (line ~664)                                                                 â”‚
â”‚ äº‹ä»¶å: perform_hangup                                                                          â”‚
â”‚ è¯´æ˜Ž: å¼€å§‹æŒ‚æ–­                                                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ä½ç½®: endCall æˆåŠŸ/å¤±è´¥                                                                         â”‚
â”‚ äº‹ä»¶å: end_call_success / end_call_failed                                                      â”‚
â”‚ è¯´æ˜Ž: æŒ‚æ–­ç»“æžœ                                                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚ ä½ç½®: ç»å¯¹è¶…æ—¶è§¦å‘ (line ~420)                                                                  â”‚
â”‚ äº‹ä»¶å: absolute_timeout_fired                                                                  â”‚
â”‚ è¯´æ˜Ž: å…œåº•è§¦å‘                                                                                  â”‚
â”‚ Bug ä¿®å¤ 1ï¼šperformHangup çŠ¶æ€æ¸…ç†é¡ºåº                                                          â”‚
â”‚                                                                                                 â”‚
â”‚ å½“å‰ä»£ç ï¼ˆæœ‰é—®é¢˜ï¼‰ï¼š                                                                            â”‚
â”‚ activeCallUUID = nil        // â† å…ˆæ¸…ç©º                                                         â”‚
â”‚ absoluteTimeoutWorkItem?.cancel()  // â† å†å–æ¶ˆè¶…æ—¶                                              â”‚
â”‚ endCall(uuid: uuid)         // â† æœ€åŽè°ƒ endCallï¼ˆå¦‚æžœå¤±è´¥ï¼Œuuid å·²ä¸¢å¤±æ— æ³•é‡è¯•ï¼‰                â”‚
â”‚                                                                                                 â”‚
â”‚ ä¿®å¤åŽï¼š                                                                                        â”‚
â”‚ let uuid = activeCallUUID!  // å…ˆä¿å­˜                                                           â”‚
â”‚ endCall(uuid: uuid)         // å…ˆè°ƒ endCall                                                     â”‚
â”‚ // endCall çš„å›žè°ƒï¼ˆCXEndCallActionï¼‰ä¸­å†æ¸…ç†çŠ¶æ€                                                â”‚
â”‚                                                                                                 â”‚
â”‚ Bug ä¿®å¤ 2ï¼šendCall å¤±è´¥é‡è¯•                                                                    â”‚
â”‚                                                                                                 â”‚
â”‚ åœ¨ request(transaction:) çš„ error å›žè°ƒä¸­ï¼Œå¦‚æžœæ˜¯ endCall å¤±è´¥ï¼š                                 â”‚
â”‚ - å»¶è¿Ÿ 0.3s é‡è¯•ä¸€æ¬¡                                                                            â”‚
â”‚ - å¦‚æžœé‡è¯•ä»å¤±è´¥ï¼Œé€šè¿‡ JS Bridge å‘é€è¯Šæ–­äº‹ä»¶åˆ° WebView                                         â”‚
â”‚                                                                                                 â”‚
â”‚ Bug ä¿®å¤ 3ï¼šç»å¯¹è¶…æ—¶ / endCall å¤±è´¥æ—¶æ´¾å‘è¯Šæ–­äº‹ä»¶                                               â”‚
â”‚                                                                                                 â”‚
â”‚ å½“æ£€æµ‹åˆ°å¼‚å¸¸æ—¶ï¼Œé€šè¿‡ WebViewController å‘ WebView æ´¾å‘ callKitDiagnostic äº‹ä»¶ï¼š                 â”‚
â”‚ // CallManager è°ƒç”¨                                                                             â”‚
â”‚ func dispatchDiagnosticToWeb() {                                                                â”‚
â”‚     let diagnosticJSON = CallKitDiagnosticCollector.shared.exportAsJSON()                       â”‚
â”‚     // åºåˆ—åŒ–ä¸º JSON string                                                                     â”‚
â”‚     let script = """                                                                            â”‚
â”‚         window.dispatchEvent(new CustomEvent('callKitDiagnostic', {                             â”‚
â”‚             detail: \(jsonString)                                                               â”‚
â”‚         }));                                                                                    â”‚
â”‚     """                                                                                         â”‚
â”‚     // é€šè¿‡ WebViewController çš„ webView æ‰§è¡Œ                                                   â”‚
â”‚     AppCoordinator.shared.webViewController?.webView.evaluateJavaScript(script)                 â”‚
â”‚ }                                                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ è§¦å‘æ¡ä»¶ï¼ˆä»»æ„ä¸€ä¸ªï¼‰ï¼š                                                                          â”‚
â”‚ 1. ç»å¯¹è¶…æ—¶è¢«è§¦å‘                                                                               â”‚
â”‚ 2. endCall é‡è¯•åŽä»å¤±è´¥                                                                         â”‚
â”‚ 3. didActivate æœªè¢«è°ƒç”¨ï¼ˆåœ¨ç»å¯¹è¶…æ—¶æ—¶æ£€æŸ¥ï¼‰                                                     â”‚
â”‚                                                                                                 â”‚
â”‚ 2c. æ–°å»º CallKitMessageHandler.swift                                                            â”‚
â”‚                                                                                                 â”‚
â”‚ æ–‡ä»¶: ../mindboat-ios-web-warpper/MindBoat/WebView/Handlers/CallKitMessageHandler.swift         â”‚
â”‚                                                                                                 â”‚
â”‚ å¤„ç† Web â†’ iOS çš„ forceEndCallKit æ¶ˆæ¯ï¼š                                                        â”‚
â”‚                                                                                                 â”‚
â”‚ case "forceEndCallKit":                                                                         â”‚
â”‚     let reason = (message.body as? [String: Any])?["reason"] as? String ?? "unknown"            â”‚
â”‚     Logger.call("æ”¶åˆ° forceEndCallKit - åŽŸå› : \(reason)")                                       â”‚
â”‚     CallManager.shared.forceEndCallKit(reason: reason)                                          â”‚
â”‚                                                                                                 â”‚
â”‚ åœ¨ CallManager ä¸­æ·»åŠ å…¬å¼€æ–¹æ³•ï¼š                                                                 â”‚
â”‚ public func forceEndCallKit(reason: String) {                                                   â”‚
â”‚     Logger.call("å¼ºåˆ¶ç»“æŸ CallKit - åŽŸå› : \(reason)")                                           â”‚
â”‚     DiagnosticCollector.shared.record("force_end_from_web", detail: reason)                     â”‚
â”‚     performHangup()  // å¤ç”¨çŽ°æœ‰é€»è¾‘                                                            â”‚
â”‚ }                                                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ 2d. WebViewController.swift æ³¨å†Œ                                                                â”‚
â”‚                                                                                                 â”‚
â”‚ åœ¨ setupMessageHandlers() ä¸­æ³¨å†Œ CallKitMessageHandlerï¼Œæ³¨å†Œ forceEndCallKit åˆ° WKWebView çš„    â”‚
â”‚ userContentControllerã€‚                                                                         â”‚
â”‚                                                                                                 â”‚
â”‚ ---                                                                                             â”‚
â”‚ Step 3ï¼šWeb å‰ç«¯ - è¯Šæ–­ç›‘å¬ + éŸ³é¢‘å¼‚å¸¸æ£€æµ‹ + ä¸ŠæŠ¥                                               â”‚
â”‚                                                                                                 â”‚
â”‚ 3a. æ–°å»º src/lib/callkit-diagnostic.ts                                                          â”‚
â”‚                                                                                                 â”‚
â”‚ æ ¸å¿ƒæ¨¡å—ï¼ŒåŒ…å«ï¼š                                                                                â”‚
â”‚                                                                                                 â”‚
â”‚ 1) iOS è¯Šæ–­äº‹ä»¶ç›‘å¬å™¨ï¼š                                                                         â”‚
â”‚ export function initCallKitDiagnosticListener(): void {                                         â”‚
â”‚   window.addEventListener('callKitDiagnostic', (e: CustomEvent) => {                            â”‚
â”‚     const diagnosticData = e.detail;                                                            â”‚
â”‚     reportDiagnosticToBackend(diagnosticData);                                                  â”‚
â”‚   });                                                                                           â”‚
â”‚ }                                                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ 2) è¯Šæ–­æ•°æ®ä¸ŠæŠ¥å‡½æ•°ï¼š                                                                           â”‚
â”‚ export async function reportDiagnosticToBackend(                                                â”‚
â”‚   diagnosticData: Record<string, unknown>,                                                      â”‚
â”‚   callRecordId?: string                                                                         â”‚
â”‚ ): Promise<void> {                                                                              â”‚
â”‚   const supabase = getSupabaseClient();                                                         â”‚
â”‚   if (!supabase) return;                                                                        â”‚
â”‚                                                                                                 â”‚
â”‚   await supabase.functions.invoke('manage-call-records', {                                      â”‚
â”‚     body: {                                                                                     â”‚
â”‚       action: 'report_diagnostic',                                                              â”‚
â”‚       call_record_id: callRecordId ?? null,                                                     â”‚
â”‚       diagnostic_data: {                                                                        â”‚
â”‚         ...diagnosticData,                                                                      â”‚
â”‚         reported_at: new Date().toISOString(),                                                  â”‚
â”‚       },                                                                                        â”‚
â”‚     },                                                                                          â”‚
â”‚   });                                                                                           â”‚
â”‚ }                                                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ 3) forceEndCallKit æ¡¥æŽ¥å‡½æ•°ï¼š                                                                   â”‚
â”‚ export function forceEndCallKit(reason: string): void {                                         â”‚
â”‚   window.webkit?.messageHandlers?.forceEndCallKit?.postMessage({ reason });                     â”‚
â”‚ }                                                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ 4) éŸ³é¢‘å¼‚å¸¸æ£€æµ‹å™¨ï¼ˆç»™ session lifecycle ç”¨ï¼‰ï¼š                                                  â”‚
â”‚ export function createAudioAnomalyDetector(options: {                                           â”‚
â”‚   callRecordId?: string;                                                                        â”‚
â”‚   onAnomalyDetected?: () => void;                                                               â”‚
â”‚ }): {                                                                                           â”‚
â”‚   reportVolume: (volume: number) => void;                                                       â”‚
â”‚   dispose: () => void;                                                                          â”‚
â”‚ } {                                                                                             â”‚
â”‚   let zeroVolumeStart: number | null = null;                                                    â”‚
â”‚   let reported = false;                                                                         â”‚
â”‚   const THRESHOLD_MS = 5000; // æŒç»­ 5 ç§’ volume=0                                              â”‚
â”‚                                                                                                 â”‚
â”‚   return {                                                                                      â”‚
â”‚     reportVolume(volume: number) {                                                              â”‚
â”‚       if (reported) return;                                                                     â”‚
â”‚       if (volume === 0) {                                                                       â”‚
â”‚         if (!zeroVolumeStart) zeroVolumeStart = Date.now();                                     â”‚
â”‚         if (Date.now() - zeroVolumeStart >= THRESHOLD_MS) {                                     â”‚
â”‚           reported = true;                                                                      â”‚
â”‚           reportDiagnosticToBackend({                                                           â”‚
â”‚             source: 'web_audio_anomaly',                                                        â”‚
â”‚             anomaly: 'zero_volume_5s',                                                          â”‚
â”‚             duration_ms: Date.now() - zeroVolumeStart,                                          â”‚
â”‚           }, options.callRecordId);                                                             â”‚
â”‚           options.onAnomalyDetected?.();                                                        â”‚
â”‚         }                                                                                       â”‚
â”‚       } else {                                                                                  â”‚
â”‚         zeroVolumeStart = null; // ä¸€æ—¦æœ‰å£°éŸ³ï¼Œé‡ç½®                                             â”‚
â”‚       }                                                                                         â”‚
â”‚     },                                                                                          â”‚
â”‚     dispose() { reported = true; },                                                             â”‚
â”‚   };                                                                                            â”‚
â”‚ }                                                                                               â”‚
â”‚                                                                                                 â”‚
â”‚ 3b. useVoiceActivityDetection.ts æ·»åŠ å›žè°ƒ                                                       â”‚
â”‚                                                                                                 â”‚
â”‚ æ·»åŠ ä¸€ä¸ªå¯é€‰çš„ onVolumeReport å›žè°ƒå‚æ•°ï¼Œæ¯ç§’è°ƒç”¨ä¸€æ¬¡ï¼ˆä¸ŽçŽ°æœ‰çš„è¯Šæ–­æ—¥å¿—åŒé¢‘çŽ‡ï¼‰ï¼Œæ–¹ä¾¿å¤–éƒ¨ä½¿ç”¨ã€‚  â”‚
â”‚                                                                                                 â”‚
â”‚ åœ¨çŽ°æœ‰çš„ frameCount % 60 === 1 ä½ç½®ï¼Œé¢å¤–è°ƒç”¨ï¼š                                                 â”‚
â”‚ options.onVolumeReport?.(Math.round(average));                                                  â”‚
â”‚                                                                                                 â”‚
â”‚ 3c. useSessionLifecycle.ts æŽ¥å…¥è¯Šæ–­                                                             â”‚
â”‚                                                                                                 â”‚
â”‚ åœ¨ startSession ä¸­ï¼š                                                                            â”‚
â”‚ - åˆ›å»º audioAnomalyDetectorï¼ˆä¼ å…¥ callRecordIdï¼‰                                                â”‚
â”‚ - åœ¨ cleanup ä¸­ dispose() å®ƒ                                                                    â”‚
â”‚                                                                                                 â”‚
â”‚ éŸ³é¢‘å¼‚å¸¸æ£€æµ‹å™¨çš„ reportVolume é€šè¿‡ VAD hook çš„ onVolumeReport å›žè°ƒå–‚å…¥ã€‚                        â”‚
â”‚                                                                                                 â”‚
â”‚ 3d. åˆå§‹åŒ–å…¥å£                                                                                  â”‚
â”‚                                                                                                 â”‚
â”‚ åœ¨ src/main.tsxï¼ˆæˆ–çŽ°æœ‰ native bridge init çš„åœ°æ–¹ï¼‰è°ƒç”¨ initCallKitDiagnosticListener()ã€‚       â”‚
â”‚                                                                                                 â”‚
â”‚ ---                                                                                             â”‚
â”‚ Step 4ï¼šæ›´æ–° call_records_detail è§†å›¾                                                           â”‚
â”‚                                                                                                 â”‚
â”‚ æ›´æ–°è¯Šæ–­è§†å›¾ï¼Œå¢žåŠ  diagnostic_data å­—æ®µï¼Œå¹¶ä¼˜åŒ– call_result åˆ¤å®šé€»è¾‘ï¼š                          â”‚
â”‚                                                                                                 â”‚
â”‚ -- åœ¨çŽ°æœ‰ CASE åŽåŠ ä¸€ä¸ªæ–°çŠ¶æ€                                                                   â”‚
â”‚ CASE                                                                                            â”‚
â”‚   WHEN cr.diagnostic_data->>'source' = 'ios_callkit' THEN 'voip_hangup_failed'                  â”‚
â”‚   WHEN cr.webview_opened_at IS NULL THEN 'missed'                                               â”‚
â”‚   WHEN cr.mic_connected_at IS NULL THEN 'bug_dropped'                                           â”‚
â”‚   ELSE 'success'                                                                                â”‚
â”‚ END AS call_result                                                                              â”‚
â”‚                                                                                                 â”‚
â”‚ ---                                                                                             â”‚
â”‚ å®žæ–½é¡ºåº                                                                                        â”‚
â”‚                                                                                                 â”‚
â”‚ 1. åŽç«¯ï¼šè¿ç§» + edge functionï¼ˆ10 åˆ†é’Ÿï¼‰                                                        â”‚
â”‚ 2. iOSï¼šè¯Šæ–­æ”¶é›†å™¨ + CallManager åŸ‹ç‚¹ + Bug ä¿®å¤ + Message Handlerï¼ˆ30 åˆ†é’Ÿï¼‰                   â”‚
â”‚ 3. Webï¼šè¯Šæ–­æ¨¡å— + VAD å›žè°ƒ + Session æŽ¥å…¥ + åˆå§‹åŒ–ï¼ˆ20 åˆ†é’Ÿï¼‰                                  â”‚
â”‚ 4. æµ‹è¯•éªŒè¯                                                                                     â”‚
â”‚                                                                                                 â”‚
â”‚ ---                                                                                             â”‚
â”‚ éªŒè¯æ–¹å¼                                                                                        â”‚
â”‚                                                                                                 â”‚
â”‚ ç”±äºŽæ— æ³•å¤çŽ°åŽŸå§‹ bugï¼ŒéªŒè¯åˆ†ä¸¤éƒ¨åˆ†ï¼š                                                            â”‚
â”‚                                                                                                 â”‚
â”‚ åŠŸèƒ½éªŒè¯ï¼ˆæœ¬åœ°å¯åšï¼‰ï¼š                                                                          â”‚
â”‚ 1. æ­£å¸¸ VoIP æ¥ç”µæµç¨‹ â†’ ç¡®è®¤ä¸å½±å“çŽ°æœ‰åŠŸèƒ½                                                      â”‚
â”‚ 2. åœ¨ iOS æ¨¡æ‹Ÿå™¨ä¸­æ‰‹åŠ¨è°ƒç”¨ forceEndCallKit â†’ ç¡®è®¤ JS Bridge é€šè·¯                                â”‚
â”‚ 3. æ‰‹åŠ¨è§¦å‘ report_diagnostic action â†’ ç¡®è®¤æ•°æ®å†™å…¥ call_records.diagnostic_data                â”‚
â”‚ 4. åœ¨ Web DevTools ä¸­æ¨¡æ‹Ÿ callKitDiagnostic äº‹ä»¶ â†’ ç¡®è®¤ç›‘å¬å™¨å·¥ä½œ                               â”‚
â”‚                                                                                                 â”‚
â”‚ ç”Ÿäº§éªŒè¯ï¼ˆç­‰å¾…è‡ªç„¶å¤çŽ°ï¼‰ï¼š                                                                      â”‚
â”‚ - ä¸‹æ¬¡å‡ºçŽ° VoIP æœªæŒ‚æ–­æ—¶ï¼Œæ£€æŸ¥ call_records è¡¨ä¸­å¯¹åº”è®°å½•çš„ diagnostic_data                      â”‚
â”‚ - æ•°æ®åº”åŒ…å« iOS ç«¯çš„äº‹ä»¶æ—¶é—´çº¿ï¼Œå¯ç›´æŽ¥å®šä½æ–­ç‚¹               