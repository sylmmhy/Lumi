<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŸç”Ÿç™»å½•æ¡¥æ¥æµ‹è¯•å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    button {
      background: #007AFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 8px 8px 8px 0;
    }
    button:hover {
      background: #0056b3;
    }
    button.danger {
      background: #FF3B30;
    }
    button.danger:hover {
      background: #cc2f26;
    }
    button.secondary {
      background: #8E8E93;
    }
    button.secondary:hover {
      background: #636366;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 500;
      color: #555;
    }
    .log {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.6;
    }
    .log-entry {
      margin: 4px 0;
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .status {
      padding: 12px;
      border-radius: 4px;
      margin: 12px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <h1>ğŸ” åŸç”Ÿç™»å½•æ¡¥æ¥æµ‹è¯•å·¥å…·</h1>

  <div class="card">
    <h2>ğŸ“ æµ‹è¯•åœºæ™¯</h2>

    <div>
      <h3>åœºæ™¯ 1: å®Œæ•´ Token ç™»å½•ï¼ˆæ¨èï¼‰</h3>
      <p>æ¨¡æ‹Ÿ iOS åŸç”Ÿæä¾›å®Œæ•´çš„ Supabase JWT token</p>
      <label>User ID (UUID):</label>
      <input type="text" id="userId1" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />

      <label>Email:</label>
      <input type="text" id="email1" placeholder="user@example.com" />

      <label>Access Token (JWT):</label>
      <textarea id="accessToken1" rows="3" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."></textarea>

      <label>Refresh Token (JWT):</label>
      <textarea id="refreshToken1" rows="3" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."></textarea>

      <label>Name (å¯é€‰):</label>
      <input type="text" id="name1" placeholder="å¼ ä¸‰" />

      <label>Picture URL (å¯é€‰):</label>
      <input type="text" id="picture1" placeholder="https://example.com/avatar.jpg" />

      <button onclick="testFullLogin()">ğŸš€ è§¦å‘å®Œæ•´ç™»å½•</button>
      <button class="secondary" onclick="fillSample1()">ğŸ“‹ å¡«å……ç¤ºä¾‹æ•°æ®</button>
    </div>

    <hr style="margin: 32px 0; border: none; border-top: 1px solid #e0e0e0;" />

    <div>
      <h3>åœºæ™¯ 2: ä»… UserId/Email ç™»å½•ï¼ˆæ—  Tokenï¼‰</h3>
      <p>æ¨¡æ‹ŸåŸç”Ÿä»…æä¾›ç”¨æˆ·ä¿¡æ¯ï¼Œä¸æä¾› Supabase tokenï¼ˆè°ƒè¯•ç”¨ï¼‰</p>
      <label>User ID (UUID):</label>
      <input type="text" id="userId2" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />

      <label>Email:</label>
      <input type="text" id="email2" placeholder="user@example.com" />

      <label>Name (å¯é€‰):</label>
      <input type="text" id="name2" placeholder="å¼ ä¸‰" />

      <button onclick="testBasicLogin()">ğŸ”‘ è§¦å‘åŸºç¡€ç™»å½•</button>
      <button class="secondary" onclick="fillSample2()">ğŸ“‹ å¡«å……ç¤ºä¾‹æ•°æ®</button>
    </div>

    <hr style="margin: 32px 0; border: none; border-top: 1px solid #e0e0e0;" />

    <div>
      <h3>åœºæ™¯ 3: é¢„æ³¨å…¥æ–¹å¼ï¼ˆwindow å¯¹è±¡ï¼‰</h3>
      <p>æ¨¡æ‹ŸåŸç”Ÿåœ¨é¡µé¢åŠ è½½å‰æ³¨å…¥ <code>window.MindBoatNativeAuth</code></p>
      <button onclick="testPreInjection()">âš¡ é¢„æ³¨å…¥å¹¶åˆ·æ–°é¡µé¢</button>
      <p style="color: #666; font-size: 13px;">ç‚¹å‡»åä¼šåˆ·æ–°é¡µé¢ï¼ŒAuthContext ä¼šåœ¨ DOMContentLoaded æ—¶è‡ªåŠ¨è¯»å–</p>
    </div>

    <hr style="margin: 32px 0; border: none; border-top: 1px solid #e0e0e0;" />

    <div>
      <h3>åœºæ™¯ 4: åŸç”Ÿç™»å‡º</h3>
      <button class="danger" onclick="testNativeLogout()">ğŸšª è§¦å‘åŸç”Ÿç™»å‡º</button>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
    <button onclick="checkStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
    <button class="secondary" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    <div id="statusDisplay"></div>
  </div>

  <div class="card">
    <h2>ğŸ“ æ§åˆ¶å°æ—¥å¿—</h2>
    <div class="log" id="logDisplay"></div>
  </div>

  <script>
    // æ‹¦æˆª console è¾“å‡º
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;

    const logs = [];

    function addLog(type, ...args) {
      const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
      const message = args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      logs.push({ type, timestamp, message });
      updateLogDisplay();
    }

    console.log = (...args) => {
      originalLog(...args);
      addLog('log', ...args);
    };

    console.warn = (...args) => {
      originalWarn(...args);
      addLog('warn', ...args);
    };

    console.error = (...args) => {
      originalError(...args);
      addLog('error', ...args);
    };

    function updateLogDisplay() {
      const logDisplay = document.getElementById('logDisplay');
      logDisplay.innerHTML = logs.slice(-50).reverse().map(log => {
        const color = log.type === 'error' ? '#dc3545' : log.type === 'warn' ? '#ffc107' : '#333';
        return `<div class="log-entry" style="color: ${color}">
          <strong>[${log.timestamp}]</strong> ${log.message}
        </div>`;
      }).join('');
    }

    function clearLogs() {
      logs.length = 0;
      updateLogDisplay();
    }

    // å¡«å……ç¤ºä¾‹æ•°æ®
    function fillSample1() {
      document.getElementById('userId1').value = 'a1234567-b123-c123-d123-e12345678901';
      document.getElementById('email1').value = 'test@firego.app';
      document.getElementById('accessToken1').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c';
      document.getElementById('refreshToken1').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c';
      document.getElementById('name1').value = 'æµ‹è¯•ç”¨æˆ·';
      document.getElementById('picture1').value = 'https://api.dicebear.com/7.x/avataaars/svg?seed=test';
    }

    function fillSample2() {
      document.getElementById('userId2').value = 'a1234567-b123-c123-d123-e12345678901';
      document.getElementById('email2').value = 'test@firego.app';
      document.getElementById('name2').value = 'æµ‹è¯•ç”¨æˆ·';
    }

    // åœºæ™¯ 1: å®Œæ•´ç™»å½•
    function testFullLogin() {
      const payload = {
        userId: document.getElementById('userId1').value,
        email: document.getElementById('email1').value,
        accessToken: document.getElementById('accessToken1').value,
        refreshToken: document.getElementById('refreshToken1').value,
        name: document.getElementById('name1').value,
        pictureUrl: document.getElementById('picture1').value,
      };

      if (!payload.userId) {
        alert('è¯·å¡«å†™ User ID');
        return;
      }

      console.log('ğŸš€ è§¦å‘ mindboat:nativeLogin äº‹ä»¶', payload);
      const event = new CustomEvent('mindboat:nativeLogin', { detail: payload });
      window.dispatchEvent(event);

      setTimeout(checkStatus, 500);
    }

    // åœºæ™¯ 2: åŸºç¡€ç™»å½•
    function testBasicLogin() {
      const payload = {
        userId: document.getElementById('userId2').value,
        email: document.getElementById('email2').value,
        name: document.getElementById('name2').value,
      };

      if (!payload.userId) {
        alert('è¯·å¡«å†™ User ID');
        return;
      }

      console.log('ğŸ”‘ è§¦å‘ mindboat:nativeLogin äº‹ä»¶ï¼ˆæ—  tokenï¼‰', payload);
      const event = new CustomEvent('mindboat:nativeLogin', { detail: payload });
      window.dispatchEvent(event);

      setTimeout(checkStatus, 500);
    }

    // åœºæ™¯ 3: é¢„æ³¨å…¥
    function testPreInjection() {
      const payload = {
        userId: 'a1234567-b123-c123-d123-e12345678901',
        email: 'preinjected@firego.app',
        name: 'é¢„æ³¨å…¥ç”¨æˆ·',
      };

      console.log('âš¡ è®¾ç½® window.MindBoatNativeAuth å¹¶åˆ·æ–°é¡µé¢', payload);
      window.MindBoatNativeAuth = payload;

      // åˆ·æ–°é¡µé¢ä»¥è§¦å‘ DOMContentLoaded é€»è¾‘
      setTimeout(() => {
        location.reload();
      }, 500);
    }

    // åœºæ™¯ 4: ç™»å‡º
    function testNativeLogout() {
      console.log('ğŸšª è§¦å‘ mindboat:nativeLogout äº‹ä»¶');
      const event = new CustomEvent('mindboat:nativeLogout');
      window.dispatchEvent(event);

      setTimeout(checkStatus, 500);
    }

    // æ£€æŸ¥çŠ¶æ€
    function checkStatus() {
      const status = {
        localStorage: {
          user_id: localStorage.getItem('user_id'),
          user_email: localStorage.getItem('user_email'),
          user_name: localStorage.getItem('user_name'),
          session_token: localStorage.getItem('session_token')?.substring(0, 20) + '...',
          refresh_token: localStorage.getItem('refresh_token')?.substring(0, 20) + '...',
          native_login: localStorage.getItem('native_login'),
          is_new_user: localStorage.getItem('is_new_user'),
        },
        window: {
          MindBoatNativeAuth: window.MindBoatNativeAuth,
        }
      };

      const display = document.getElementById('statusDisplay');

      let html = '';

      // åˆ¤æ–­ç™»å½•çŠ¶æ€
      const isNativeLogin = status.localStorage.native_login === 'true';
      const hasSession = !!status.localStorage.session_token && status.localStorage.session_token !== 'null...';
      const hasUserId = !!status.localStorage.user_id && status.localStorage.user_id !== 'null';

      if (isNativeLogin && hasUserId) {
        html += `<div class="status success">
          âœ… <strong>åŸç”Ÿç™»å½•æˆåŠŸ</strong><br>
          ç”¨æˆ·: ${status.localStorage.user_email || status.localStorage.user_id}<br>
          å§“å: ${status.localStorage.user_name || '(æœªè®¾ç½®)'}<br>
          ${hasSession ? 'âœ… å·²åŒæ­¥ Supabase ä¼šè¯' : 'âš ï¸ ä»…å‰ç«¯ç™»å½•æ€ï¼ˆæ—  Supabase tokenï¼‰'}
        </div>`;
      } else if (hasSession && hasUserId) {
        html += `<div class="status success">
          âœ… <strong>å¸¸è§„ç™»å½•çŠ¶æ€</strong><br>
          ç”¨æˆ·: ${status.localStorage.user_email || status.localStorage.user_id}
        </div>`;
      } else if (hasUserId) {
        html += `<div class="status warning">
          âš ï¸ <strong>éƒ¨åˆ†ç™»å½•çŠ¶æ€</strong><br>
          æœ‰ userId ä½†æ—  session_tokenï¼Œå¯èƒ½è¢«è¯¯æ¸…é™¤
        </div>`;
      } else {
        html += `<div class="status info">
          â„¹ï¸ <strong>æœªç™»å½•çŠ¶æ€</strong>
        </div>`;
      }

      // LocalStorage è¯¦æƒ…
      html += '<h3 style="margin-top: 20px;">LocalStorage:</h3>';
      html += '<div style="background: #f9f9f9; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 13px;">';
      for (const [key, value] of Object.entries(status.localStorage)) {
        if (value && value !== 'null' && value !== 'null...') {
          html += `<div><strong>${key}:</strong> ${value}</div>`;
        }
      }
      html += '</div>';

      // Window å¯¹è±¡
      if (status.window.MindBoatNativeAuth) {
        html += '<h3 style="margin-top: 20px;">window.MindBoatNativeAuth:</h3>';
        html += `<div style="background: #f9f9f9; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 13px;">
          <pre>${JSON.stringify(status.window.MindBoatNativeAuth, null, 2)}</pre>
        </div>`;
      }

      display.innerHTML = html;
      console.log('ğŸ“Š å½“å‰çŠ¶æ€', status);
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
    window.addEventListener('DOMContentLoaded', () => {
      checkStatus();
      console.log('âœ… æµ‹è¯•å·¥å…·å·²åŠ è½½');
    });
  </script>
</body>
</html>
