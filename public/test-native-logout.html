<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç”Ÿç™»å‡ºé€šçŸ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #F25F3A;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .section.warning {
            border-left-color: #FF9800;
            background: #fff3e0;
        }
        .section.info {
            border-left-color: #2196F3;
            background: #e3f2fd;
        }
        button {
            background: #F25F3A;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #d94f2a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(0);
        }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #333;
        }
        .log-entry.success {
            color: #4CAF50;
        }
        .log-entry.error {
            color: #f44336;
        }
        .log-entry.info {
            color: #2196F3;
        }
        .log-entry.warning {
            color: #FF9800;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.logged-in {
            background: #4CAF50;
            color: white;
        }
        .status.logged-out {
            background: #f44336;
            color: white;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        code {
            color: #d73a49;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± åŸç”Ÿç™»å‡ºé€šçŸ¥æµ‹è¯•é¡µé¢</h1>

        <div class="section info">
            <h3>ğŸ¯ æµ‹è¯•ç›®çš„</h3>
            <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯• Web ç«¯å‘åŸç”Ÿ App å‘é€ç™»å‡ºé€šçŸ¥çš„æœºåˆ¶ã€‚</p>
            <p>åŸç”Ÿå¼€å‘è€…å¯ä»¥åœ¨ WebView ä¸­åŠ è½½æ­¤é¡µé¢ï¼ŒéªŒè¯æ˜¯å¦èƒ½æ­£ç¡®æ¥æ”¶åˆ°ç™»å‡ºäº‹ä»¶ã€‚</p>
        </div>

        <div class="section">
            <h3>ğŸ”„ å½“å‰çŠ¶æ€ <span id="status" class="status logged-out">æœªç™»å½•</span></h3>
            <p>User ID: <code id="userId">null</code></p>
            <p>Email: <code id="userEmail">null</code></p>
        </div>

        <div class="section">
            <h3>ğŸ§ª æ“ä½œæŒ‰é’®</h3>
            <button onclick="simulateLogin()">1ï¸âƒ£ æ¨¡æ‹Ÿç™»å½•</button>
            <button onclick="triggerLogout()">2ï¸âƒ£ è§¦å‘ç™»å‡ºäº‹ä»¶</button>
            <button onclick="checkStatus()">3ï¸âƒ£ æ£€æŸ¥çŠ¶æ€</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="section warning">
            <h3>âš ï¸ åŸç”Ÿç«¯é›†æˆæç¤º</h3>
            <p><strong>iOS å¼€å‘è€…</strong>ï¼šåœ¨ WKWebView çš„ <code>didFinish</code> ä¸­æ³¨å…¥ç›‘å¬è„šæœ¬ï¼š</p>
            <pre><code>window.addEventListener('mindboat:nativeLogout', function() {
    window.location.href = 'mindboat://logout';
});</code></pre>

            <p style="margin-top: 15px;"><strong>Android å¼€å‘è€…</strong>ï¼šä½¿ç”¨ <code>addJavascriptInterface</code> æ·»åŠ  <code>NativeApp</code> å¯¹è±¡ï¼Œç„¶åæ³¨å…¥ï¼š</p>
            <pre><code>window.addEventListener('mindboat:nativeLogout', function() {
    if (window.NativeApp) {
        window.NativeApp.onLogout();
    }
});</code></pre>
        </div>

        <div class="section">
            <h3>ğŸ“‹ äº‹ä»¶æ—¥å¿—</h3>
            <div id="log"></div>
        </div>

        <div class="section info">
            <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li>ç‚¹å‡» "æ¨¡æ‹Ÿç™»å½•" åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨æˆ·</li>
                <li>ç‚¹å‡» "è§¦å‘ç™»å‡ºäº‹ä»¶" å‘é€ç™»å‡ºé€šçŸ¥</li>
                <li>è§‚å¯ŸåŸç”Ÿç«¯æ˜¯å¦æ”¶åˆ°é€šçŸ¥ï¼ˆæŸ¥çœ‹ Xcode/Android Studio æ—¥å¿—ï¼‰</li>
                <li>ç‚¹å‡» "æ£€æŸ¥çŠ¶æ€" éªŒè¯ localStorage å·²è¢«æ¸…é™¤</li>
            </ol>
        </div>
    </div>

    <script>
        // æ—¥å¿—å·¥å…·
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // æ¨¡æ‹Ÿç™»å½•
        function simulateLogin() {
            const testUser = {
                userId: 'test-' + Math.random().toString(36).substring(7),
                email: 'test@example.com',
                name: 'æµ‹è¯•ç”¨æˆ·'
            };

            localStorage.setItem('user_id', testUser.userId);
            localStorage.setItem('user_email', testUser.email);
            localStorage.setItem('user_name', testUser.name);
            localStorage.setItem('native_login', 'true');

            log('âœ… æ¨¡æ‹Ÿç™»å½•æˆåŠŸ', 'success');
            log(`ç”¨æˆ·ID: ${testUser.userId}`, 'info');
            updateStatus();
        }

        // è§¦å‘ç™»å‡ºäº‹ä»¶
        function triggerLogout() {
            log('ğŸš€ å‡†å¤‡è§¦å‘ mindboat:nativeLogout äº‹ä»¶...', 'info');

            try {
                // 1. æ¸…é™¤ localStorageï¼ˆæ¨¡æ‹ŸçœŸå®ç™»å‡ºé€»è¾‘ï¼‰
                localStorage.removeItem('user_id');
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_name');
                localStorage.removeItem('session_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('native_login');
                log('ğŸ—‘ï¸ localStorage å·²æ¸…é™¤', 'info');

                // 2. è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                const event = new CustomEvent('mindboat:nativeLogout', {
                    bubbles: true,
                    cancelable: false,
                });
                window.dispatchEvent(event);

                log('ğŸ“± å·²è§¦å‘ mindboat:nativeLogout äº‹ä»¶', 'success');
                log('âš ï¸ è¯·æ£€æŸ¥åŸç”Ÿç«¯æ—¥å¿—æ˜¯å¦æ”¶åˆ°é€šçŸ¥', 'warning');

                // 3. æ›´æ–° UI
                updateStatus();

            } catch (error) {
                log('âŒ è§¦å‘äº‹ä»¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥çŠ¶æ€
        function checkStatus() {
            const userId = localStorage.getItem('user_id');
            const userEmail = localStorage.getItem('user_email');
            const nativeLogin = localStorage.getItem('native_login');

            log('ğŸ“Š å½“å‰ localStorage çŠ¶æ€:', 'info');
            log(`  user_id: ${userId || '(null)'}`, 'info');
            log(`  user_email: ${userEmail || '(null)'}`, 'info');
            log(`  native_login: ${nativeLogin || '(null)'}`, 'info');

            updateStatus();
        }

        // æ›´æ–°é¡µé¢çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            const userId = localStorage.getItem('user_id');
            const userEmail = localStorage.getItem('user_email');
            const statusEl = document.getElementById('status');
            const userIdEl = document.getElementById('userId');
            const userEmailEl = document.getElementById('userEmail');

            if (userId) {
                statusEl.textContent = 'å·²ç™»å½•';
                statusEl.className = 'status logged-in';
            } else {
                statusEl.textContent = 'æœªç™»å½•';
                statusEl.className = 'status logged-out';
            }

            userIdEl.textContent = userId || 'null';
            userEmailEl.textContent = userEmail || 'null';
        }

        // ç›‘å¬ç™»å‡ºäº‹ä»¶ï¼ˆéªŒè¯äº‹ä»¶æ˜¯å¦æ­£ç¡®è§¦å‘ï¼‰
        window.addEventListener('mindboat:nativeLogout', function(event) {
            log('âœ… Web ç«¯æ”¶åˆ° mindboat:nativeLogout äº‹ä»¶', 'success');
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('DOMContentLoaded', function() {
            log('ğŸ‰ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('ğŸ’¡ ç‚¹å‡»"æ¨¡æ‹Ÿç™»å½•"å¼€å§‹æµ‹è¯•', 'info');
            updateStatus();
        });

        // ä¸ºåŸç”Ÿç«¯æä¾›çš„æµ‹è¯•æ¥å£
        window.testNativeLogout = triggerLogout;
    </script>
</body>
</html>
